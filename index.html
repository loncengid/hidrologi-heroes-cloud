<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hirdologi Heroes : Lacak si Tirta, Air Ajaib</title>
  <style>
    :root{
      --bg1:#f7fbff;
      --bg2:#eef6ff;
      --ink:#1b2b44;
      --muted:#526782;

      --card:#ffffff;
      --stroke:#dbe8ff;

      --primary:#2c5cff;
      --primary2:#00c2ff;
      --accent:#ffcc00;
      --good:#1db954;
      --bad:#ff4d6d;

      --shadow: 0 10px 30px rgba(31, 78, 190, .12);
      --r16:16px;
      --r22:22px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 600px at 10% 0%, #dff1ff 0%, transparent 60%),
                  radial-gradient(1000px 600px at 90% 10%, #ffe9b8 0%, transparent 55%),
                  linear-gradient(180deg,var(--bg1),var(--bg2));
      min-height:100vh;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:16px 14px 32px}

    /* Header */
    .hero{
      display:flex;gap:14px;align-items:center;justify-content:space-between;
      background: linear-gradient(135deg, #2c5cff, #00c2ff);
      border-radius: var(--r22);
      padding:14px 14px;
      color:#fff;
      box-shadow: var(--shadow);
      position:sticky;top:0;z-index:9;
      border:1px solid rgba(255,255,255,.22);
    }
    .hero-left{display:flex;gap:12px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: rgba(255,255,255,.18);
      display:grid;place-items:center;
      font-size:22px;
      border:1px solid rgba(255,255,255,.25);
    }
    .title{line-height:1.1}
    .title b{display:block;font-size:14px;letter-spacing:.2px}
    .title span{display:block;font-size:12px;opacity:.95}
    .status-pill{
      display:flex;gap:8px;align-items:center;
      background: rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.25);
      padding:8px 10px;border-radius:999px;
      font-weight:800;font-size:12px;
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:#ffd35c;box-shadow:0 0 0 4px rgba(255,211,92,.22)}
    .dot.ok{background:#a7ffb7;box-shadow:0 0 0 4px rgba(167,255,183,.18)}
    .dot.bad{background:#ff9fb2;box-shadow:0 0 0 4px rgba(255,159,178,.18)}

    /* Tabs */
    .tabs{
      margin-top:12px;
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .tab{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.75);
      backdrop-filter: blur(10px);
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(21,76,185,.10);
      transition: transform .08s ease, box-shadow .15s ease;
      user-select:none;
    }
    .tab:active{transform: translateY(1px)}
    .tab.active{
      background: linear-gradient(135deg, #ffffff, #f2f8ff);
      border-color: #bcd4ff;
      box-shadow: 0 10px 22px rgba(21,76,185,.14);
      outline: 3px solid rgba(44,92,255,.15);
    }

    /* Layout cards */
    .grid{display:grid;grid-template-columns: 1fr;gap:14px;margin-top:14px}
    @media (min-width: 880px){
      .grid.two{grid-template-columns: 1.1fr .9fr}
    }

    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--r22);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{margin:4px 0 8px;font-size:16px}
    .muted{color:var(--muted);font-size:13px}
    .badge{
      display:inline-flex;gap:6px;align-items:center;
      padding:6px 10px;border-radius:999px;
      background: #f2f8ff;
      border:1px solid #d7e7ff;
      font-weight:900;
      font-size:12px;
    }

    /* Buttons */
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      border:1px solid #cfe0ff;
      background: #f2f8ff;
      color:var(--ink);
      padding:12px 12px;
      border-radius: 16px;
      font-weight:1000;
      cursor:pointer;
      min-width: 140px;
      flex:1;
      box-shadow: 0 8px 16px rgba(21,76,185,.10);
      transition: transform .08s ease, box-shadow .15s ease;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(135deg, #2c5cff, #00c2ff);
      color:#fff;border-color: rgba(255,255,255,.35);
    }
    .btn.warn{
      background: linear-gradient(135deg, #ff4d6d, #ff9f3f);
      color:#fff;border-color: rgba(255,255,255,.35);
    }
    .btn.on{
      outline: 4px solid rgba(44,92,255,.20);
      border-color:#9bbcff;
      background: linear-gradient(135deg, #ffffff, #eaf2ff);
    }
    .btn.tog.on{
      background: linear-gradient(135deg, #a7ffb7, #7de8ff);
      border-color:#a7ffb7;
      outline: 4px solid rgba(29,185,84,.15);
    }

    /* Inputs */
    input, select, textarea{
      width:100%;
      border-radius: 14px;
      border:1px solid #d7e7ff;
      padding:12px;
      background:#fbfdff;
      font-size:14px;
      outline:none;
    }
    input:focus, select:focus, textarea:focus{
      border-color:#9bbcff;
      box-shadow: 0 0 0 4px rgba(44,92,255,.12);
    }
    textarea{min-height:88px;resize:vertical}

    /* Divider */
    .hr{height:1px;background: #edf3ff;margin:12px 0}

    /* Stats */
    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (min-width: 880px){
      .stats{grid-template-columns: 1fr 1fr 1fr 1fr}
    }
    .stat{
      padding:12px;
      border-radius: 18px;
      border:1px solid #e3efff;
      background: linear-gradient(180deg, #ffffff, #f7fbff);
    }
    .stat b{display:block;font-size:12px;color:var(--muted)}
    .stat span{display:block;font-size:18px;font-weight:1000;margin-top:3px}

    .hide{display:none}
    .tiny{font-size:12px;color:var(--muted)}
    .ok{color:var(--good);font-weight:900}
    .bad{color:var(--bad);font-weight:900}
  </style>
</head>

<body>
  <div class="wrap">

    <!-- HERO HEADER -->
    <div class="hero">
      <div class="hero-left">
        <div class="logo">üíß</div>
        <div class="title">
          <b>Hirdologi Heroes</b>
          <span>Lacak si Tirta, Air Ajaib ‚Ä¢ NISEEF v12 (Online)</span>
        </div>
      </div>
      <div class="status-pill" title="Status koneksi realtime ke ESP32 via RTDB">
        <span class="dot" id="dot"></span>
        <span id="netText">connecting‚Ä¶</span>
      </div>
    </div>

    <!-- TABS -->
    <div class="tabs">
      <div class="tab active" id="t-proyek">üìö Penjelasan Proyek</div>
      <div class="tab" id="t-siswa">üßí Siswa</div>
      <div class="tab" id="t-guru">üßë‚Äçüè´ Guru</div>
      <div class="tab" id="t-diorama">üéõÔ∏è Diorama</div>
    </div>

    <!-- PANELS -->
    <div class="grid">

      <!-- PROYEK -->
      <div class="card" id="p-proyek">
        <div class="badge">‚ú® Materi singkat</div>
        <h2>Penjelasan Proyek</h2>
        <div class="muted">
          Kita belajar siklus air + dampaknya + pemanfaatan energi air (PLTMH) dengan diorama yang bisa dikontrol online.
        </div>
        <div class="hr"></div>
        <div class="stats">
          <div class="stat"><b>‚òÄÔ∏è Evaporasi</b><span>Penguapan</span><div class="tiny">Air naik ke atas karena panas.</div></div>
          <div class="stat"><b>‚òÅÔ∏è Kondensasi</b><span>Awan</span><div class="tiny">Uap berubah jadi titik air.</div></div>
          <div class="stat"><b>üåßÔ∏è Presipitasi</b><span>Hujan</span><div class="tiny">Air turun dari awan.</div></div>
          <div class="stat"><b>‚ö° PLTMH</b><span>Listrik</span><div class="tiny">Aliran air jadi energi.</div></div>
        </div>
        <div class="hr"></div>
        <div class="muted">
          <b>Banjir</b> terjadi saat air berlebih dan tidak tertampung/terkelola. Diorama ini membantu kita melihat prosesnya dengan jelas.
        </div>
      </div>

      <!-- SISWA -->
      <div class="card hide" id="p-siswa">
        <div class="badge">üéØ Kuis & skor</div>
        <h2>Mode Siswa</h2>

        <div class="row">
          <div style="flex:1;min-width:220px">
            <div class="tiny">Nama</div>
            <input id="s-nama" placeholder="contoh: Aulia" />
          </div>
          <div style="flex:1;min-width:140px">
            <div class="tiny">Kelas</div>
            <input id="s-kelas" placeholder="contoh: 5A" />
          </div>
        </div>

        <div style="height:10px"></div>
        <button class="btn primary" id="btn-mulai">üöÄ Mulai Kuis</button>

        <div class="hr"></div>
        <div id="quiz-area" class="muted">Klik <b>Mulai Kuis</b> untuk mengerjakan soal.</div>
      </div>

      <!-- GURU -->
      <div class="card hide" id="p-guru">
        <div class="badge">üîê Panel Guru</div>
        <h2>Mode Guru</h2>

        <div id="guru-login">
          <div class="tiny">Masukkan PIN</div>
          <div class="row">
            <div style="flex:1">
              <input id="g-pin" placeholder="PIN" />
            </div>
            <div style="width:160px;flex:0">
              <button class="btn primary" id="btn-guru">Masuk</button>
            </div>
          </div>
          <div class="tiny" id="g-status" style="margin-top:8px"></div>
        </div>

        <div id="guru-panel" class="hide">
          <div class="row">
            <button class="btn" id="btn-score">üìä Lihat Score</button>
            <button class="btn" id="btn-edit">üìù Edit Soal</button>
            <button class="btn" id="btn-add">‚ûï Tambah Soal</button>
          </div>

          <div class="hr"></div>
          <div class="badge">üìå Score terakhir</div>
          <div id="score-area" class="muted" style="margin-top:8px">Belum dimuat.</div>

          <div class="hr"></div>
          <div class="badge">üß© Daftar soal</div>
          <div id="teacher-quiz-area" class="muted" style="margin-top:8px">Belum dimuat.</div>

          <div class="hr"></div>
          <div class="badge">‚ûï Tambah soal</div>
          <div style="margin-top:8px">
            <div class="tiny">Pertanyaan</div>
            <textarea id="add-q" placeholder="contoh: Apa yang disebut evaporasi?"></textarea>
            <div style="height:8px"></div>
            <div class="tiny">Jawaban (kata kunci)</div>
            <input id="add-a" placeholder="contoh: penguapan" />
            <div style="height:10px"></div>
            <button class="btn primary" id="btn-save-q">Simpan Soal</button>
            <div class="tiny" id="add-status" style="margin-top:8px"></div>
          </div>
        </div>
      </div>

      <!-- DIORAMA -->
      <div class="card hide" id="p-diorama">
        <div class="badge">üåê Kontrol Diorama (Realtime)</div>
        <h2>NISEEF v12</h2>

        <div class="muted">Tips: kalau mau bebas toggle manual, pilih mode <b>demo</b>.</div>
        <div style="height:10px"></div>

        <div class="row">
          <button id="A" class="btn tog">‚òÄÔ∏è Evaporasi (A)</button>
          <button id="B" class="btn tog">‚òÅÔ∏è Kondensasi (B)</button>
          <button id="C" class="btn tog">üåßÔ∏è Presipitasi (C)</button>
          <button id="D" class="btn tog">üåä Banjir (D)</button>
        </div>

        <div style="height:10px"></div>
        <div class="row">
          <button id="LD" class="btn tog">üí° Lampu Desa</button>
          <button id="P2" class="btn tog">üö∞ Pompa 2</button>
          <button id="OFF" class="btn warn">üõë ALL OFF</button>
        </div>

        <div class="hr"></div>

        <div class="grid two">
          <div class="card" style="box-shadow:none;border-radius:18px;border:1px solid #e3efff;background:#fbfdff">
            <div class="tiny">Mode Sistem</div>
            <select id="mode">
              <option value="demo">demo</option>
              <option value="edukasi">edukasi</option>
              <option value="otomatis" selected>otomatis</option>
              <option value="maintenance">maintenance</option>
            </select>

            <div style="height:10px"></div>
            <div class="tiny">State (khusus demo/edukasi)</div>
            <select id="state">
              <option value="idle">idle</option>
              <option value="evaporasi">evaporasi</option>
              <option value="kondensasi">kondensasi</option>
              <option value="presipitasi">presipitasi</option>
              <option value="aliran">aliran</option>
              <option value="banjir">banjir</option>
            </select>

            <div style="height:10px"></div>
            <div class="tiny" id="safeLine"></div>
          </div>

          <div class="card" style="box-shadow:none;border-radius:18px;border:1px solid #e3efff;background:#fbfdff">
            <div class="badge">üì° Monitoring</div>
            <div style="height:10px"></div>
            <div class="stats" id="kv"></div>
            <div style="height:10px"></div>
            <div class="tiny">Versi: <b id="verLine">-</b></div>
          </div>
        </div>
      </div>

    </div><!-- /grid -->
  </div><!-- /wrap -->

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getDatabase, ref, onValue, get, set, update } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

  // ===== Config Boss =====
  const firebaseConfig = {
    apiKey: "AIzaSyCbKNlViQO-BRj818y-sNd7LjvMkf6Q0Wg",
    authDomain: "hidrologi-heroes.firebaseapp.com",
    databaseURL: "https://hidrologi-heroes-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "hidrologi-heroes",
    storageBucket: "hidrologi-heroes.firebasestorage.app",
    messagingSenderId: "349578733020",
    appId: "1:349578733020:web:df27bed634e6bdefd5db19",
    measurementId: "G-HMVQ476SYS"
  };

  // ===== Settings =====
  const DEVICE_ID = "niseef_v12_01";
  const TEACHER_PIN = "1234"; // client-side pin (demo)

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const PATH_TELEM = `devices/${DEVICE_ID}/telemetry`;
  const PATH_CMD   = `devices/${DEVICE_ID}/cmd`;
  const PATH_Q     = `quiz/questions`;
  const PATH_LAST  = `quiz/lastScore`;

  const $ = (id)=>document.getElementById(id);

  function escapeHtml(s){
    return (s||"").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }

  // ===== Tabs =====
  function showTab(active){
    ["proyek","siswa","guru","diorama"].forEach(k=>{
      $("t-"+k).classList.toggle("active", k===active);
      $("p-"+k).classList.toggle("hide", k!==active);
    });
  }
  $("t-proyek").onclick = ()=>showTab("proyek");
  $("t-siswa").onclick  = ()=>showTab("siswa");
  $("t-guru").onclick   = ()=>showTab("guru");
  $("t-diorama").onclick= ()=>showTab("diorama");

  // ===== Diorama telemetry =====
  function setTog(id,on){
    const b=$(id); if(!b) return;
    b.classList.toggle("on", !!on);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    // warna ON khusus untuk tombol toggle
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    // ON = hijau biru (kids friendly)
    if (b.classList.contains("on")) b.classList.add("tog","on");
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    // final: toggle style
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    // apply special class for ON look
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    b.classList.toggle("tog", true);

    // simplified: use .tog.on
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    // final toggle marker
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    // ensure ON class updates
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    // Clean: keep only .on and .tog
    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);

    b.classList.toggle("tog", true);
    b.classList.toggle("tog", true);
  }

  function setNet(ok, text){
    $("netText").textContent = text;
    const dot = $("dot");
    dot.classList.remove("ok","bad");
    dot.classList.add(ok ? "ok":"bad");
  }

  onValue(ref(db, PATH_TELEM), (snap)=>{
    const t = snap.val();
    if(!t){
      setNet(false, "telemetry belum ada");
      return;
    }
    setNet(true, "online ‚úÖ");

    // Toggles
    $("A").classList.toggle("on", !!t.outA);
    $("B").classList.toggle("on", !!t.outB);
    $("C").classList.toggle("on", !!t.outC);
    $("D").classList.toggle("on", !!t.outD);
    $("LD").classList.toggle("on", !!t.lampuDesa);
    $("P2").classList.toggle("on", !!t.pompa2);

    // On-state color for toggle buttons
    ["A","B","C","D","LD","P2"].forEach(id=>{
      const b=$(id); b.classList.toggle("tog", true);
      b.classList.toggle("tog", true);
      b.classList.toggle("tog", true);
      b.classList.toggle("tog", true);
      b.classList.toggle("tog", true);
      b.classList.toggle("tog", true);
      b.classList.toggle("tog", true);
      b.classList.toggle("tog", true);
      b.classList.toggle("tog", true);
      b.classList.toggle("tog", true);
      b.classList.toggle("tog", true);
      b.classList.toggle("tog", true);
      b.classList.toggle("tog", true);
      b.classList.toggle("tog", true);
      b.classList.toggle("tog", true);
      b.classList.toggle("tog", true);
      // actual style: .btn.tog.on already defined
    });

    if(t.mode) $("mode").value = t.mode;
    if(t.state) $("state").value = t.state;

    const safeTxt = t.safeMode ? `üõ°Ô∏è SafeMode: <span class="bad">ON</span> ${t.fault? " ‚Ä¢ "+escapeHtml(t.fault):""}` :
                                 `üõ°Ô∏è SafeMode: <span class="ok">OFF</span>`;
    $("safeLine").innerHTML = safeTxt;

    $("verLine").textContent = (t.version || "-");

    // stats cards
    const flowAvg = (+t.flowAvg||0).toFixed(2);
    const flowInst= (+t.flowInst||0).toFixed(2);
    const lvl     = (+t.level||0).toFixed(1);
    const cm      = (+t.ultraCm||0).toFixed(1);

    $("kv").innerHTML = `
      <div class="stat"><b>üåä Flow Avg</b><span>${flowAvg}</span><div class="tiny">L/min</div></div>
      <div class="stat"><b>üí® Flow Inst</b><span>${flowInst}</span><div class="tiny">L/min</div></div>
      <div class="stat"><b>üìè Ultrasonic</b><span>${cm}</span><div class="tiny">cm</div></div>
      <div class="stat"><b>üß∫ Level</b><span>${lvl}</span><div class="tiny">%</div></div>
    `;
  }, (e)=>{
    setNet(false, "offline ‚ùå");
  });

  // Command sender (seq++)
  let seq = 0;
  async function sendCmd(patch){
    seq++;
    await update(ref(db, PATH_CMD), { ...patch, seq });
  }

  $("A").onclick  = ()=>sendCmd({k:"A"});
  $("B").onclick  = ()=>sendCmd({k:"B"});
  $("C").onclick  = ()=>sendCmd({k:"C"});
  $("D").onclick  = ()=>sendCmd({k:"D"});
  $("LD").onclick = ()=>sendCmd({k:"LD"});
  $("P2").onclick = ()=>sendCmd({k:"P2"});
  $("OFF").onclick= ()=>sendCmd({k:"ALLOFF"});

  $("mode").onchange  = (e)=>sendCmd({mode:e.target.value});
  $("state").onchange = (e)=>sendCmd({state:e.target.value});

  // ===== Quiz (UI scoring) =====
  async function loadQuestions(){
    const snap = await get(ref(db, PATH_Q));
    const items = snap.val();
    if(!items) return [];
    if(Array.isArray(items)) return items.filter(Boolean);
    return Object.values(items).filter(Boolean);
  }
  function norm(s){
    return (s||"").toString().toLowerCase().trim().replace(/\s+/g," ");
  }

  $("btn-mulai").onclick = async ()=>{
    const nama = ($("s-nama").value||"").trim();
    const kelas= ($("s-kelas").value||"").trim();
    if(!nama || !kelas){
      $("quiz-area").innerHTML = `‚ö†Ô∏è Isi <b>Nama</b> dan <b>Kelas</b> dulu ya üòä`;
      return;
    }

    const qs = await loadQuestions();
    if(!qs.length){
      $("quiz-area").innerHTML = "Soal masih kosong. Tunggu guru input ya.";
      return;
    }

    let html = `
      <div class="badge">üßæ Data Siswa</div>
      <div style="margin-top:8px" class="muted">
        Nama: <b>${escapeHtml(nama)}</b> ‚Ä¢ Kelas: <b>${escapeHtml(kelas)}</b>
      </div>
      <div class="hr"></div>
      <div class="badge">üß† Pertanyaan</div>
      <div style="height:8px"></div>
    `;

    qs.forEach((it,idx)=>{
      html += `
        <div class="card" style="box-shadow:none;border-radius:18px;border:1px solid #e3efff;background:#fbfdff;margin-top:10px">
          <div class="tiny"><b>${idx+1}.</b> ${escapeHtml(it.q||"")}</div>
          <div style="height:8px"></div>
          <input id="ans-${idx}" placeholder="Jawaban kamu..." />
        </div>
      `;
    });

    html += `
      <div style="height:10px"></div>
      <button class="btn primary" id="btn-submit">‚úÖ Kirim Jawaban</button>
      <div class="tiny" id="quiz-status" style="margin-top:8px"></div>
    `;

    $("quiz-area").innerHTML = html;

    $("btn-submit").onclick = async ()=>{
      const answers = qs.map((_,i)=> (document.getElementById(`ans-${i}`).value||""));
      let score = 0;
      qs.forEach((it,i)=>{
        const key = norm(it.a||"");
        const user= norm(answers[i]);
        if(key && user.includes(key)) score++;
      });
      const total = qs.length;

      await set(ref(db, PATH_LAST), { name:nama, kelas:kelas, score, total, ts: Date.now() });

      const msg = (score === total)
        ? `üéâ Keren! Score kamu: <b class="ok">${score}/${total}</b>`
        : `‚ú® Score kamu: <b>${score}/${total}</b> ‚Ä¢ Coba lagi biar full ya!`;
      $("quiz-status").innerHTML = msg;
    };
  };

  // ===== Guru =====
  let guruOk = false;

  $("btn-guru").onclick = ()=>{
    const pin = ($("g-pin").value||"").trim();
    if(pin !== TEACHER_PIN){
      $("g-status").innerHTML = `<span class="bad">PIN salah.</span>`;
      return;
    }
    guruOk = true;
    $("g-status").innerHTML = `<span class="ok">OK. Panel Guru aktif ‚úÖ</span>`;
    $("guru-login").classList.add("hide");
    $("guru-panel").classList.remove("hide");
  };

  $("btn-score").onclick = async ()=>{
    const snap = await get(ref(db, PATH_LAST));
    const j = snap.val();
    if(!j){
      $("score-area").innerHTML = "Belum ada siswa submit kuis.";
      return;
    }
    $("score-area").innerHTML =
      `Nama: <b>${escapeHtml(j.name||"")}</b><br>
       Kelas: <b>${escapeHtml(j.kelas||"")}</b><br>
       Score: <b>${j.score||0}/${j.total||0}</b>`;
  };

  async function renderTeacherQuestions(){
    const qs = await loadQuestions();
    if(!qs.length){ $("teacher-quiz-area").innerHTML = "Soal kosong."; return; }

    let html = "";
    qs.forEach((it,idx)=>{
      html += `
        <div class="card" style="box-shadow:none;border-radius:18px;border:1px solid #e3efff;background:#fbfdff;margin-top:10px">
          <div class="badge">Soal #${idx+1}</div>
          <div style="height:8px"></div>
          <div class="tiny">Pertanyaan</div>
          <textarea id="q-${idx}">${escapeHtml(it.q||"")}</textarea>
          <div style="height:8px"></div>
          <div class="tiny">Jawaban (kata kunci)</div>
          <input id="a-${idx}" value="${escapeHtml(it.a||"")}" />
          <div style="height:10px"></div>
          <button class="btn primary" id="save-${idx}">Simpan Perubahan</button>
        </div>
      `;
    });
    $("teacher-quiz-area").innerHTML = html;

    qs.forEach((_,idx)=>{
      document.getElementById(`save-${idx}`).onclick = async ()=>{
        const q = (document.getElementById(`q-${idx}`).value||"").trim();
        const a = (document.getElementById(`a-${idx}`).value||"").trim();

        const snap = await get(ref(db, PATH_Q));
        let raw = snap.val();
        let arr = [];
        if(Array.isArray(raw)) arr = raw.filter(Boolean);
        else if(raw) arr = Object.values(raw).filter(Boolean);

        arr[idx] = { q, a };
        await set(ref(db, PATH_Q), arr);

        $("teacher-quiz-area").insertAdjacentHTML(
          "afterbegin",
          `<div class="badge">‚úÖ Soal #${idx+1} tersimpan</div><div style="height:8px"></div>`
        );
      };
    });
  }

  $("btn-edit").onclick = async ()=>{
    if(!guruOk) return;
    await renderTeacherQuestions();
  };

  $("btn-add").onclick = ()=> $("add-q").focus();

  $("btn-save-q").onclick = async ()=>{
    if(!guruOk) return;
    const q = ($("add-q").value||"").trim();
    const a = ($("add-a").value||"").trim();
    if(!q || !a){ $("add-status").innerHTML = `<span class="bad">Pertanyaan & jawaban wajib diisi.</span>`; return; }

    const qs = await loadQuestions();
    qs.push({q,a});
    await set(ref(db, PATH_Q), qs);

    $("add-q").value=""; $("add-a").value="";
    $("add-status").innerHTML = `<span class="ok">Soal ditambahkan ‚úÖ</span>`;
    await renderTeacherQuestions();
  };

  // Init seed data
  (async ()=>{
    const s = await get(ref(db, PATH_CMD));
    if(!s.exists()){
      await set(ref(db, PATH_CMD), { seq:0, mode:"otomatis", state:"idle", k:"" });
    }
    const q = await get(ref(db, PATH_Q));
    if(!q.exists()){
      await set(ref(db, PATH_Q), [
        { q:"Apa yang disebut evaporasi?", a:"penguapan" },
        { q:"Apa yang disebut kondensasi?", a:"pengembunan" },
        { q:"Apa yang disebut presipitasi?", a:"hujan" },
        { q:"Apa manfaat PLTMH/mikrohidro?", a:"listrik" }
      ]);
    }
  })();
</script>

</body>
</html>
