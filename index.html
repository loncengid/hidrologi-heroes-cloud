<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hidrologi Heroes â€“ Lacak si Tirta</title>

<style>
body{margin:0;font-family:Arial,system-ui;background:#eaf3ff;color:#123}
header{background:#4da3ff;color:#fff;padding:16px;text-align:center}
h1{margin:0;font-size:22px}
main{padding:16px;padding-bottom:92px}
.card{background:#fff;border-radius:18px;padding:18px;margin-bottom:16px;box-shadow:0 6px 14px rgba(0,0,0,.1)}
button{width:100%;padding:14px;margin-top:10px;border:none;border-radius:14px;font-size:18px;font-weight:bold;background:#4da3ff;color:#fff;cursor:pointer}
button.secondary{background:#8bc34a}
button.warn{background:#ff9800}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.badge{display:inline-block;padding:6px 12px;background:#e0f2ff;border-radius:999px;font-size:14px;margin-bottom:12px}
.small{font-size:13px;opacity:.85}
input{width:100%;padding:12px;margin-top:6px;margin-bottom:10px;border-radius:12px;border:1px solid #ccc;font-size:16px}
.kv{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.kv div{background:#f4fbff;border:1px solid #cfeaff;border-radius:14px;padding:12px}
.footer{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:10px;display:flex;gap:10px;box-shadow:0 -4px 10px rgba(0,0,0,.1)}
.footer button{font-size:14px;padding:10px}
.toast{
  position:fixed;left:50%;transform:translateX(-50%);
  bottom:88px;background:#111;color:#fff;
  padding:10px 14px;border-radius:999px;
  font-size:13px;opacity:0;pointer-events:none;
  transition:opacity .2s;
}
.toast.on{opacity:.9}
</style>
</head>

<body>
<header>
  <h1>Hidrologi Heroes</h1>
  <div>Lacak si Tirta, Air Ajaib ğŸ’§</div>
</header>

<main id="app"></main>
<div class="footer">
  <button id="btnHome">ğŸ  Home</button>
</div>
<div id="toast" class="toast">OK</div>

<script>
/* ================== KONFIG RTDB (REST) ================== */
const DB_BASE  = "https://hidrologi-heroes-default-rtdb.asia-southeast1.firebasedatabase.app";
const DEVICE_ID = "niseef_v12_01";

const PATH_CMD   = `/devices/${DEVICE_ID}/cmd`;
const PATH_TELEM = `/devices/${DEVICE_ID}/telemetry`;
const PATH_PRES  = `/devices/${DEVICE_ID}/presence/lastActiveMs`;

/* =============== HELPERS REST =============== */
async function rtdbGet(path){
  const res = await fetch(`${DB_BASE}${path}.json`, { cache:"no-store" });
  return await res.json();
}
async function rtdbPut(path, obj){
  await fetch(`${DB_BASE}${path}.json`, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(obj)
  });
}
async function rtdbPatch(path, obj){
  await fetch(`${DB_BASE}${path}.json`, {
    method:"PATCH",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(obj)
  });
}

/* ================== TOAST ================== */
let toastT=null;
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("on");
  clearTimeout(toastT);
  toastT=setTimeout(()=>t.classList.remove("on"),700);
}

/* ================== ONLINE COUNTER ================== */
const cid = "c_" + Math.random().toString(36).slice(2);
let onlineCount = 0;

async function heartbeatOnline(){
  await rtdbPatch(`/online/${cid}`, { ts: Date.now() });
}
heartbeatOnline();
setInterval(heartbeatOnline, 5000);

async function pollOnline(){
  try{
    const o = await rtdbGet("/online");
    const now = Date.now();
    let n=0;
    if(o){
      for(const k in o){
        if(now - (o[k]?.ts||0) < 15000) n++;
      }
    }
    onlineCount = n;
    if(page==="home") updateHomeOnline();
  }catch(e){}
}
pollOnline();
setInterval(pollOnline, 3000);

/* ================== PRESENCE KE DEVICE ================== */
async function heartbeatPresence(){
  try{ await rtdbPut(PATH_PRES, Date.now()); }catch(e){}
}
heartbeatPresence();
setInterval(heartbeatPresence, 5000);

/* ================== SESSION SISWA ================== */
function getSession(){ return JSON.parse(localStorage.getItem("hh_student") || "null"); }
function saveSession(s){ localStorage.setItem("hh_student", JSON.stringify(s)); }

/* ================== QUIZ ================== */
const quiz = [
 {q:"Evaporasi adalah...",o:["Hujan","Penguapan","Awan"],a:1},
 {q:"Hujan disebut...",o:["Evaporasi","Presipitasi","Kondensasi"],a:1},
 {q:"Awan terbentuk karena...",o:["Kondensasi","Hujan","Aliran"],a:0},
 {q:"PLTMH adalah...",o:["Tenaga uap","Tenaga air","Tenaga angin"],a:1},
 {q:"Air mengalir ke sungai disebut...",o:["Aliran","Uap","Awan"],a:0},
 {q:"Banjir terjadi karena...",o:["Air berlebih","Air habis","Angin"],a:0},
 {q:"Siklus air dimulai dari...",o:["Penguapan","Hujan","Awan"],a:0},
 {q:"Energi air digunakan untuk...",o:["Mainan","Listrik","Makanan"],a:1},
 {q:"Uap air naik karena...",o:["Panas","Hujan","Es"],a:0},
 {q:"Air penting bagi...",o:["Manusia","Hewan","Semua"],a:2},
];
const materi = [
 "Evaporasi: air menguap karena panas matahari.",
 "Kondensasi: uap air berubah menjadi awan.",
 "Presipitasi: hujan turun ke bumi."
];

/* ================== UI STATE ================== */
let page="home";
let belajarStep=0;
let quizIndex=0;
let score=0;

/* ================== DEVICE STATE ================== */
let telem = null;
let seq = 0;

async function sendCmd(patch){
  seq++;
  try{
    await rtdbPatch(PATH_CMD, { seq, ts: Date.now(), ...patch });
    toast("âœ… Terkirim");
  }catch(e){
    toast("âš ï¸ Gagal");
  }
}

/* ================== POLL TELEMETRY (TANPA RE-RENDER DIORAMA) ================== */
async function pollTelem(){
  try{
    telem = await rtdbGet(PATH_TELEM);
    if(page==="diorama") updateDioramaUI();
    if(page==="home") updateHomeVersion();
    if(page==="guru") updateGuruUI();
  }catch(e){}
}
pollTelem();
setInterval(pollTelem, 1000);

/* ================== RENDER PAGES ================== */
function render(){
  const app = document.getElementById("app");
  app.innerHTML = "";

  if(page==="home"){
    app.innerHTML = `
      <div class="card">
        <div class="badge">ğŸ‘¥ Online: <span id="on">${onlineCount}</span></div>
        <div class="small">Versi perangkat: <b id="ver">-</b></div>
        <button id="mBelajar">ğŸ’ BELAJAR</button>
        <button id="mKuis">ğŸ“ KUIS</button>
        <button id="mDiorama">ğŸ¥ DIORAMA</button>
        <button id="mGuru">ğŸ‘©â€ğŸ« GURU</button>
      </div>
    `;
    document.getElementById("mBelajar").onclick=()=>{ belajarStep=0; page="belajar"; render(); };
    document.getElementById("mKuis").onclick=()=>{ page="data"; render(); };
    document.getElementById("mDiorama").onclick=()=>{ page="diorama"; render(); };
    document.getElementById("mGuru").onclick=()=>{ page="guru"; render(); };
    updateHomeVersion();
  }

  if(page==="belajar"){
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ“˜ Belajar Siklus Air</h3>
        <p>${materi[belajarStep] || "Selesai ğŸ‰"}</p>
        <button id="nextBelajar">LANJUT â¡</button>
      </div>
    `;
    document.getElementById("nextBelajar").onclick=()=>{
      belajarStep++;
      if(belajarStep>=materi.length) page="home";
      render();
    };
  }

  if(page==="data"){
    const s=getSession()||{};
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ§’ Data Siswa</h3>
        <input id="nm" placeholder="Nama" value="${s.name||""}">
        <input id="kl" placeholder="Kelas" value="${s.kelas||""}">
        <button id="btnStartQuiz">Mulai Kuis</button>
      </div>
    `;
    document.getElementById("btnStartQuiz").onclick=()=>{
      const name = document.getElementById("nm").value.trim();
      const kelas = document.getElementById("kl").value.trim();
      if(!name || !kelas){ alert("Isi nama dan kelas dulu ya ğŸ™‚"); return; }
      saveSession({name, kelas, score:null});
      quizIndex=0; score=0; page="quiz"; render();
    };
  }

  if(page==="quiz"){
    const q=quiz[quizIndex];
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML = `<h3>${quizIndex+1}. ${q.q}</h3>`;
    q.o.forEach((opt,i)=>{
      const b=document.createElement("button");
      b.className="secondary";
      b.textContent=opt;
      b.onclick=()=>{
        if(i===q.a) score++;
        quizIndex++;
        if(quizIndex>=quiz.length){
          const s=getSession()||{};
          s.score = {score, total: quiz.length};
          saveSession(s);
          page="hasil";
        }
        render();
      };
      c.appendChild(b);
    });
    app.appendChild(c);
  }

  if(page==="hasil"){
    const s=getSession();
    const sc = s?.score ? `${s.score.score}/${s.score.total}` : "-";
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ‰ Hasil Kuis</h3>
        <div class="small">${s?.name||"-"} (${s?.kelas||"-"})</div>
        <h2 style="margin:10px 0">${sc}</h2>
        <button id="done">Selesai</button>
      </div>
    `;
    document.getElementById("done").onclick=()=>{ page="home"; render(); };
  }

  if(page==="diorama"){
    // render sekali -> tombol dipasang sekali
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ¥ Diorama (Online)</h3>

        <div class="kv">
          <div><b>Ultrasonic</b><br><span class="small" id="uPct">- %</span></div>
          <div><b>Flow</b><br><span class="small" id="fLpm">- L/menit</span></div>
          <div><b>Output</b><br><span class="small" id="outS">A:- B:- C:- D:-</span></div>
          <div><b>Tambahan</b><br><span class="small" id="addS">LD:- P2:-</span></div>
        </div>

        <div class="row">
          <button id="bA">Evaporasi (A)</button>
          <button id="bB">Kondensasi (B)</button>
          <button id="bC">Presipitasi (C)</button>
          <button id="bD">Banjir (D)</button>
        </div>

        <div class="row">
          <button id="bOff" class="warn">MATIKAN SEMUA</button>
          <button id="bMode" class="secondary">Ganti Mode</button>
        </div>

        <div class="small" style="margin-top:10px">
          Tombol ini mengirim command ke Firebase. ESP32 akan log ke Serial Monitor.
        </div>
      </div>
    `;

    // pasang event SEKALI
    document.getElementById("bA").onclick=()=>sendCmd({k:"A"});
    document.getElementById("bB").onclick=()=>sendCmd({k:"B"});
    document.getElementById("bC").onclick=()=>sendCmd({k:"C"});
    document.getElementById("bD").onclick=()=>sendCmd({k:"D"});
    document.getElementById("bOff").onclick=()=>sendCmd({k:"ALLOFF"});
    document.getElementById("bMode").onclick=()=>{
      const next = (telem?.mode==="manual") ? "auto" : "manual";
      sendCmd({mode: next});
    };

    // update angka/status sekarang juga
    updateDioramaUI();
  }

  if(page==="guru"){
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ‘©â€ğŸ« Monitoring Guru</h3>
        <div class="small">IP pengunjung dimatikan.</div>
        <div class="kv" style="margin-top:10px">
          <div><b>Online</b><br><span class="small" id="gOn">${onlineCount} orang</span></div>
          <div><b>Skor terakhir</b><br><span class="small" id="gSc">-</span></div>
          <div><b>Versi</b><br><span class="small" id="gVer">-</span></div>
          <div><b>Status</b><br><span class="small" id="gSt">-</span></div>
        </div>
      </div>
    `;
    updateGuruUI();
  }
}

/* ================== UPDATE PARTIAL UI ================== */
function updateHomeOnline(){
  const el=document.getElementById("on");
  if(el) el.textContent = onlineCount;
}
function updateHomeVersion(){
  const el=document.getElementById("ver");
  if(el) el.textContent = telem?.version || "-";
}
function updateDioramaUI(){
  // kalau elemen belum ada, skip
  const u=document.getElementById("uPct");
  if(!u) return;

  const percent = (telem?.ultra_percent ?? "-");
  const flow = (telem?.flow_lpm ?? "-");
  const A = !!telem?.outA, B = !!telem?.outB, C = !!telem?.outC, D = !!telem?.outD;
  const LD = !!telem?.lampuDesa, P2 = !!telem?.pompa2;

  document.getElementById("uPct").textContent = `${percent}%`;
  document.getElementById("fLpm").textContent = `${flow} L/menit`;
  document.getElementById("outS").textContent = `A:${A?"ON":"OFF"} B:${B?"ON":"OFF"} C:${C?"ON":"OFF"} D:${D?"ON":"OFF"}`;
  document.getElementById("addS").textContent = `LD:${LD?"ON":"OFF"} P2:${P2?"ON":"OFF"}`;
}
function updateGuruUI(){
  const s=getSession();
  const sc = s?.score ? `${s.score.score}/${s.score.total}` : "-";
  const elOn=document.getElementById("gOn");
  if(elOn) elOn.textContent = `${onlineCount} orang`;
  const elSc=document.getElementById("gSc");
  if(elSc) elSc.textContent = sc;
  const elVer=document.getElementById("gVer");
  if(elVer) elVer.textContent = telem?.version || "NISEEF v12";
  const elSt=document.getElementById("gSt");
  if(elSt) elSt.textContent = telem?.status || "-";
}

/* ================== HOME BUTTON ================== */
document.getElementById("btnHome").onclick=()=>{ page="home"; render(); };

/* ================== INIT ================== */
render();
</script>

</body>
</html>
