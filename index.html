<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hidrologi Heroes ‚Äì Lacak si Tirta, Air Ajaib</title>

<style>
  :root{
    --bg1:#eaf3ff;
    --bg2:#fff1f7;
    --card:#ffffff;
    --ink:#0d2b45;
    --muted:#4b647a;
    --shadow:0 10px 22px rgba(0,0,0,.10);
    --r:20px;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Arial;
    color:var(--ink);
    background:
      radial-gradient(900px 500px at 15% 0%, #cfe7ff 0%, transparent 60%),
      radial-gradient(900px 500px at 85% 0%, #ffd4e6 0%, transparent 60%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
    min-height:100vh;
  }

  header{
    position:sticky; top:0; z-index:10;
    background: linear-gradient(90deg, #4da3ff, #ff6fb1);
    color:#fff;
    padding:14px 16px;
    box-shadow:0 6px 14px rgba(0,0,0,.12);
  }

  .head{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    max-width:980px; margin:0 auto;
  }

  .brand{
    display:flex; align-items:center; gap:10px;
  }
  .logo{
    width:42px; height:42px; border-radius:14px;
    background: rgba(255,255,255,.20);
    display:grid; place-items:center;
    border:1px solid rgba(255,255,255,.35);
  }
  .logo span{font-size:22px}
  .title h1{margin:0;font-size:18px;line-height:1.1}
  .title div{font-size:12px;opacity:.95}

  main{
    max-width:980px;
    margin:0 auto;
    padding:16px;
    padding-bottom:96px;
  }

  .grid{
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap:12px;
  }

  .card{
    background:var(--card);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    padding:16px;
    border:1px solid rgba(13,43,69,.08);
  }

  .hero{
    grid-column: span 12;
    padding:16px;
    background:
      radial-gradient(700px 220px at 20% 0%, rgba(255,255,255,.55) 0%, transparent 70%),
      linear-gradient(135deg, rgba(255,255,255,.35), rgba(255,255,255,.12));
    border:1px solid rgba(255,255,255,.35);
  }

  .heroRow{
    display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
  }

  .badges{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
  }
  .badge{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px;
    border-radius:999px;
    font-weight:800;
    font-size:13px;
    border:1px solid rgba(255,255,255,.40);
    background: rgba(255,255,255,.28);
    color:#08304f;
  }
  .badge small{font-weight:700; opacity:.9}

  .ctaRow{
    display:grid;
    grid-template-columns: repeat(2, 1fr);
    gap:10px;
    margin-top:12px;
  }
  @media (max-width:700px){
    .ctaRow{grid-template-columns: 1fr;}
  }

  .btn{
    border:none;
    cursor:pointer;
    border-radius:18px;
    padding:14px 14px;
    font-size:16px;
    font-weight:900;
    color:#fff;
    box-shadow:0 10px 18px rgba(0,0,0,.12);
    transition: transform .08s ease, filter .08s ease;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .btn:active{transform: scale(.98)}
  .btn span{display:inline-flex; align-items:center; gap:10px}
  .btn i{font-style:normal; font-size:18px}

  .b-blue{ background: linear-gradient(135deg, #2a7fff, #53d5ff); }
  .b-pink{ background: linear-gradient(135deg, #ff4fa3, #ff9ed0); }
  .b-green{background: linear-gradient(135deg, #20c997, #87f5d0); }
  .b-orange{background: linear-gradient(135deg, #ff9800, #ffd36a); }
  .b-purple{background: linear-gradient(135deg, #7c4dff, #caa8ff); }
  .b-red{background: linear-gradient(135deg, #ff3d3d, #ff8f8f); }

  .mini{
    font-size:12px;
    color:var(--muted);
    margin-top:6px;
  }

  .navBar{
    display:flex; gap:10px; flex-wrap:wrap;
    align-items:center; justify-content:space-between;
    margin:10px 0 0;
  }

  .pill{
    border:none;
    padding:10px 12px;
    border-radius:999px;
    font-weight:900;
    cursor:pointer;
    background:#ffffff;
    border:1px solid rgba(13,43,69,.12);
    color:var(--ink);
    box-shadow:0 6px 12px rgba(0,0,0,.06);
  }
  .pill:active{transform:scale(.99)}
  .pill.primary{
    background: linear-gradient(135deg, #2a7fff, #53d5ff);
    color:#fff; border:none;
  }

  .h2{
    margin:0 0 8px;
    font-size:18px;
  }

  .subgrid{
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap:12px;
  }

  .topic{
    grid-column: span 6;
    padding:14px;
    border-radius:18px;
    box-shadow:var(--shadow);
    border:1px solid rgba(13,43,69,.08);
    background:#fff;
  }
  @media (max-width:820px){
    .topic{grid-column:span 12;}
  }

  .topicHead{
    display:flex; gap:12px; align-items:center;
  }
  .pic{
    width:66px; height:66px; border-radius:18px;
    display:grid; place-items:center;
    border:1px solid rgba(13,43,69,.10);
    overflow:hidden;
  }
  .topic h3{margin:0;font-size:16px}
  .topic p{margin:8px 0 0;color:var(--muted);line-height:1.45;font-size:13px}

  .quizTop{
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  }
  .progress{
    display:flex; align-items:center; gap:10px; font-weight:900;
  }
  .bar{
    width:160px; height:10px; border-radius:999px; overflow:hidden;
    background: rgba(13,43,69,.10);
  }
  .bar > div{
    height:100%; width:0%;
    background: linear-gradient(90deg, #20c997, #53d5ff);
  }

  .qCard{
    display:grid;
    grid-template-columns: 130px 1fr;
    gap:12px;
    align-items:stretch;
  }
  @media (max-width:720px){
    .qCard{grid-template-columns: 1fr;}
  }
  .qImg{
    border-radius:18px;
    overflow:hidden;
    border:1px solid rgba(13,43,69,.10);
    background:#fff;
    box-shadow:0 10px 18px rgba(0,0,0,.10);
    min-height:110px;
  }
  .qText h3{margin:0 0 10px;font-size:16px}
  .choices{
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
  }
  .choiceBtn{
    width:100%;
    text-align:left;
    padding:12px 14px;
    border-radius:16px;
    border:1px solid rgba(13,43,69,.12);
    background:#fff;
    cursor:pointer;
    font-weight:900;
    box-shadow:0 8px 14px rgba(0,0,0,.06);
  }
  .choiceBtn:active{transform:scale(.99)}
  .choiceBtn small{font-weight:800; opacity:.85}
  .choiceBtn.good{border-color:rgba(32,201,151,.55); background:rgba(32,201,151,.10)}
  .choiceBtn.bad{border-color:rgba(255,61,61,.55); background:rgba(255,61,61,.08)}

  /* footer */
  .footer{
    position:fixed; left:0; right:0; bottom:0;
    background: rgba(255,255,255,.88);
    backdrop-filter: blur(10px);
    border-top:1px solid rgba(13,43,69,.08);
    padding:10px 12px;
    display:flex; gap:10px; justify-content:center;
  }

  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:88px; background:#111; color:#fff;
    padding:10px 14px; border-radius:999px;
    font-size:13px; opacity:0; pointer-events:none;
    transition:opacity .2s;
  }
  .toast.on{opacity:.9}
</style>
</head>

<body>
<header>
  <div class="head">
    <div class="brand">
      <div class="logo"><span>üíß</span></div>
      <div class="title">
        <h1>Hidrologi Heroes</h1>
        <div>Lacak si Tirta, Air Ajaib</div>
      </div>
    </div>
    <div class="badges">
      <div class="badge">üë• <small>Online:</small> <span id="hdrOnline">0</span></div>
      <div class="badge">üß† <small>Versi:</small> <span id="hdrVer">-</span></div>
    </div>
  </div>
</header>

<main id="app"></main>

<div class="footer">
  <button class="pill" id="btnBack">‚¨Ö Back</button>
  <button class="pill primary" id="btnHome">üè† Home</button>
  <button class="pill" id="btnNext">Next ‚û°</button>
</div>

<div id="toast" class="toast">OK</div>

<script>
/* ================== KONFIG RTDB (REST) ================== */
const DB_BASE  = "https://hidrologi-heroes-default-rtdb.asia-southeast1.firebasedatabase.app";
const DEVICE_ID = "niseef_v12_01";
const PATH_CMD   = `/devices/${DEVICE_ID}/cmd`;
const PATH_TELEM = `/devices/${DEVICE_ID}/telemetry`;
const PATH_PRES  = `/devices/${DEVICE_ID}/presence/lastActiveMs`;

/* =============== HELPERS REST =============== */
async function rtdbGet(path){
  const res = await fetch(`${DB_BASE}${path}.json`, { cache:"no-store" });
  return await res.json();
}
async function rtdbPut(path, obj){
  await fetch(`${DB_BASE}${path}.json`, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(obj)
  });
}
async function rtdbPatch(path, obj){
  await fetch(`${DB_BASE}${path}.json`, {
    method:"PATCH",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(obj)
  });
}

/* ================== TOAST ================== */
let toastT=null;
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("on");
  clearTimeout(toastT);
  toastT=setTimeout(()=>t.classList.remove("on"),800);
}

/* ================== ONLINE COUNTER ================== */
const cid = "c_" + Math.random().toString(36).slice(2);
let onlineCount = 0;
async function heartbeatOnline(){
  try{ await rtdbPatch(`/online/${cid}`, { ts: Date.now() }); }catch(e){}
}
heartbeatOnline();
setInterval(heartbeatOnline, 5000);

async function pollOnline(){
  try{
    const o = await rtdbGet("/online");
    const now = Date.now();
    let n=0;
    if(o){
      for(const k in o){
        if(now - (o[k]?.ts||0) < 15000) n++;
      }
    }
    onlineCount = n;
    document.getElementById("hdrOnline").textContent = onlineCount;
  }catch(e){}
}
pollOnline();
setInterval(pollOnline, 3000);

/* ================== PRESENCE KE DEVICE ================== */
async function heartbeatPresence(){
  try{ await rtdbPut(PATH_PRES, Date.now()); }catch(e){}
}
heartbeatPresence();
setInterval(heartbeatPresence, 5000);

/* ================== DEVICE STATE ================== */
let telem = null;
let seq = 0;
async function sendCmd(patch){
  seq++;
  try{
    await rtdbPatch(PATH_CMD, { seq, ts: Date.now(), ...patch });
    toast("‚úÖ Terkirim ke perangkat");
  }catch(e){
    toast("‚ö†Ô∏è Gagal kirim");
  }
}
async function pollTelem(){
  try{
    telem = await rtdbGet(PATH_TELEM);
    document.getElementById("hdrVer").textContent = telem?.version || "-";
    if(page==="diorama") updateDioramaUI();
  }catch(e){}
}
pollTelem();
setInterval(pollTelem, 1000);

/* ================== NAV STATE ================== */
let page = "home";
let historyStack = ["home"];

function go(p){
  if(page !== p){
    historyStack.push(p);
    page = p;
    render();
  }
}
function back(){
  if(historyStack.length > 1){
    historyStack.pop();
    page = historyStack[historyStack.length-1];
    render();
  } else {
    page="home"; render();
  }
}

/* ================== SESSION SISWA ================== */
function getSession(){ return JSON.parse(localStorage.getItem("hh_student") || "null"); }
function saveSession(s){ localStorage.setItem("hh_student", JSON.stringify(s)); }

/* ================== SVG IMAGE HELPERS (NO FILES NEEDED) ================== */
function svgData(svg){
  return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}
function imgEvap(){
  return svgData(`
  <svg xmlns="http://www.w3.org/2000/svg" width="220" height="180">
    <defs>
      <linearGradient id="g" x1="0" x2="1">
        <stop offset="0" stop-color="#2a7fff"/><stop offset="1" stop-color="#53d5ff"/>
      </linearGradient>
    </defs>
    <rect width="100%" height="100%" fill="#eaf6ff"/>
    <circle cx="170" cy="45" r="26" fill="#ffd36a"/>
    <path d="M0 120 Q60 95 120 120 T240 120 V180 H0 Z" fill="url(#g)"/>
    <path d="M62 120 C62 95 88 95 88 120" fill="none" stroke="#ffffff" stroke-width="5" stroke-linecap="round"/>
    <path d="M100 118 C100 86 140 86 140 118" fill="none" stroke="#ffffff" stroke-width="5" stroke-linecap="round"/>
    <path d="M70 92 C70 70 88 58 105 52" fill="none" stroke="#ff4fa3" stroke-width="5" stroke-linecap="round"/>
    <path d="M100 94 C110 70 120 60 145 50" fill="none" stroke="#ff4fa3" stroke-width="5" stroke-linecap="round"/>
    <text x="14" y="26" font-family="Arial" font-weight="900" font-size="16" fill="#0d2b45">Evaporasi</text>
  </svg>`);
}
function imgCond(){
  return svgData(`
  <svg xmlns="http://www.w3.org/2000/svg" width="220" height="180">
    <rect width="100%" height="100%" fill="#f4fbff"/>
    <circle cx="55" cy="55" r="26" fill="#53d5ff" opacity="0.9"/>
    <g fill="#ffffff" stroke="#cfeaff" stroke-width="2">
      <ellipse cx="120" cy="90" rx="44" ry="26"/>
      <ellipse cx="95" cy="96" rx="30" ry="20"/>
      <ellipse cx="145" cy="98" rx="34" ry="22"/>
    </g>
    <path d="M70 140 C100 120 140 120 170 140" fill="none" stroke="#7c4dff" stroke-width="6" stroke-linecap="round"/>
    <text x="14" y="26" font-family="Arial" font-weight="900" font-size="16" fill="#0d2b45">Kondensasi</text>
  </svg>`);
}
function imgPres(){
  return svgData(`
  <svg xmlns="http://www.w3.org/2000/svg" width="220" height="180">
    <rect width="100%" height="100%" fill="#fff7e8"/>
    <g fill="#ffffff" stroke="#ffe0a3" stroke-width="2">
      <ellipse cx="110" cy="62" rx="52" ry="28"/>
      <ellipse cx="78" cy="68" rx="34" ry="22"/>
      <ellipse cx="148" cy="70" rx="36" ry="24"/>
    </g>
    <g fill="#2a7fff">
      <path d="M70 110 C80 95 90 95 95 110 C90 120 80 122 70 110Z"/>
      <path d="M105 112 C115 97 125 97 130 112 C125 122 115 124 105 112Z"/>
      <path d="M140 110 C150 95 160 95 165 110 C160 120 150 122 140 110Z"/>
    </g>
    <rect x="0" y="138" width="220" height="42" fill="#cfe7ff"/>
    <text x="14" y="26" font-family="Arial" font-weight="900" font-size="16" fill="#0d2b45">Presipitasi</text>
  </svg>`);
}
function imgFlood(){
  return svgData(`
  <svg xmlns="http://www.w3.org/2000/svg" width="220" height="180">
    <rect width="100%" height="100%" fill="#ffeef5"/>
    <rect x="20" y="70" width="70" height="46" rx="8" fill="#ff6fb1" opacity=".9"/>
    <rect x="40" y="56" width="26" height="14" rx="6" fill="#ffffff" opacity=".9"/>
    <rect x="120" y="64" width="80" height="52" rx="8" fill="#7c4dff" opacity=".85"/>
    <rect x="140" y="50" width="28" height="14" rx="6" fill="#ffffff" opacity=".9"/>
    <path d="M0 130 Q40 110 80 130 T160 130 T240 130 V180 H0 Z" fill="#2a7fff" opacity=".85"/>
    <path d="M0 145 Q40 125 80 145 T160 145 T240 145" fill="none" stroke="#53d5ff" stroke-width="6" stroke-linecap="round"/>
    <text x="14" y="26" font-family="Arial" font-weight="900" font-size="16" fill="#0d2b45">Banjir</text>
  </svg>`);
}

/* ================== BANK SOAL (BERGAMBAR) ================== */
/* Catatan: gambar tiap soal pakai ilustrasi SVG yang relevan (evap/cond/pres/flood). */
const QUESTION_BANK = [
  { img: imgEvap(), q:"Apa yang disebut evaporasi?", o:["Air berubah jadi es","Air menguap karena panas","Awan turun jadi hujan"], a:1 },
  { img: imgCond(), q:"Kondensasi itu terjadi saat...", o:["Uap air jadi awan","Hujan jadi sungai","Air jadi batu"], a:0 },
  { img: imgPres(), q:"Presipitasi adalah...", o:["Air menguap","Awan terbentuk","Hujan turun ke bumi"], a:2 },
  { img: imgFlood(), q:"Banjir biasanya terjadi karena...", o:["Air berlebih dan meluap","Air menguap habis","Awan hilang"], a:0 },
  { img: imgEvap(), q:"Sumber energi yang memicu evaporasi adalah...", o:["Matahari","Bulan","Bintang jatuh"], a:0 },
  { img: imgCond(), q:"Awan terbentuk dari...", o:["Tanah kering","Uap air yang berkumpul","Batu kecil"], a:1 },
  { img: imgPres(), q:"Setelah hujan turun, air biasanya...", o:["Naik ke langit lagi langsung","Mengalir ke sungai/laut","Berubah jadi api"], a:1 },
  { img: imgFlood(), q:"Cara mengurangi risiko banjir adalah...", o:["Buang sampah ke sungai","Menjaga saluran air bersih","Menutup semua pohon"], a:1 },
  { img: imgEvap(), q:"Contoh evaporasi di rumah adalah...", o:["Air jemuran kering","Es membeku","Kipas angin berputar"], a:0 },
  { img: imgCond(), q:"Contoh kondensasi yang mudah dilihat adalah...", o:["Embun di gelas dingin","Air mendidih","Batu panas"], a:0 },
  { img: imgPres(), q:"Kalau awan sudah sangat tebal dan gelap, biasanya...", o:["Akan hujan","Akan salju di Indonesia","Akan jadi pelangi dulu"], a:0 },
  { img: imgFlood(), q:"Banjir bisa membuat...", o:["Jalan tergenang","Udara jadi lebih dingin saja","Air hilang semua"], a:0 },
  { img: imgEvap(), q:"Evaporasi mengubah air menjadi...", o:["Uap air","Kaca","Pasir"], a:0 },
  { img: imgCond(), q:"Kondensasi biasanya terjadi di udara yang...", o:["Lebih dingin","Lebih panas","Tanpa oksigen"], a:0 },
  { img: imgPres(), q:"Presipitasi bisa berupa...", o:["Hujan","Uap","Batu"], a:0 },
  { img: imgFlood(), q:"Saat banjir, tindakan aman adalah...", o:["Main air deras","Naik ke tempat lebih tinggi","Menyentuh kabel listrik"], a:1 },
];

/* ================== QUIZ STATE ================== */
let quizSet = [];
let quizIdx = 0;
let quizScore = 0;
let quizLocked = false;

/* pilih 10 soal acak */
function pick10Random(){
  const arr = QUESTION_BANK.slice();
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr.slice(0, 10);
}

/* ================== PAGES RENDER ================== */
function render(){
  const app = document.getElementById("app");
  app.innerHTML = "";

  if(page==="home"){
    app.innerHTML = `
      <div class="grid">
        <div class="card hero">
          <div class="heroRow">
            <div>
              <div class="h2">Halo! Aku Tirta üíß</div>
              <div class="mini">Yuk belajar siklus air dengan cara yang seru dan gampang dipahami.</div>
            </div>
            <div class="badges">
              <div class="badge">üë• <small>Online:</small> <span>${onlineCount}</span></div>
              <div class="badge">üì° <small>Device:</small> <span>${telem?.version || "-"}</span></div>
            </div>
          </div>

          <div class="ctaRow">
            <button class="btn b-blue" id="mProyek"><span><i>üìö</i> Penjelasan Proyek</span><span>‚û°</span></button>
            <button class="btn b-pink" id="mSiswa"><span><i>üßí</i> Siswa</span><span>‚û°</span></button>
            <button class="btn b-green" id="mGuru"><span><i>üë©‚Äçüè´</i> Guru</span><span>‚û°</span></button>
            <button class="btn b-orange" id="mDiorama"><span><i>üé•</i> Diorama</span><span>‚û°</span></button>
          </div>

          <div class="navBar">
            <div class="mini">Tip: Menu dibuat bertingkat. Pakai tombol Back / Home / Next di bawah.</div>
          </div>
        </div>
      </div>
    `;
    document.getElementById("mProyek").onclick = ()=>go("proyek");
    document.getElementById("mSiswa").onclick  = ()=>go("siswa");
    document.getElementById("mGuru").onclick   = ()=>go("guru");
    document.getElementById("mDiorama").onclick= ()=>go("diorama");
  }

  if(page==="proyek"){
    app.innerHTML = `
      <div class="card">
        <div class="h2">üìö Penjelasan Proyek</div>
        <div class="mini">Pilih sub menu di bawah ya, Boss. Nanti ada penjelasan singkat + gambar.</div>
      </div>

      <div class="subgrid">
        <div class="topic" id="pEv">
          <div class="topicHead">
            <div class="pic" style="background:linear-gradient(135deg,#2a7fff,#53d5ff)"><img alt="" width="66" height="66" src="${imgEvap()}"></div>
            <div><h3>Evaporasi</h3><div class="mini">Air menguap karena panas matahari</div></div>
          </div>
        </div>

        <div class="topic" id="pKo">
          <div class="topicHead">
            <div class="pic" style="background:linear-gradient(135deg,#7c4dff,#caa8ff)"><img alt="" width="66" height="66" src="${imgCond()}"></div>
            <div><h3>Kondensasi</h3><div class="mini">Uap air berkumpul jadi awan</div></div>
          </div>
        </div>

        <div class="topic" id="pPr">
          <div class="topicHead">
            <div class="pic" style="background:linear-gradient(135deg,#ff9800,#ffd36a)"><img alt="" width="66" height="66" src="${imgPres()}"></div>
            <div><h3>Presipitasi</h3><div class="mini">Awan jenuh ‚Üí hujan turun</div></div>
          </div>
        </div>

        <div class="topic" id="pBa">
          <div class="topicHead">
            <div class="pic" style="background:linear-gradient(135deg,#ff4fa3,#ff9ed0)"><img alt="" width="66" height="66" src="${imgFlood()}"></div>
            <div><h3>Banjir</h3><div class="mini">Air berlebih ‚Üí sungai meluap</div></div>
          </div>
        </div>
      </div>
    `;

    document.getElementById("pEv").onclick = ()=>go("proyek_evaporasi");
    document.getElementById("pKo").onclick = ()=>go("proyek_kondensasi");
    document.getElementById("pPr").onclick = ()=>go("proyek_presipitasi");
    document.getElementById("pBa").onclick = ()=>go("proyek_banjir");
  }

  if(page==="proyek_evaporasi"){
    app.innerHTML = proyekDetail(
      "Evaporasi",
      imgEvap(),
      "Evaporasi adalah proses saat air berubah menjadi uap karena panas matahari. Uap air naik ke atas dan memulai siklus air.",
      ["Air di laut/danau menguap", "Jemuran jadi kering", "Uap air naik ke langit"]
    );
  }

  if(page==="proyek_kondensasi"){
    app.innerHTML = proyekDetail(
      "Kondensasi",
      imgCond(),
      "Kondensasi adalah proses saat uap air mendingin dan berkumpul menjadi titik-titik air kecil, lalu membentuk awan.",
      ["Uap air jadi awan", "Contoh: embun di gelas dingin", "Awan makin tebal kalau uap banyak"]
    );
  }

  if(page==="proyek_presipitasi"){
    app.innerHTML = proyekDetail(
      "Presipitasi",
      imgPres(),
      "Presipitasi adalah proses turunnya air dari awan ke bumi, seperti hujan. Ini terjadi saat awan sudah sangat jenuh.",
      ["Awan gelap ‚Üí hujan", "Air turun ke tanah", "Air mengalir ke sungai/laut"]
    );
  }

  if(page==="proyek_banjir"){
    app.innerHTML = proyekDetail(
      "Banjir",
      imgFlood(),
      "Banjir terjadi saat air berlebih tidak tertampung, sehingga sungai atau saluran meluap. Bisa terjadi karena hujan deras, saluran tersumbat, atau daerah resapan berkurang.",
      ["Jaga saluran air bersih", "Jangan buang sampah sembarangan", "Buat resapan/biopori"]
    );
  }

  if(page==="siswa"){
    const s = getSession() || {};
    app.innerHTML = `
      <div class="card">
        <div class="h2">üßí Menu Siswa</div>
        <div class="mini">Isi data dulu ya supaya kuisnya rapi.</div>
        <div style="height:10px"></div>
        <label class="mini"><b>Nama</b></label>
        <input id="nm" placeholder="contoh: Aulia" value="${s.name||""}">
        <label class="mini"><b>Kelas</b></label>
        <input id="kl" placeholder="contoh: 5A" value="${s.kelas||""}">

        <button class="btn b-pink" id="btnStart" style="margin-top:6px">
          <span><i>üìù</i> Mulai Kuis Bergambar</span><span>‚û°</span>
        </button>

        <div class="mini" style="margin-top:10px">
          Kuis: 10 soal acak, pilihan ganda, dengan gambar.
        </div>
      </div>
    `;
    document.getElementById("btnStart").onclick = ()=>{
      const name = document.getElementById("nm").value.trim();
      const kelas = document.getElementById("kl").value.trim();
      if(!name || !kelas){ alert("Isi nama dan kelas dulu ya üôÇ"); return; }
      saveSession({name, kelas, score:null});

      quizSet = pick10Random();
      quizIdx = 0;
      quizScore = 0;
      quizLocked = false;
      go("quiz");
    };
  }

  if(page==="quiz"){
    renderQuiz(app);
  }

  if(page==="hasil"){
    const s=getSession()||{};
    const sc = s?.score ? `${s.score.score}/${s.score.total}` : "-";
    app.innerHTML = `
      <div class="card">
        <div class="h2">üéâ Hasil Kuis</div>
        <div class="mini"><b>${escapeHtml(s.name||"-")}</b> (Kelas ${escapeHtml(s.kelas||"-")})</div>
        <div style="height:10px"></div>

        <div class="card" style="box-shadow:none;border:1px dashed rgba(13,43,69,.18);background:rgba(255,255,255,.65)">
          <div style="font-size:44px;font-weight:1000">‚≠ê ${sc} ‚≠ê</div>
          <div class="mini">Keren! Mau coba lagi? Klik Home lalu masuk menu Siswa lagi.</div>
        </div>
      </div>
    `;
  }

  if(page==="guru"){
    const s=getSession();
    const sc = s?.score ? `${s.score.score}/${s.score.total}` : "-";
    app.innerHTML = `
      <div class="card">
        <div class="h2">üë©‚Äçüè´ Menu Guru</div>
        <div class="mini">Monitoring sederhana (IP pengunjung dimatikan sesuai request).</div>

        <div style="height:10px"></div>
        <div class="grid">
          <div class="card" style="grid-column:span 6;background:linear-gradient(135deg,rgba(42,127,255,.10),rgba(83,213,255,.08))">
            <div style="font-weight:1000;font-size:16px">üë• Online</div>
            <div style="font-size:32px;font-weight:1000;margin-top:6px">${onlineCount}</div>
            <div class="mini">Pengunjung aktif (‚âà 15 detik terakhir)</div>
          </div>
          <div class="card" style="grid-column:span 6;background:linear-gradient(135deg,rgba(255,79,163,.10),rgba(255,158,208,.08))">
            <div style="font-weight:1000;font-size:16px">üìù Skor terakhir (device ini)</div>
            <div style="font-size:32px;font-weight:1000;margin-top:6px">${sc}</div>
            <div class="mini">Sementara tersimpan di browser perangkat ini</div>
          </div>
        </div>

        <div class="mini" style="margin-top:8px">
          Next step (kalau Boss mau nanti): score multi-device bisa kita simpan ke RTDB.
        </div>
      </div>
    `;
  }

  if(page==="diorama"){
    app.innerHTML = `
      <div class="card">
        <div class="h2">üé• Diorama</div>
        <div class="mini">Klik tombol proses siklus air. Perintah dikirim ke Firebase, lalu ESP32 mengeksekusi.</div>
      </div>

      <div class="card">
        <div class="grid">
          <div class="card" style="grid-column:span 6;background:linear-gradient(135deg,rgba(42,127,255,.10),rgba(83,213,255,.08))">
            <div style="font-weight:1000">üìè Ultrasonic</div>
            <div id="uPct" style="font-size:34px;font-weight:1000;margin-top:6px">- %</div>
            <div class="mini">Tinggi air (persen)</div>
          </div>
          <div class="card" style="grid-column:span 6;background:linear-gradient(135deg,rgba(32,201,151,.10),rgba(135,245,208,.08))">
            <div style="font-weight:1000">üí¶ Flow</div>
            <div id="fLpm" style="font-size:34px;font-weight:1000;margin-top:6px">-</div>
            <div class="mini">L/menit</div>
          </div>

          <div class="card" style="grid-column:span 12;background:rgba(255,255,255,.70)">
            <div style="font-weight:1000;margin-bottom:8px">üîå Status Output</div>
            <div class="mini" id="outS">A:- B:- C:- D:- | LD:- P2:-</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="grid">
          <button class="btn b-blue" id="bA" style="grid-column:span 6"><span><i>üî¥</i> Evaporasi (A)</span><span>Tap</span></button>
          <button class="btn b-purple" id="bB" style="grid-column:span 6"><span><i>üîµ</i> Kondensasi (B)</span><span>Tap</span></button>
          <button class="btn b-orange" id="bC" style="grid-column:span 6"><span><i>üü°</i> Presipitasi (C)</span><span>Tap</span></button>
          <button class="btn b-pink" id="bD" style="grid-column:span 6"><span><i>‚ö™</i> Banjir (D)</span><span>Tap</span></button>
          <button class="btn b-red" id="bOff" style="grid-column:span 6"><span><i>‚õî</i> Matikan Semua</span><span>Tap</span></button>
          <button class="btn b-green" id="bMode" style="grid-column:span 6"><span><i>‚öôÔ∏è</i> Ganti Mode</span><span>Tap</span></button>
        </div>
        <div class="mini" style="margin-top:10px">Tip: tombol-tombol ini dibuat besar biar enak dipencet anak SD.</div>
      </div>
    `;

    // event sekali (tidak di-reset tiap polling)
    document.getElementById("bA").onclick=()=>sendCmd({k:"A"});
    document.getElementById("bB").onclick=()=>sendCmd({k:"B"});
    document.getElementById("bC").onclick=()=>sendCmd({k:"C"});
    document.getElementById("bD").onclick=()=>sendCmd({k:"D"});
    document.getElementById("bOff").onclick=()=>sendCmd({k:"ALLOFF"});
    document.getElementById("bMode").onclick=()=>{
      const next = (telem?.mode==="manual") ? "auto" : "manual";
      sendCmd({mode: next});
    };

    updateDioramaUI();
  }

  updateFooterNav();
}

/* ====== detail page template ====== */
function proyekDetail(title, imgSrc, desc, bullets){
  const items = bullets.map(x=>`<li style="margin:6px 0">${escapeHtml(x)}</li>`).join("");
  return `
    <div class="card">
      <div class="h2">üìö ${escapeHtml(title)}</div>
      <div class="qCard" style="margin-top:10px">
        <div class="qImg"><img alt="" src="${imgSrc}" style="width:100%;height:100%;object-fit:cover"></div>
        <div class="qText">
          <div class="mini" style="font-size:13px;line-height:1.55">${escapeHtml(desc)}</div>
          <div style="height:10px"></div>
          <div style="font-weight:1000">Yang penting diingat:</div>
          <ul style="margin:8px 0 0;color:var(--muted);font-size:13px;line-height:1.45">${items}</ul>
        </div>
      </div>
    </div>
  `;
}

/* ================== QUIZ RENDER (10 soal acak bergambar) ================== */
function renderQuiz(app){
  const s=getSession()||{};
  if(!quizSet.length){
    // safety: kalau user refresh di tengah quiz
    quizSet = pick10Random();
    quizIdx=0; quizScore=0; quizLocked=false;
  }

  const q = quizSet[quizIdx];
  const pct = Math.round(((quizIdx)/quizSet.length)*100);

  app.innerHTML = `
    <div class="card">
      <div class="quizTop">
        <div>
          <div class="h2">üìù Kuis Bergambar</div>
          <div class="mini"><b>${escapeHtml(s.name||"Siswa")}</b> (Kelas ${escapeHtml(s.kelas||"-")})</div>
        </div>
        <div class="progress">
          <div>${quizIdx+1}/${quizSet.length}</div>
          <div class="bar"><div id="barFill"></div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="qCard">
        <div class="qImg">
          <img alt="" src="${q.img}" style="width:100%;height:100%;object-fit:cover">
        </div>
        <div class="qText">
          <h3>${escapeHtml(q.q)}</h3>
          <div class="choices" id="choices"></div>
          <div class="mini" id="hint" style="margin-top:10px">Pilih jawaban yang paling benar ya üôÇ</div>
        </div>
      </div>
    </div>
  `;

  const fill=document.getElementById("barFill");
  fill.style.width = `${pct}%`;

  const choicesEl = document.getElementById("choices");
  choicesEl.innerHTML = "";
  q.o.forEach((opt, i)=>{
    const btn = document.createElement("button");
    btn.className = "choiceBtn";
    btn.innerHTML = `<div style="display:flex;justify-content:space-between;gap:10px">
        <div>${escapeHtml(opt)}</div>
        <small>${["A","B","C"][i] || ""}</small>
      </div>`;
    btn.onclick = ()=>{
      if(quizLocked) return;
      quizLocked = true;

      const correct = (i === q.a);
      if(correct){
        quizScore++;
        btn.classList.add("good");
        document.getElementById("hint").textContent = "‚úÖ Benar! Mantap!";
      } else {
        btn.classList.add("bad");
        document.getElementById("hint").textContent = "‚ùå Hampir! Yuk coba soal berikutnya.";
        // tandai jawaban benar
        [...choicesEl.children].forEach((b, idx)=>{
          if(idx === q.a) b.classList.add("good");
        });
      }

      setTimeout(()=>{
        quizIdx++;
        quizLocked = false;
        if(quizIdx >= quizSet.length){
          const sess = getSession() || {};
          sess.score = { score: quizScore, total: quizSet.length };
          saveSession(sess);
          go("hasil");
          return;
        }
        render(); // render quiz next
      }, 900);
    };
    choicesEl.appendChild(btn);
  });
}

/* ================== Diorama UI update ================== */
function updateDioramaUI(){
  const u=document.getElementById("uPct");
  if(!u) return;

  const percent = (telem?.ultra_percent ?? "-");
  const flow = (telem?.flow_lpm ?? "-");
  const A = !!telem?.outA, B = !!telem?.outB, C = !!telem?.outC, D = !!telem?.outD;
  const LD = !!telem?.lampuDesa, P2 = !!telem?.pompa2;

  document.getElementById("uPct").textContent = `${percent}%`;
  document.getElementById("fLpm").textContent = `${flow} L/menit`;
  document.getElementById("outS").textContent =
    `A:${A?"ON":"OFF"} B:${B?"ON":"OFF"} C:${C?"ON":"OFF"} D:${D?"ON":"OFF"} | LD:${LD?"ON":"OFF"} P2:${P2?"ON":"OFF"}`;
}

/* ================== Footer Nav behavior ================== */
function updateFooterNav(){
  // Next: buat alur sederhana
  const order = ["home","proyek","siswa","diorama","guru"];
  const idx = order.indexOf(page);

  document.getElementById("btnBack").disabled = (historyStack.length <= 1);
  document.getElementById("btnNext").disabled = (idx < 0 || idx >= order.length-1);

  document.getElementById("btnBack").style.opacity = (historyStack.length<=1) ? .55 : 1;
  document.getElementById("btnNext").style.opacity = (idx<0 || idx>=order.length-1) ? .55 : 1;
}

/* ================== utils ================== */
function escapeHtml(s){
  return (s||"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

/* ================== footer buttons ================== */
document.getElementById("btnHome").onclick = ()=>{
  page="home";
  historyStack=["home"];
  render();
};
document.getElementById("btnBack").onclick = ()=>back();
document.getElementById("btnNext").onclick = ()=>{
  const order = ["home","proyek","siswa","diorama","guru"];
  const idx = order.indexOf(page);
  if(idx >= 0 && idx < order.length-1) go(order[idx+1]);
};

/* ================== init ================== */
render();
</script>

</body>
</html>
