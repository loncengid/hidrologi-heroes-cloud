<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Hidrologi Heroes Dashboard - NISEEF v12</title>

  <style>
    :root{
      --bgcard: rgba(0,0,0,.75);
      --hi:#00d4ff;
      --txt:#fff;
      --mut: rgba(255,255,255,.85);
      --bd: rgba(255,255,255,.25);
      --panel: rgba(0,0,0,.55);
      --ok:#2ecc71; --bad:#ff4757; --warn:#ffa502;
    }
    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin:0; color:var(--txt);
      background:url('https://raw.githubusercontent.com/loncengid/Hidrologi-Heroes-Assets/main/background%20plmth.png') no-repeat center center fixed;
      background-size:cover;
    }
    .container{ min-height:100vh; padding:18px; display:flex; flex-direction:column; align-items:center; gap:14px; }
    .card{
      width:min(720px, 96vw);
      background:var(--bgcard);
      backdrop-filter: blur(15px);
      border-radius:22px;
      border:2px solid var(--hi);
      padding:16px;
      box-shadow: 0 10px 40px rgba(0,0,0,.6);
      display:none;
    }
    .card.active{ display:block; animation: up .25s ease-out; }
    @keyframes up{ from{ opacity:0; transform: translateY(10px);} to{ opacity:1; transform:none;} }

    h1,h2,h3{ margin:0 0 10px 0; font-weight:1000; text-transform:uppercase; text-shadow:3px 3px 6px rgba(0,0,0,.8); }
    .topbar{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom:10px; flex-wrap:wrap; }
    .sub{ font-size:12px; color:var(--mut); font-weight:900; line-height:1.3; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      background: rgba(0,0,0,.45);
      border:1px solid var(--bd);
      font-weight:1000; font-size:12px;
      white-space:nowrap;
    }
    .dot{ width:10px; height:10px; border-radius:50%; background:var(--warn); box-shadow:0 0 0 3px rgba(255,255,255,.08); }
    .dot.ok{ background:var(--ok); }
    .dot.bad{ background:var(--bad); }

    .status{
      background: var(--panel);
      border:1px solid var(--bd);
      border-radius:16px;
      padding:12px;
      margin: 10px 0 14px 0;
      font-weight:900;
      line-height:1.6;
    }
    .row{ display:flex; justify-content:space-between; gap:12px; align-items:center; }
    .k{ color:var(--mut); font-weight:900; }
    .v{ text-align:right; font-weight:1000; }

    .btn{
      width:100%;
      padding:16px;
      margin:8px 0;
      border:none;
      border-radius:16px;
      font-size:16px;
      font-weight:1000;
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:.8px;
      transition: transform .06s ease, opacity .2s ease, filter .2s ease;
      position: relative;
    }
    .btn:active{ transform: scale(.99); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; filter: grayscale(.35); }

    /* ACTIVE PER-TOGGLE */
    .btn.active{
      outline:3px solid rgba(255,255,255,.9);
      box-shadow:0 0 0 4px rgba(0, 212, 255, .25);
    }
    .btn.active::after{
      content:"ON";
      position:absolute;
      top:10px; right:12px;
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.35);
    }

    .nav{ display:flex; gap:10px; margin-top:12px; }
    .nav button{
      flex:1;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--bd);
      background: rgba(0,0,0,.55);
      color: var(--txt);
      font-weight:1000;
      cursor:pointer;
    }
    .nav .home{ background:#ff1744; border:none; }
    .nav button[disabled]{ opacity:.55; cursor:not-allowed; }

    .panel{
      background: rgba(0,0,0,.35);
      border:1px solid var(--bd);
      border-radius:16px;
      padding:12px;
      margin-top:12px;
    }
    .mini{ font-size:12px; color:var(--mut); font-weight:800; margin-top:8px; line-height:1.4; }
    code{ color:#c7f6ff; font-weight:900; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background: rgba(0,0,0,.35);
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
    }
    .b-on{ color: var(--ok); }
    .b-off{ color: var(--bad); }
    .b-hold{ color: var(--warn); }

    .hw-row{
      display:flex;
      justify-content:space-between;
      padding:8px 0;
      border-bottom:1px dashed rgba(255,255,255,.18);
      font-weight:900;
    }
    .hw-row:last-child{ border-bottom:none; }
  </style>
</head>

<body>
  <div class="container">

    <!-- PAGE 0: HOME -->
    <div class="card active" id="page-home">
      <div class="topbar">
        <div>
          <h1 style="font-size:22px;">Hidrologi Heroes</h1>
          <div class="sub" id="fwLine">Firmware: -</div>
          <div class="sub">UI sinkron: <code>NISEEF v12</code> â€¢ Multi-toggle â€¢ Presence</div>
        </div>

        <div class="pill" title="Koneksi ke Firebase RTDB">
          <span class="dot" id="connDot"></span>
          <span id="connText">CONNECTING</span>
        </div>
      </div>

      <div class="status">
        <div class="row"><div class="k">Pengunjung Online</div><div class="v" id="ui-viewers">-</div></div>
        <hr style="opacity:.2">
        <div class="row"><div class="k">Level Air</div><div class="v"><span id="m-persen">-</span>%</div></div>
        <div class="row"><div class="k">Debit Air (Flow)</div><div class="v"><span id="m-flow">-</span> L/min</div></div>
        <hr style="opacity:.2">
        <div class="row">
          <div class="k">Status Sistem</div>
          <div class="v" style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <span class="badge" id="badgeLampu">Lampu Desa: -</span>
            <span class="badge" id="badgePompa2">Pompa 2: -</span>
          </div>
        </div>
        <div class="row"><div class="k">Last Log</div><div class="v" id="m-lastlog">-</div></div>
      </div>

      <button class="btn" style="background:linear-gradient(45deg,#007bff,#00c6ff); color:#fff;"
              id="go-diorama">MASUK KONTROL DIORAMA</button>

      <div class="panel">
        <h3 style="margin:0 0 8px 0; font-size:14px;">Pin & Hardware (Realtime)</h3>
        <div id="hw-list" class="mini">Loading...</div>
      </div>

      <div class="mini">
        Data dipakai UI: <code>/sensor/persen</code>, <code>/debit/flow_lpm</code>, <code>/desa/lampu_aktif</code>, <code>/diorama/mode/*</code>
      </div>

      <div class="nav">
        <button disabled>BACK</button>
        <button class="home" disabled>HOME</button>
        <button id="next-home">NEXT</button>
      </div>
    </div>

    <!-- PAGE 1: DIORAMA -->
    <div class="card" id="page-diorama">
      <div class="topbar">
        <div>
          <h2 style="font-size:18px; margin-bottom:4px;">Kontrol Diorama</h2>
          <div class="sub">Tekan sekali ON, tekan lagi OFF. Bisa ON bareng.</div>
        </div>
        <div class="pill">ðŸ‘¥ <span id="ui-viewers-2">-</span></div>
      </div>

      <div class="status">
        <div class="row"><div class="k">Level Air</div><div class="v"><span id="ui-persen">-</span>%</div></div>
        <div class="row"><div class="k">Debit Air (Flow)</div><div class="v"><span id="ui-flow">-</span> L/min</div></div>
        <hr style="opacity:.2">
        <div class="row">
          <div class="k">Status</div>
          <div class="v" style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <span class="badge" id="badgeLampu2">Lampu Desa: -</span>
            <span class="badge" id="badgePompa22">Pompa 2: -</span>
          </div>
        </div>
      </div>

      <button class="btn" style="background:#f44336" id="btn-evap">EVAPORASI</button>
      <button class="btn" style="background:#ff9800" id="btn-kond">KONDENSASI</button>
      <button class="btn" style="background:#4caf50" id="btn-pres">PRESIPITASI</button>
      <button class="btn" style="background:#2196f3" id="btn-banj">BANJIR</button>
      <button class="btn" style="background:#333" id="btn-off">MATIKAN SEMUA</button>

      <div class="nav">
        <button id="back-diorama">BACK</button>
        <button class="home" id="home-diorama">HOME</button>
        <button id="next-diorama">NEXT</button>
      </div>
    </div>

    <!-- PAGE 2: INFO -->
    <div class="card" id="page-info">
      <div class="topbar">
        <div>
          <h2 style="font-size:18px; margin-bottom:4px;">Info & Diagnostik</h2>
          <div class="sub">Cek versi firmware, pinmap, dan path RTDB</div>
        </div>
        <div class="pill">ðŸ‘¥ <span id="ui-viewers-3">-</span></div>
      </div>

      <div class="status">
        <div class="row"><div class="k">Firmware</div><div class="v" id="info-fw">-</div></div>
        <div class="row"><div class="k">Build</div><div class="v" id="info-build">-</div></div>
        <hr style="opacity:.2">
        <div class="row"><div class="k">Path Mode</div><div class="v"><code>/diorama/mode/*</code></div></div>
        <div class="row"><div class="k">Sensor</div><div class="v"><code>/sensor/persen</code></div></div>
        <div class="row"><div class="k">Debit</div><div class="v"><code>/debit/flow_lpm</code></div></div>
        <div class="row"><div class="k">Lampu Desa</div><div class="v"><code>/desa/lampu_aktif</code></div></div>
        <div class="row"><div class="k">Presence</div><div class="v"><code>/presence/*</code></div></div>
      </div>

      <div class="panel">
        <h3 style="margin:0 0 8px 0; font-size:14px;">Pin Map dari Firmware</h3>
        <div id="pinmap-box" class="mini">Loading...</div>
      </div>

      <div class="nav">
        <button id="back-info">BACK</button>
        <button class="home" id="home-info">HOME</button>
        <button disabled>NEXT</button>
      </div>
    </div>

  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // ====== Firebase RTDB (v8 compat) ======
    var config = { databaseURL: "https://hidrologi-heroes-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    firebase.initializeApp(config);
    var db = firebase.database();

    // ====== Pages ======
    const pages = ["page-home", "page-diorama", "page-info"];
    let currentIndex = 0;

    function showPageByIndex(idx){
      currentIndex = Math.max(0, Math.min(pages.length - 1, idx));
      pages.forEach(id => document.getElementById(id).classList.remove("active"));
      document.getElementById(pages[currentIndex]).classList.add("active");
      window.scrollTo(0,0);
      bumpActive();
    }
    function back(){ showPageByIndex(currentIndex - 1); }
    function next(){ showPageByIndex(currentIndex + 1); }
    function home(){ showPageByIndex(0); }

    document.getElementById("go-diorama").onclick = () => showPageByIndex(1);
    document.getElementById("next-home").onclick = () => next();
    document.getElementById("back-diorama").onclick = () => back();
    document.getElementById("home-diorama").onclick = () => home();
    document.getElementById("next-diorama").onclick = () => next();
    document.getElementById("back-info").onclick = () => back();
    document.getElementById("home-info").onclick = () => home();

    // ====== Connection indicator ======
    const connDot = document.getElementById("connDot");
    const connText = document.getElementById("connText");
    function setConn(state){
      connDot.classList.remove("ok","bad");
      if(state === "ok"){ connDot.classList.add("ok"); connText.textContent = "ONLINE"; }
      else if(state === "bad"){ connDot.classList.add("bad"); connText.textContent = "OFFLINE"; }
      else { connText.textContent = "CONNECTING"; }
    }
    setConn("warn");

    // Disable buttons when offline
    const modeButtons = ["btn-evap","btn-kond","btn-pres","btn-banj","btn-off"].map(id => document.getElementById(id));
    function setButtonsEnabled(en){ modeButtons.forEach(b => b.disabled = !en); }

    // ====== Presence (Realtime viewers) ======
    const sessionId = "sess_" + Math.random().toString(16).slice(2);
    const sessionRef = db.ref("presence/sessions/" + sessionId);

    function bumpActive(){
      const sec = Math.floor(Date.now() / 1000);
      db.ref("presence/lastActiveSec").set(sec);
      sessionRef.set({ ts: sec });
    }

    // keep-alive (20 detik)
    setInterval(() => bumpActive(), 20000);
    // bump on interactions
    document.body.addEventListener("click", () => bumpActive());
    document.body.addEventListener("touchstart", () => bumpActive(), { passive:true });

    // onDisconnect remove session
    db.ref(".info/connected").on("value", snap => {
      const ok = !!snap.val();
      if(ok){
        setConn("ok");
        setButtonsEnabled(true);
        sessionRef.onDisconnect().remove();
        bumpActive();
      }else{
        setConn("bad");
        setButtonsEnabled(false);
      }
    });

    // viewers count
    db.ref("presence/sessions").on("value", snap => {
      const obj = snap.val() || {};
      const count = Object.keys(obj).length;
      document.getElementById("ui-viewers").innerText = count;
      document.getElementById("ui-viewers-2").innerText = count;
      document.getElementById("ui-viewers-3").innerText = count;
    });

    // ====== Helpers ======
    function setNum(id, v, d=2){
      const el = document.getElementById(id);
      if(!el) return;
      if(v == null) el.innerText = "-";
      else el.innerText = Number(v).toFixed(d);
    }
    function setInt(id, v){
      const el = document.getElementById(id);
      if(!el) return;
      if(v == null) el.innerText = "-";
      else el.innerText = Math.round(Number(v));
    }

    function setBadge(el, label, state){
      el.classList.remove("b-on","b-off","b-hold");
      if(state === "ON"){ el.classList.add("b-on"); el.textContent = `${label}: ON`; }
      else if(state === "OFF"){ el.classList.add("b-off"); el.textContent = `${label}: OFF`; }
      else { el.classList.add("b-hold"); el.textContent = `${label}: HOLD`; }
    }

    // ====== Firmware info ======
    db.ref("system").on("value", snap => {
      const d = snap.val() || {};
      const ver = d.version || "-";
      const bld = d.build || "-";
      document.getElementById("fwLine").innerText = `Firmware: ${ver} | build ${bld}`;
      document.getElementById("info-fw").innerText = ver;
      document.getElementById("info-build").innerText = bld;
    });

    // ====== Realtime sensor: LEVEL (%) only ======
    let lastLevelPct = null;

    db.ref("sensor/persen").on("value", snap => {
      const v = snap.val();
      lastLevelPct = (v == null) ? null : Number(v);
      setInt("m-persen", lastLevelPct);
      setInt("ui-persen", lastLevelPct);

      // Pompa2 state derived from level rules (v12): ON>=80, OFF<=25, else HOLD
      const b1 = document.getElementById("badgePompa2");
      const b2 = document.getElementById("badgePompa22");
      if(lastLevelPct == null){
        setBadge(b1, "Pompa 2", "HOLD");
        setBadge(b2, "Pompa 2", "HOLD");
      }else if(lastLevelPct >= 80){
        setBadge(b1, "Pompa 2", "ON");
        setBadge(b2, "Pompa 2", "ON");
      }else if(lastLevelPct <= 25){
        setBadge(b1, "Pompa 2", "OFF");
        setBadge(b2, "Pompa 2", "OFF");
      }else{
        setBadge(b1, "Pompa 2", "HOLD");
        setBadge(b2, "Pompa 2", "HOLD");
      }
    });

    // ====== Realtime debit: FLOW only ======
    db.ref("debit/flow_lpm").on("value", snap => {
      const v = snap.val();
      setNum("m-flow", v, 3);
      setNum("ui-flow", v, 3);
    });

    // ====== Lampu Desa status ======
    db.ref("desa/lampu_aktif").on("value", snap => {
      const on = !!snap.val();
      const b1 = document.getElementById("badgeLampu");
      const b2 = document.getElementById("badgeLampu2");
      setBadge(b1, "Lampu Desa", on ? "ON" : "OFF");
      setBadge(b2, "Lampu Desa", on ? "ON" : "OFF");
    });

    // ====== last log time ======
    db.ref("log/lastTs").on("value", snap => {
      const ts = snap.val();
      const el = document.getElementById("m-lastlog");
      if(!el) return;
      if(!ts){ el.innerText = "-"; return; }
      const d = new Date(Number(ts) * 1000);
      el.innerText = d.toLocaleTimeString("id-ID", { hour12:false });
    });

    // ====== Multi-toggle mode controls ======
    const modePaths = {
      evaporasi: "diorama/mode/evaporasi",
      kondensasi: "diorama/mode/kondensasi",
      presipitasi: "diorama/mode/presipitasi",
      banjir: "diorama/mode/banjir",
    };
    const btnMap = {
      evaporasi: document.getElementById("btn-evap"),
      kondensasi: document.getElementById("btn-kond"),
      presipitasi: document.getElementById("btn-pres"),
      banjir: document.getElementById("btn-banj"),
    };

    function setBtnState(name, on){
      const b = btnMap[name];
      if(!b) return;
      if(on) b.classList.add("active");
      else b.classList.remove("active");
    }

    // Listen each mode boolean
    Object.entries(modePaths).forEach(([name, p]) => {
      db.ref(p).on("value", snap => setBtnState(name, !!snap.val()));
    });

    function toggleOne(name){
      bumpActive();
      const p = modePaths[name];
      db.ref(p).once("value").then(snap => {
        const cur = !!snap.val();
        db.ref(p).set(!cur);
      });
    }

    document.getElementById("btn-evap").onclick = () => toggleOne("evaporasi");
    document.getElementById("btn-kond").onclick = () => toggleOne("kondensasi");
    document.getElementById("btn-pres").onclick = () => toggleOne("presipitasi");
    document.getElementById("btn-banj").onclick = () => toggleOne("banjir");

    // Matikan semua
    document.getElementById("btn-off").onclick = () => {
      bumpActive();
      Promise.all(Object.values(modePaths).map(p => db.ref(p).set(false)));
    };

    // ====== Hardware pin map + realtime output status ======
    const hwList = document.getElementById("hw-list");

    function renderHardware(pinmap, modeState){
      // modeState: {evaporasi:bool, ...}
      const rows = [];

      rows.push(`<div class="hw-row"><span>Evaporasi</span><span>${pinmap?.tombolA_evaporasi_gpio ?? 15} â€¢ <span class="${modeState.evaporasi?'b-on':'b-off'}">${modeState.evaporasi?'ON':'OFF'}</span></span></div>`);
      rows.push(`<div class="hw-row"><span>Kondensasi</span><span>${pinmap?.tombolB_kondensasi_gpio ?? 2} â€¢ <span class="${modeState.kondensasi?'b-on':'b-off'}">${modeState.kondensasi?'ON':'OFF'}</span></span></div>`);
      rows.push(`<div class="hw-row"><span>Presipitasi</span><span>${pinmap?.tombolC_presipitasi_gpio ?? 4} â€¢ <span class="${modeState.presipitasi?'b-on':'b-off'}">${modeState.presipitasi?'ON':'OFF'}</span></span></div>`);
      rows.push(`<div class="hw-row"><span>Banjir</span><span>${pinmap?.tombolD_banjir_gpio ?? 16} â€¢ <span class="${modeState.banjir?'b-on':'b-off'}">${modeState.banjir?'ON':'OFF'}</span></span></div>`);

      rows.push(`<div class="hw-row"><span>Lampu Desa</span><span>${pinmap?.lampu_desa_gpio ?? 17} â€¢ <span id="hwLamp" class="b-hold">-</span></span></div>`);
      rows.push(`<div class="hw-row"><span>Pompa 2</span><span>${pinmap?.pompa2_gpio ?? 5} â€¢ <span id="hwP2" class="b-hold">-</span></span></div>`);
      rows.push(`<div class="hw-row"><span>YF-S401 (Pulse)</span><span>GPIO ${pinmap?.yf_s401_gpio ?? 25}</span></div>`);
      rows.push(`<div class="hw-row"><span>Ultrasonik TRIG</span><span>GPIO ${pinmap?.ultrasonik_trig_gpio ?? 32}</span></div>`);
      rows.push(`<div class="hw-row"><span>Ultrasonik ECHO</span><span>GPIO ${pinmap?.ultrasonik_echo_gpio ?? 33}</span></div>`);

      hwList.innerHTML = rows.join("");

      // update lampu desa badge in list
      db.ref("desa/lampu_aktif").once("value").then(s=>{
        const on = !!s.val();
        const el = document.getElementById("hwLamp");
        if(el){
          el.classList.remove("b-on","b-off","b-hold");
          el.classList.add(on ? "b-on" : "b-off");
          el.textContent = on ? "ON" : "OFF";
        }
      });

      // update pompa2 derived in list
      const p2 = document.getElementById("hwP2");
      if(p2){
        let st = "HOLD";
        if(lastLevelPct != null){
          if(lastLevelPct >= 80) st = "ON";
          else if(lastLevelPct <= 25) st = "OFF";
        }
        p2.classList.remove("b-on","b-off","b-hold");
        p2.classList.add(st === "ON" ? "b-on" : st === "OFF" ? "b-off" : "b-hold");
        p2.textContent = st;
      }
    }

    // Pinmap box in info page
    const pinmapBox = document.getElementById("pinmap-box");

    let cachedPinmap = null;
    let cachedModes = { evaporasi:false, kondensasi:false, presipitasi:false, banjir:false };

    db.ref("hardware/pinmap").on("value", snap => {
      cachedPinmap = snap.val() || null;

      // Info page view
      if(!cachedPinmap){
        pinmapBox.innerText = "Belum ada /hardware/pinmap dari firmware.";
      }else{
        pinmapBox.innerHTML =
          `<div>Evaporasi: GPIO <b>${cachedPinmap.tombolA_evaporasi_gpio}</b></div>` +
          `<div>Kondensasi: GPIO <b>${cachedPinmap.tombolB_kondensasi_gpio}</b></div>` +
          `<div>Presipitasi: GPIO <b>${cachedPinmap.tombolC_presipitasi_gpio}</b></div>` +
          `<div>Banjir: GPIO <b>${cachedPinmap.tombolD_banjir_gpio}</b></div>` +
          `<div>Lampu Desa: GPIO <b>${cachedPinmap.lampu_desa_gpio}</b> (flow >= 2.0 + pulse)</div>` +
          `<div>Pompa 2: GPIO <b>${cachedPinmap.pompa2_gpio}</b> (ON>=80%, OFF<=25%)</div>` +
          `<div>YF-S401: GPIO <b>${cachedPinmap.yf_s401_gpio}</b></div>` +
          `<div>Ultrasonik: TRIG <b>${cachedPinmap.ultrasonik_trig_gpio}</b> / ECHO <b>${cachedPinmap.ultrasonik_echo_gpio}</b></div>`;
      }

      renderHardware(cachedPinmap, cachedModes);
    });

    // cache modes for hardware list display
    Object.keys(modePaths).forEach(name => {
      db.ref(modePaths[name]).on("value", snap => {
        cachedModes[name] = !!snap.val();
        renderHardware(cachedPinmap, cachedModes);
      });
    });

    // Init
    bumpActive();
  </script>
</body>
</html>
