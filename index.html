<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hidrologi Heroes â€“ Lacak si Tirta</title>

<style>
body{margin:0;font-family:Arial,system-ui;background:#eaf3ff;color:#123}
header{background:#4da3ff;color:#fff;padding:16px;text-align:center}
h1{margin:0;font-size:22px}
main{padding:16px;padding-bottom:92px}
.card{background:#fff;border-radius:18px;padding:18px;margin-bottom:16px;box-shadow:0 6px 14px rgba(0,0,0,.1)}
button{width:100%;padding:14px;margin-top:10px;border:none;border-radius:14px;font-size:18px;font-weight:bold;background:#4da3ff;color:#fff;cursor:pointer}
button.secondary{background:#8bc34a}
button.warn{background:#ff9800}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.badge{display:inline-block;padding:6px 12px;background:#e0f2ff;border-radius:999px;font-size:14px;margin-bottom:12px}
.small{font-size:13px;opacity:.85}
input{width:100%;padding:12px;margin-top:6px;margin-bottom:10px;border-radius:12px;border:1px solid #ccc;font-size:16px}
.choice{margin:8px 0}
.kv{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.kv div{background:#f4fbff;border:1px solid #cfeaff;border-radius:14px;padding:12px}
.footer{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:10px;display:flex;gap:10px;box-shadow:0 -4px 10px rgba(0,0,0,.1)}
.footer button{font-size:14px;padding:10px}
</style>
</head>

<body>
<header>
  <h1>Hidrologi Heroes</h1>
  <div>Lacak si Tirta, Air Ajaib ğŸ’§</div>
</header>

<main id="app"></main>

<div class="footer">
  <button id="btnHome">ğŸ  Home</button>
</div>

<script>
/* ================== KONFIG RTDB ==================
   Pakai REST: https://<db>.asia-southeast1.firebasedatabase.app/<path>.json
   Kalau DB rules kamu public, ini langsung jalan.
==================================================== */
const DB_BASE = "https://hidrologi-heroes-default-rtdb.asia-southeast1.firebasedatabase.app";
const DEVICE_ID = "niseef_v12_01";

const PATH_CMD   = `/devices/${DEVICE_ID}/cmd`;
const PATH_TELEM = `/devices/${DEVICE_ID}/telemetry`;
const PATH_PRES  = `/devices/${DEVICE_ID}/presence/lastActiveMs`;

/* =============== HELPERS REST =============== */
async function rtdbGet(path){
  const res = await fetch(`${DB_BASE}${path}.json`, {cache:"no-store"});
  return await res.json();
}
async function rtdbPut(path, obj){
  await fetch(`${DB_BASE}${path}.json`, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(obj)
  });
}
async function rtdbPatch(path, obj){
  await fetch(`${DB_BASE}${path}.json`, {
    method:"PATCH",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(obj)
  });
}

/* ================== ONLINE COUNTER ================== */
const cid = "c_" + Math.random().toString(36).slice(2);
async function heartbeatOnline(){
  await rtdbPatch(`/online/${cid}`, {ts: Date.now()});
}
heartbeatOnline();
setInterval(heartbeatOnline, 5000);

/* ================== PRESENCE KE DEVICE ================== */
async function heartbeatPresence(){
  await rtdbPut(PATH_PRES, Date.now());
}
heartbeatPresence();
setInterval(heartbeatPresence, 5000);

/* ================== SESSION SISWA ================== */
function getSession(){ return JSON.parse(localStorage.getItem("hh_student") || "null"); }
function saveSession(s){ localStorage.setItem("hh_student", JSON.stringify(s)); }

/* ================== QUIZ ================== */
const quiz = [
 {q:"Evaporasi adalah...",o:["Hujan","Penguapan","Awan"],a:1},
 {q:"Hujan disebut...",o:["Evaporasi","Presipitasi","Kondensasi"],a:1},
 {q:"Awan terbentuk karena...",o:["Kondensasi","Hujan","Aliran"],a:0},
 {q:"PLTMH adalah...",o:["Tenaga uap","Tenaga air","Tenaga angin"],a:1},
 {q:"Air mengalir ke sungai disebut...",o:["Aliran","Uap","Awan"],a:0},
 {q:"Banjir terjadi karena...",o:["Air berlebih","Air habis","Angin"],a:0},
 {q:"Siklus air dimulai dari...",o:["Penguapan","Hujan","Awan"],a:0},
 {q:"Energi air digunakan untuk...",o:["Mainan","Listrik","Makanan"],a:1},
 {q:"Uap air naik karena...",o:["Panas","Hujan","Es"],a:0},
 {q:"Air penting bagi...",o:["Manusia","Hewan","Semua"],a:2},
];

const materi = [
 "Evaporasi: air menguap karena panas matahari.",
 "Kondensasi: uap air berubah menjadi awan.",
 "Presipitasi: hujan turun ke bumi."
];

/* ================== UI STATE ================== */
let page="home";
let belajarStep=0;
let quizIndex=0;
let score=0;

/* ================== DEVICE STATE ================== */
let telem = null;
let seq = 0;

async function sendCmd(patch){
  seq++;
  await rtdbPatch(PATH_CMD, {seq, ts: Date.now(), ...patch});
}

/* ================== POLL TELEMETRY ================== */
async function pollTelem(){
  try{
    telem = await rtdbGet(PATH_TELEM);
    // refresh UI jika lagi di diorama/home/guru
    if(page==="diorama" || page==="home" || page==="guru") render();
  }catch(e){
    // biarin, jangan bikin UI mati
  }
}
pollTelem();
setInterval(pollTelem, 1000);

/* ================== ONLINE COUNT ================== */
let onlineCount = 0;
async function pollOnline(){
  try{
    const o = await rtdbGet("/online");
    const now = Date.now();
    let n=0;
    if(o){
      Object.keys(o).forEach(k=>{
        if(now - (o[k]?.ts||0) < 15000) n++;
      });
    }
    onlineCount = n;
    if(page==="home") render();
  }catch(e){}
}
pollOnline();
setInterval(pollOnline, 3000);

/* ================== RENDER ================== */
function render(){
  const app = document.getElementById("app");
  app.innerHTML = "";

  if(page==="home"){
    const version = telem?.version || "-";
    const c = document.createElement("div");
    c.className="card";
    c.innerHTML = `
      <div class="badge">ğŸ‘¥ Online: <span id="on">${onlineCount}</span></div>
      <div class="small">Versi perangkat: <b>${version}</b></div>
      <button id="mBelajar">ğŸ’ BELAJAR</button>
      <button id="mKuis">ğŸ“ KUIS</button>
      <button id="mDiorama">ğŸ¥ DIORAMA</button>
      <button id="mGuru">ğŸ‘©â€ğŸ« GURU</button>
    `;
    app.appendChild(c);

    document.getElementById("mBelajar").onclick=()=>{ belajarStep=0; page="belajar"; render(); };
    document.getElementById("mKuis").onclick=()=>{ page="data"; render(); };
    document.getElementById("mDiorama").onclick=()=>{ page="diorama"; render(); };
    document.getElementById("mGuru").onclick=()=>{ page="guru"; render(); };
  }

  if(page==="belajar"){
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ“˜ Belajar Siklus Air</h3>
        <p>${materi[belajarStep] || "Selesai ğŸ‰"}</p>
        <button id="nextBelajar">LANJUT â¡</button>
      </div>`;
    document.getElementById("nextBelajar").onclick=()=>{
      belajarStep++;
      if(belajarStep>=materi.length) page="home";
      render();
    };
  }

  if(page==="data"){
    const s=getSession()||{};
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ§’ Data Siswa</h3>
        <input id="nm" placeholder="Nama" value="${s.name||""}">
        <input id="kl" placeholder="Kelas" value="${s.kelas||""}">
        <button id="btnStartQuiz">Mulai Kuis</button>
      </div>`;
    document.getElementById("btnStartQuiz").onclick=()=>{
      const name = document.getElementById("nm").value.trim();
      const kelas = document.getElementById("kl").value.trim();
      if(!name || !kelas){ alert("Isi nama dan kelas dulu ya ğŸ™‚"); return; }
      saveSession({name, kelas, score:null});
      quizIndex=0; score=0; page="quiz"; render();
    };
  }

  if(page==="quiz"){
    const q=quiz[quizIndex];
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML = `<h3>${quizIndex+1}. ${q.q}</h3>`;
    q.o.forEach((opt,i)=>{
      const b=document.createElement("button");
      b.className="secondary";
      b.textContent = opt;
      b.onclick=()=>{
        if(i===q.a) score++;
        quizIndex++;
        if(quizIndex>=quiz.length){
          const s=getSession()||{};
          s.score = {score, total: quiz.length};
          saveSession(s);
          page="hasil";
        }
        render();
      };
      c.appendChild(b);
    });
    app.appendChild(c);
  }

  if(page==="hasil"){
    const s=getSession();
    const sc = s?.score ? `${s.score.score}/${s.score.total}` : "-";
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ‰ Hasil Kuis</h3>
        <div class="small">${s?.name||"-"} (${s?.kelas||"-"})</div>
        <h2 style="margin:10px 0">${sc}</h2>
        <button id="done">Selesai</button>
      </div>`;
    document.getElementById("done").onclick=()=>{ page="home"; render(); };
  }

  if(page==="diorama"){
    const percent = (telem?.ultra_percent ?? "-");
    const flow = (telem?.flow_lpm ?? "-");
    const A = !!telem?.outA, B = !!telem?.outB, Cc = !!telem?.outC, Dd = !!telem?.outD;
    const LD = !!telem?.lampuDesa, P2 = !!telem?.pompa2;

    app.innerHTML = `
      <div class="card">
        <h3>ğŸ¥ Diorama (Online)</h3>
        <div class="kv">
          <div><b>Ultrasonic</b><br><span class="small">${percent}%</span></div>
          <div><b>Flow</b><br><span class="small">${flow} L/menit</span></div>
          <div><b>Output</b><br><span class="small">A:${A?"ON":"OFF"} B:${B?"ON":"OFF"} C:${Cc?"ON":"OFF"} D:${Dd?"ON":"OFF"}</span></div>
          <div><b>Tambahan</b><br><span class="small">Lampu Desa:${LD?"ON":"OFF"} Pompa2:${P2?"ON":"OFF"}</span></div>
        </div>

        <div class="row">
          <button id="bA">Evaporasi (A)</button>
          <button id="bB">Kondensasi (B)</button>
          <button id="bC">Presipitasi (C)</button>
          <button id="bD">Banjir (D)</button>
        </div>
        <div class="row">
          <button id="bOff" class="warn">MATIKAN SEMUA</button>
          <button id="bMode" class="secondary">Ganti Mode</button>
        </div>
        <div class="small" style="margin-top:10px">
          Kalau ESP32 belum dihubungkan, tombol tetap mengirim command ke Firebase.
        </div>
      </div>
    `;

    // ini event handler yang pasti nempel (dibuat setelah DOM ada)
    document.getElementById("bA").onclick=()=>sendCmd({k:"A"});
    document.getElementById("bB").onclick=()=>sendCmd({k:"B"});
    document.getElementById("bC").onclick=()=>sendCmd({k:"C"});
    document.getElementById("bD").onclick=()=>sendCmd({k:"D"});
    document.getElementById("bOff").onclick=()=>sendCmd({k:"ALLOFF"});
    document.getElementById("bMode").onclick=()=>{
      const next = (telem?.mode==="manual") ? "auto" : "manual";
      sendCmd({mode: next});
    };
  }

  if(page==="guru"){
    const s=getSession();
    const sc = s?.score ? `${s.score.score}/${s.score.total}` : "-";
    app.innerHTML = `
      <div class="card">
        <h3>ğŸ‘©â€ğŸ« Monitoring Guru</h3>
        <div class="small">IP pengunjung dimatikan.</div>
        <div class="kv" style="margin-top:10px">
          <div><b>Online</b><br><span class="small">${onlineCount} orang</span></div>
          <div><b>Skor terakhir</b><br><span class="small">${sc}</span></div>
          <div><b>Versi</b><br><span class="small">${telem?.version || "NISEEF v12"}</span></div>
          <div><b>Status</b><br><span class="small">${telem?.status || "-"}</span></div>
        </div>
      </div>
    `;
  }
}

/* ================== HOME BUTTON ================== */
document.getElementById("btnHome").onclick=()=>{ page="home"; render(); };

/* ================== INIT ================== */
render();
</script>

</body>
</html>
