<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hidrologi Heroes â€“ Lacak si Tirta, Air Ajaib</title>

<style>
  :root{
    --bg1:#eaf3ff;
    --bg2:#fff1f7;
    --card:#ffffff;
    --ink:#0d2b45;
    --muted:#4b647a;
    --shadow:0 10px 22px rgba(0,0,0,.10);
    --r:20px;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Arial;
    color:var(--ink);
    background:
      radial-gradient(900px 500px at 15% 0%, #cfe7ff 0%, transparent 60%),
      radial-gradient(900px 500px at 85% 0%, #ffd4e6 0%, transparent 60%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
    min-height:100vh;
  }

  header{
    position:sticky; top:0; z-index:10;
    background: linear-gradient(90deg, #4da3ff, #ff6fb1);
    color:#fff;
    padding:12px 14px;
    box-shadow:0 6px 14px rgba(0,0,0,.12);
  }

  .head{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    max-width:980px; margin:0 auto;
  }

  .brand{display:flex; align-items:center; gap:10px;}
  .logo{
    width:46px; height:46px; border-radius:16px;
    background: rgba(255,255,255,.20);
    display:grid; place-items:center;
    border:1px solid rgba(255,255,255,.35);
    overflow:hidden;
  }
  .logo img{width:100%; height:100%; object-fit:cover}
  .title h1{margin:0;font-size:18px;line-height:1.1}
  .title div{font-size:12px;opacity:.95}

  .badges{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
  .badge{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px;
    border-radius:999px;
    font-weight:800;
    font-size:13px;
    border:1px solid rgba(255,255,255,.40);
    background: rgba(255,255,255,.28);
    color:#08304f;
  }
  .badge small{font-weight:700; opacity:.9}

  main{
    max-width:980px;
    margin:0 auto;
    padding:16px;
    padding-bottom:110px;
  }

  .grid{
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap:12px;
  }

  .card{
    background:var(--card);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    padding:16px;
    border:1px solid rgba(13,43,69,.08);
  }

  .hero{
    grid-column: span 12;
    padding:16px;
    background:
      radial-gradient(700px 220px at 20% 0%, rgba(255,255,255,.55) 0%, transparent 70%),
      linear-gradient(135deg, rgba(255,255,255,.35), rgba(255,255,255,.12));
    border:1px solid rgba(255,255,255,.35);
  }

  .heroRow{
    display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
  }

  .mini{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.35}

  .ctaRow{
    display:grid;
    grid-template-columns: repeat(2, 1fr);
    gap:10px;
    margin-top:12px;
  }
  @media (max-width:700px){
    .ctaRow{grid-template-columns: 1fr;}
  }

  .btn{
    border:none;
    cursor:pointer;
    border-radius:18px;
    padding:14px 14px;
    font-size:16px;
    font-weight:900;
    color:#fff;
    box-shadow:0 10px 18px rgba(0,0,0,.12);
    transition: transform .08s ease, filter .08s ease;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .btn:active{transform: scale(.98)}
  .btn span{display:inline-flex; align-items:center; gap:10px}
  .btn i{font-style:normal; font-size:18px}

  .b-blue{ background: linear-gradient(135deg, #2a7fff, #53d5ff); }
  .b-pink{ background: linear-gradient(135deg, #ff4fa3, #ff9ed0); }
  .b-green{background: linear-gradient(135deg, #20c997, #87f5d0); }
  .b-orange{background: linear-gradient(135deg, #ff9800, #ffd36a); }
  .b-purple{background: linear-gradient(135deg, #7c4dff, #caa8ff); }
  .b-red{background: linear-gradient(135deg, #ff3d3d, #ff8f8f); }

  .pill{
    border:none;
    padding:10px 12px;
    border-radius:999px;
    font-weight:900;
    cursor:pointer;
    background:#ffffff;
    border:1px solid rgba(13,43,69,.12);
    color:var(--ink);
    box-shadow:0 6px 12px rgba(0,0,0,.06);
  }
  .pill:active{transform:scale(.99)}
  .pill.primary{
    background: linear-gradient(135deg, #2a7fff, #53d5ff);
    color:#fff; border:none;
  }

  .h2{margin:0 0 8px;font-size:18px}

  .subgrid{
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap:12px;
  }

  .topic{
    grid-column: span 6;
    padding:14px;
    border-radius:18px;
    box-shadow:var(--shadow);
    border:1px solid rgba(13,43,69,.08);
    background:#fff;
    cursor:pointer;
  }
  @media (max-width:820px){
    .topic{grid-column:span 12;}
  }

  .topicHead{display:flex; gap:12px; align-items:center;}
  .pic{
    width:72px; height:72px; border-radius:18px;
    display:grid; place-items:center;
    border:1px solid rgba(13,43,69,.10);
    overflow:hidden;
    background:#fff;
  }
  .pic img{width:100%; height:100%; object-fit:cover}
  .topic h3{margin:0;font-size:16px}
  .topic p{margin:8px 0 0;color:var(--muted);line-height:1.45;font-size:13px}

  .qCard{
    display:grid;
    grid-template-columns: 160px 1fr;
    gap:12px;
    align-items:stretch;
  }
  @media (max-width:720px){
    .qCard{grid-template-columns: 1fr;}
  }
  .qImg{
    border-radius:18px;
    overflow:hidden;
    border:1px solid rgba(13,43,69,.10);
    background:#fff;
    box-shadow:0 10px 18px rgba(0,0,0,.10);
    min-height:130px;
  }
  .qImg img{width:100%; height:100%; object-fit:cover}

  .choices{display:grid;grid-template-columns:1fr;gap:10px;}
  .choiceBtn{
    width:100%;
    text-align:left;
    padding:12px 14px;
    border-radius:16px;
    border:1px solid rgba(13,43,69,.12);
    background:#fff;
    cursor:pointer;
    font-weight:900;
    box-shadow:0 8px 14px rgba(0,0,0,.06);
  }
  .choiceBtn:active{transform:scale(.99)}
  .choiceBtn small{font-weight:800; opacity:.85}
  .choiceBtn.good{border-color:rgba(32,201,151,.55); background:rgba(32,201,151,.10)}
  .choiceBtn.bad{border-color:rgba(255,61,61,.55); background:rgba(255,61,61,.08)}

  .quizTop{
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  }
  .progress{display:flex; align-items:center; gap:10px; font-weight:900;}
  .bar{
    width:160px; height:10px; border-radius:999px; overflow:hidden;
    background: rgba(13,43,69,.10);
  }
  .bar > div{
    height:100%; width:0%;
    background: linear-gradient(90deg, #20c997, #53d5ff);
  }

  /* footer */
  .footer{
    position:fixed; left:0; right:0; bottom:0;
    background: rgba(255,255,255,.88);
    backdrop-filter: blur(10px);
    border-top:1px solid rgba(13,43,69,.08);
    padding:10px 12px;
    display:flex; gap:10px; justify-content:center;
    z-index:9;
  }

  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:94px; background:#111; color:#fff;
    padding:10px 14px; border-radius:999px;
    font-size:13px; opacity:0; pointer-events:none;
    transition:opacity .2s;
    z-index:10;
  }
  .toast.on{opacity:.9}

  /* ================= Tirta draggable ================= */
  .guide{
    position:fixed;
    right:14px;
    bottom:112px;
    display:flex;
    align-items:flex-end;
    gap:10px;
    z-index:20;
    user-select:none;
    touch-action:none; /* penting biar drag di HP gak scroll */
  }
  /* bubble bisa diklik untuk hide/show, tapi tidak menghalangi klik konten (kita taruh pointer hanya di elemen) */
  .bubble{
    max-width:220px;
    background:rgba(255,255,255,.92);
    border:1px solid rgba(13,43,69,.10);
    border-radius:18px;
    padding:10px 12px;
    box-shadow:0 10px 18px rgba(0,0,0,.10);
    color:var(--ink);
    font-weight:900;
    font-size:12px;
    line-height:1.25;
    pointer-events:auto;
    cursor:pointer;
  }
  .bubble small{display:block; margin-top:6px; font-weight:800; opacity:.8}
  .guide img{
    width:64px; height:64px; border-radius:22px;
    background:#fff;
    border:1px solid rgba(13,43,69,.12);
    box-shadow:0 10px 18px rgba(0,0,0,.12);
    object-fit:cover;
    pointer-events:auto;
    cursor:grab;
  }
  .guide.dragging img{cursor:grabbing}
  .hideBubble .bubble{display:none}

  .floatTools{
    position:fixed;
    left:14px;
    bottom:112px;
    z-index:20;
    display:flex;
    gap:8px;
  }
  .miniBtn{
    border:none;
    cursor:pointer;
    border-radius:999px;
    padding:10px 12px;
    font-weight:1000;
    background:rgba(255,255,255,.92);
    border:1px solid rgba(13,43,69,.12);
    box-shadow:0 10px 18px rgba(0,0,0,.10);
  }
</style>
</head>

<body>
<header>
  <div class="head">
    <div class="brand">
      <div class="logo"><img id="tirtaLogo" alt="Tirta"></div>
      <div class="title">
        <h1>Hidrologi Heroes</h1>
        <div>Lacak si Tirta, Air Ajaib</div>
      </div>
    </div>

    <div class="badges">
      <button class="badge" id="btnMusic" title="Play/Pause musik" style="cursor:pointer">
        ğŸµ <small id="musicLabel">Play</small>
      </button>
      <div class="badge">ğŸ‘¥ <small>Online:</small> <span id="hdrOnline">0</span></div>
      <div class="badge">ğŸ§  <small>Versi:</small> <span id="hdrVer">-</span></div>
    </div>
  </div>
</header>

<main id="app"></main>

<div class="footer">
  <button class="pill" id="btnBack">â¬… Back</button>
  <button class="pill primary" id="btnHome">ğŸ  Home</button>
  <button class="pill" id="btnNext">Next â¡</button>
</div>

<div id="toast" class="toast">OK</div>

<!-- tools kecil -->
<div class="floatTools">
  <button class="miniBtn" id="btnResetTirta" title="Kembalikan posisi Tirta">ğŸ’§ Reset Tirta</button>
</div>

<!-- Tirta Draggable -->
<div class="guide" id="guide">
  <div class="bubble" id="guideText" title="Klik untuk sembunyikan/tampilkan chat">
    Hai! Aku Tirta ğŸ’§ Klik menu yang kamu mau ya!
    <small>(drag aku kalau nutup tombol)</small>
  </div>
  <img id="tirtaGuide" alt="Tirta Guide">
</div>

<audio id="bgm" preload="auto" loop></audio>

<script>
/* ================== ASSET URLS (RAW GitHub) ================== */
const ASSETS_BASE = "https://raw.githubusercontent.com/loncengid/Hidrologi-Heroes-Assets/main/";
const IMG_TIRTA   = ASSETS_BASE + "karakter%20tirta.png";
const IMG_BANJIR  = ASSETS_BASE + "Scene%20Banjir.png";
const IMG_EVAP    = ASSETS_BASE + "Scene%20Evaporasi.png";
const IMG_KOND    = ASSETS_BASE + "Scene%20Kondensasi.png";
const IMG_PLTMH   = ASSETS_BASE + "Scene%20PLTMH.png";
const IMG_QR      = ASSETS_BASE + "qrcode%20yt%20channel%20aksa%20swastika.png";
const AUDIO_BGM   = ASSETS_BASE + "audio%20niseef.mp3";

/* set Tirta images + audio */
document.getElementById("tirtaLogo").src  = IMG_TIRTA;
document.getElementById("tirtaGuide").src = IMG_TIRTA;

const bgm = document.getElementById("bgm");
bgm.src = AUDIO_BGM;
bgm.volume = 0.35;

let musicOn = false;
async function toggleMusic(){
  try{
    if(!musicOn){
      await bgm.play();
      musicOn = true;
      document.getElementById("musicLabel").textContent = "Pause";
      toast("ğŸµ Musik ON");
    }else{
      bgm.pause();
      musicOn = false;
      document.getElementById("musicLabel").textContent = "Play";
      toast("ğŸ”‡ Musik OFF");
    }
  }catch(e){
    toast("âš ï¸ Browser blokir audio. Klik lagi ya.");
  }
}
document.getElementById("btnMusic").onclick = toggleMusic;

/* ================== Tirta draggable + persist ================== */
const guide = document.getElementById("guide");
const bubble = document.getElementById("guideText");
const tirta = document.getElementById("tirtaGuide");
const STORAGE_POS = "hh_tirta_pos";
const STORAGE_BUB = "hh_tirta_bubble_hidden";

function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

function applySavedTirtaPos(){
  const raw = localStorage.getItem(STORAGE_POS);
  if(!raw) return;
  try{
    const p = JSON.parse(raw);
    if(typeof p?.x !== "number" || typeof p?.y !== "number") return;
    guide.style.left = p.x + "px";
    guide.style.top  = p.y + "px";
    guide.style.right = "auto";
    guide.style.bottom = "auto";
  }catch(e){}
}
function saveTirtaPos(x,y){
  localStorage.setItem(STORAGE_POS, JSON.stringify({x,y}));
}
function resetTirta(){
  localStorage.removeItem(STORAGE_POS);
  guide.style.left = "";
  guide.style.top  = "";
  guide.style.right = "14px";
  guide.style.bottom = "112px";
  guide.style.position = "fixed";
  toast("ğŸ’§ Tirta balik ke posisi awal");
}
document.getElementById("btnResetTirta").onclick = resetTirta;

function applyBubbleHidden(){
  const hidden = localStorage.getItem(STORAGE_BUB) === "1";
  guide.classList.toggle("hideBubble", hidden);
}
bubble.onclick = ()=>{
  const nowHidden = !guide.classList.contains("hideBubble");
  guide.classList.toggle("hideBubble", nowHidden);
  localStorage.setItem(STORAGE_BUB, nowHidden ? "1" : "0");
};

applySavedTirtaPos();
applyBubbleHidden();

let dragging = false;
let startX=0, startY=0, baseX=0, baseY=0;

function getGuideXY(){
  const r = guide.getBoundingClientRect();
  return {x: r.left, y: r.top, w:r.width, h:r.height};
}

function onDragStart(clientX, clientY){
  dragging = true;
  guide.classList.add("dragging");
  const g = getGuideXY();
  startX = clientX;
  startY = clientY;
  baseX = g.x;
  baseY = g.y;
}

function onDragMove(clientX, clientY){
  if(!dragging) return;
  const dx = clientX - startX;
  const dy = clientY - startY;

  const g = getGuideXY();
  const w = g.w, h = g.h;

  const maxX = window.innerWidth  - w - 6;
  const maxY = window.innerHeight - h - 96; // hindari nutup footer

  let nx = clamp(baseX + dx, 6, maxX);
  let ny = clamp(baseY + dy, 6, maxY);

  guide.style.left = nx + "px";
  guide.style.top  = ny + "px";
  guide.style.right = "auto";
  guide.style.bottom = "auto";

  saveTirtaPos(nx, ny);
}

function snapToEdge(){
  if(!localStorage.getItem(STORAGE_POS)) return;
  const g = getGuideXY();
  const edge = (g.x + g.w/2 < window.innerWidth/2) ? 6 : (window.innerWidth - g.w - 6);
  guide.style.left = edge + "px";
  guide.style.right = "auto";
  saveTirtaPos(edge, g.y);
}

function onDragEnd(){
  if(!dragging) return;
  dragging = false;
  guide.classList.remove("dragging");
  snapToEdge(); // rapihin ke tepi terdekat
}

/* drag pakai pointer events (support mouse + touch) */
tirta.addEventListener("pointerdown", (e)=>{
  e.preventDefault();
  tirta.setPointerCapture(e.pointerId);
  onDragStart(e.clientX, e.clientY);
});
tirta.addEventListener("pointermove", (e)=>{
  onDragMove(e.clientX, e.clientY);
});
tirta.addEventListener("pointerup", ()=>{
  onDragEnd();
});
tirta.addEventListener("pointercancel", ()=>{
  onDragEnd();
});
window.addEventListener("resize", ()=>{
  // jaga agar posisi tidak keluar layar saat resize
  const raw = localStorage.getItem(STORAGE_POS);
  if(!raw) return;
  try{
    const p = JSON.parse(raw);
    const g = getGuideXY();
    const maxX = window.innerWidth  - g.w - 6;
    const maxY = window.innerHeight - g.h - 96;
    const nx = clamp(p.x, 6, maxX);
    const ny = clamp(p.y, 6, maxY);
    guide.style.left = nx + "px";
    guide.style.top  = ny + "px";
    saveTirtaPos(nx, ny);
  }catch(e){}
});

/* ================== KONFIG RTDB (REST) ================== */
const DB_BASE  = "https://hidrologi-heroes-default-rtdb.asia-southeast1.firebasedatabase.app";
const DEVICE_ID = "niseef_v12_01";
const PATH_CMD   = `/devices/${DEVICE_ID}/cmd`;
const PATH_TELEM = `/devices/${DEVICE_ID}/telemetry`;
const PATH_PRES  = `/devices/${DEVICE_ID}/presence/lastActiveMs`;

/* =============== HELPERS REST =============== */
async function rtdbGet(path){
  const res = await fetch(`${DB_BASE}${path}.json`, { cache:"no-store" });
  return await res.json();
}
async function rtdbPut(path, obj){
  await fetch(`${DB_BASE}${path}.json`, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(obj)
  });
}
async function rtdbPatch(path, obj){
  await fetch(`${DB_BASE}${path}.json`, {
    method:"PATCH",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(obj)
  });
}

/* ================== TOAST ================== */
let toastT=null;
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("on");
  clearTimeout(toastT);
  toastT=setTimeout(()=>t.classList.remove("on"),900);
}

/* ================== ONLINE COUNTER ================== */
const cid = "c_" + Math.random().toString(36).slice(2);
let onlineCount = 0;
async function heartbeatOnline(){
  try{ await rtdbPatch(`/online/${cid}`, { ts: Date.now() }); }catch(e){}
}
heartbeatOnline();
setInterval(heartbeatOnline, 5000);

async function pollOnline(){
  try{
    const o = await rtdbGet("/online");
    const now = Date.now();
    let n=0;
    if(o){
      for(const k in o){
        if(now - (o[k]?.ts||0) < 15000) n++;
      }
    }
    onlineCount = n;
    document.getElementById("hdrOnline").textContent = onlineCount;
  }catch(e){}
}
pollOnline();
setInterval(pollOnline, 3000);

/* ================== PRESENCE KE DEVICE ================== */
async function heartbeatPresence(){
  try{ await rtdbPut(PATH_PRES, Date.now()); }catch(e){}
}
heartbeatPresence();
setInterval(heartbeatPresence, 5000);

/* ================== DEVICE STATE ================== */
let telem = null;
let seq = 0;
async function sendCmd(patch){
  seq++;
  try{
    await rtdbPatch(PATH_CMD, { seq, ts: Date.now(), ...patch });
    toast("âœ… Terkirim ke perangkat");
  }catch(e){
    toast("âš ï¸ Gagal kirim");
  }
}
async function pollTelem(){
  try{
    telem = await rtdbGet(PATH_TELEM);
    document.getElementById("hdrVer").textContent = telem?.version || "-";
    if(page==="diorama") updateDioramaUI();
  }catch(e){}
}
pollTelem();
setInterval(pollTelem, 1000);

/* ================== NAV STATE ================== */
let page = "home";
let historyStack = ["home"];

function setGuide(text){
  // jika bubble disembunyikan, tetap update text (nanti kalau ditampilkan sudah update)
  document.getElementById("guideText").childNodes[0].textContent = text + " ";
}
function go(p){
  if(page !== p){
    historyStack.push(p);
    page = p;
    render();
  }
}
function back(){
  if(historyStack.length > 1){
    historyStack.pop();
    page = historyStack[historyStack.length-1];
    render();
  } else {
    page="home"; render();
  }
}

/* ================== SESSION SISWA ================== */
function getSession(){ return JSON.parse(localStorage.getItem("hh_student") || "null"); }
function saveSession(s){ localStorage.setItem("hh_student", JSON.stringify(s)); }

/* ================== SVG fallback (Presipitasi belum ada asset PNG) ================== */
function svgData(svg){
  return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}
function imgPres(){
  return svgData(`
  <svg xmlns="http://www.w3.org/2000/svg" width="220" height="180">
    <rect width="100%" height="100%" fill="#fff7e8"/>
    <g fill="#ffffff" stroke="#ffe0a3" stroke-width="2">
      <ellipse cx="110" cy="62" rx="52" ry="28"/>
      <ellipse cx="78" cy="68" rx="34" ry="22"/>
      <ellipse cx="148" cy="70" rx="36" ry="24"/>
    </g>
    <g fill="#2a7fff">
      <path d="M70 110 C80 95 90 95 95 110 C90 120 80 122 70 110Z"/>
      <path d="M105 112 C115 97 125 97 130 112 C125 122 115 124 105 112Z"/>
      <path d="M140 110 C150 95 160 95 165 110 C160 120 150 122 140 110Z"/>
    </g>
    <rect x="0" y="138" width="220" height="42" fill="#cfe7ff"/>
    <text x="14" y="26" font-family="Arial" font-weight="900" font-size="16" fill="#0d2b45">Presipitasi</text>
  </svg>`);
}

/* ================== BANK SOAL (BERGAMBAR) ================== */
const QUESTION_BANK = [
  { img: IMG_EVAP,  q:"Apa yang disebut evaporasi?", o:["Air berubah jadi es","Air menguap karena panas","Awan turun jadi hujan"], a:1 },
  { img: IMG_KOND,  q:"Kondensasi itu terjadi saat...", o:["Uap air jadi awan","Hujan jadi sungai","Air jadi batu"], a:0 },
  { img: imgPres(), q:"Presipitasi adalah...", o:["Air menguap","Awan terbentuk","Hujan turun ke bumi"], a:2 },
  { img: IMG_BANJIR, q:"Banjir biasanya terjadi karena...", o:["Air berlebih dan meluap","Air menguap habis","Awan hilang"], a:0 },
  { img: IMG_EVAP,  q:"Sumber energi yang memicu evaporasi adalah...", o:["Matahari","Bulan","Bintang jatuh"], a:0 },
  { img: IMG_KOND,  q:"Awan terbentuk dari...", o:["Tanah kering","Uap air yang berkumpul","Batu kecil"], a:1 },
  { img: imgPres(), q:"Setelah hujan turun, air biasanya...", o:["Naik ke langit lagi langsung","Mengalir ke sungai/laut","Berubah jadi api"], a:1 },
  { img: IMG_BANJIR, q:"Cara mengurangi risiko banjir adalah...", o:["Buang sampah ke sungai","Menjaga saluran air bersih","Menutup semua pohon"], a:1 },
  { img: IMG_PLTMH, q:"PLTMH itu singkatan dari...", o:["Pembangkit Listrik Tenaga Mikrohidro","Pabrik Lampu Tengah Malam","Perahu Listrik Tenaga Matahari"], a:0 },
  { img: IMG_PLTMH, q:"PLTMH memanfaatkan energi dari...", o:["Angin","Arus air","Pasir"], a:1 },
  { img: IMG_EVAP,  q:"Contoh evaporasi di rumah adalah...", o:["Air jemuran kering","Es membeku","Kipas angin berputar"], a:0 },
  { img: IMG_KOND,  q:"Contoh kondensasi yang mudah dilihat adalah...", o:["Embun di gelas dingin","Air mendidih","Batu panas"], a:0 },
  { img: IMG_BANJIR, q:"Saat banjir, tindakan aman adalah...", o:["Main air deras","Naik ke tempat lebih tinggi","Menyentuh kabel listrik"], a:1 },
  { img: imgPres(), q:"Presipitasi bisa berupa...", o:["Hujan","Uap","Batu"], a:0 },
];

/* ================== QUIZ STATE ================== */
let quizSet = [];
let quizIdx = 0;
let quizScore = 0;
let quizLocked = false;

function pick10Random(){
  const arr = QUESTION_BANK.slice();
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr.slice(0, 10);
}

/* ================== PAGES RENDER ================== */
function render(){
  const app = document.getElementById("app");
  app.innerHTML = "";

  if(page==="home"){
    setGuide("Hai! Aku Tirta ğŸ’§ Klik menu yang kamu mau ya! (Kalau nutup tombol, drag aku ğŸ˜„)");
    app.innerHTML = `
      <div class="grid">
        <div class="card hero">
          <div class="heroRow">
            <div>
              <div class="h2">Halo! Aku Tirta ğŸ’§</div>
              <div class="mini">Yuk belajar siklus air + banjir + PLTMH dengan cara yang seru!</div>
            </div>
            <div class="badges">
              <div class="badge">ğŸ‘¥ <small>Online:</small> <span>${onlineCount}</span></div>
              <div class="badge">ğŸ“¡ <small>Device:</small> <span>${telem?.version || "-"}</span></div>
            </div>
          </div>

          <div class="ctaRow">
            <button class="btn b-blue" id="mProyek"><span><i>ğŸ“š</i> Penjelasan Proyek</span><span>â¡</span></button>
            <button class="btn b-pink" id="mSiswa"><span><i>ğŸ§’</i> Siswa</span><span>â¡</span></button>
            <button class="btn b-green" id="mGuru"><span><i>ğŸ‘©â€ğŸ«</i> Guru</span><span>â¡</span></button>
            <button class="btn b-orange" id="mDiorama"><span><i>ğŸ¥</i> Diorama</span><span>â¡</span></button>
          </div>

          <div style="height:12px"></div>

          <button class="btn b-purple" id="mKisah">
            <span><i>ğŸ“º</i> Kisah Perjalanan si Tirta, Air Ajaib</span><span>â¡</span>
          </button>

          <div class="mini">Tip: Menu bertingkat. Pakai tombol Back / Home / Next di bawah.</div>
        </div>
      </div>
    `;
    document.getElementById("mProyek").onclick = ()=>go("proyek");
    document.getElementById("mSiswa").onclick  = ()=>go("siswa");
    document.getElementById("mGuru").onclick   = ()=>go("guru");
    document.getElementById("mDiorama").onclick= ()=>go("diorama");
    document.getElementById("mKisah").onclick  = ()=>go("kisah");
  }

  if(page==="kisah"){
    setGuide("Scan QR ini ya! Nanti kamu bisa lihat kisah Tirta ğŸ™‚");
    app.innerHTML = `
      <div class="card">
        <div class="h2">ğŸ“º Kisah Perjalanan si Tirta, Air Ajaib</div>
        <div class="mini">Scan QR di bawah untuk menuju channel (YouTube).</div>
      </div>

      <div class="card">
        <div class="qCard">
          <div class="qImg"><img alt="QR" src="${IMG_QR}"></div>
          <div>
            <div style="font-weight:1000">Arahkan kamera HP ke QR ğŸ‘‰</div>
            <div class="mini">Kalau QR belum kebaca, coba zoom sedikit atau naikkan brightness layar.</div>
            <div style="height:10px"></div>
            <div class="mini"><b>Preview scene:</b></div>
            <div class="mini">Evaporasi, Kondensasi, Banjir, dan PLTMH.</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="h2" style="margin-bottom:10px">ğŸ–¼ï¸ Galeri</div>
        <div class="subgrid">
          <div class="topic" style="grid-column:span 6">
            <div class="topicHead">
              <div class="pic"><img alt="Evaporasi" src="${IMG_EVAP}"></div>
              <div><h3>Evaporasi</h3><div class="mini">Air naik jadi uap</div></div>
            </div>
          </div>
          <div class="topic" style="grid-column:span 6">
            <div class="topicHead">
              <div class="pic"><img alt="Kondensasi" src="${IMG_KOND}"></div>
              <div><h3>Kondensasi</h3><div class="mini">Uap jadi awan</div></div>
            </div>
          </div>
          <div class="topic" style="grid-column:span 6">
            <div class="topicHead">
              <div class="pic"><img alt="Banjir" src="${IMG_BANJIR}"></div>
              <div><h3>Banjir</h3><div class="mini">Air meluap</div></div>
            </div>
          </div>
          <div class="topic" style="grid-column:span 6">
            <div class="topicHead">
              <div class="pic"><img alt="PLTMH" src="${IMG_PLTMH}"></div>
              <div><h3>PLTMH</h3><div class="mini">Energi dari arus air</div></div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  if(page==="proyek"){
    setGuide("Pilih salah satu ya: Evaporasi, Kondensasi, Presipitasi, atau Banjir ğŸ™‚");
    app.innerHTML = `
      <div class="card">
        <div class="h2">ğŸ“š Penjelasan Proyek</div>
        <div class="mini">Pilih sub menu di bawah ya.</div>
      </div>

      <div class="subgrid">
        <div class="topic" id="pEv">
          <div class="topicHead">
            <div class="pic"><img alt="Evaporasi" src="${IMG_EVAP}"></div>
            <div><h3>Evaporasi</h3><div class="mini">Air menguap karena panas</div></div>
          </div>
        </div>

        <div class="topic" id="pKo">
          <div class="topicHead">
            <div class="pic"><img alt="Kondensasi" src="${IMG_KOND}"></div>
            <div><h3>Kondensasi</h3><div class="mini">Uap air jadi awan</div></div>
          </div>
        </div>

        <div class="topic" id="pPr">
          <div class="topicHead">
            <div class="pic"><img alt="Presipitasi" src="${imgPres()}"></div>
            <div><h3>Presipitasi</h3><div class="mini">Awan jenuh â†’ hujan turun</div></div>
          </div>
        </div>

        <div class="topic" id="pBa">
          <div class="topicHead">
            <div class="pic"><img alt="Banjir" src="${IMG_BANJIR}"></div>
            <div><h3>Banjir</h3><div class="mini">Air berlebih â†’ meluap</div></div>
          </div>
        </div>
      </div>
    `;

    document.getElementById("pEv").onclick = ()=>go("proyek_evaporasi");
    document.getElementById("pKo").onclick = ()=>go("proyek_kondensasi");
    document.getElementById("pPr").onclick = ()=>go("proyek_presipitasi");
    document.getElementById("pBa").onclick = ()=>go("proyek_banjir");
  }

  if(page==="proyek_evaporasi"){
    setGuide("Evaporasi = air naik jadi uap ğŸ’¨");
    app.innerHTML = proyekDetail(
      "Evaporasi",
      IMG_EVAP,
      "Evaporasi adalah proses saat air berubah menjadi uap karena panas matahari. Uap air naik ke atas dan memulai siklus air.",
      ["Air di laut/danau menguap", "Jemuran jadi kering", "Uap air naik ke langit"]
    );
  }

  if(page==="proyek_kondensasi"){
    setGuide("Kondensasi = uap jadi awan â˜ï¸");
    app.innerHTML = proyekDetail(
      "Kondensasi",
      IMG_KOND,
      "Kondensasi adalah proses saat uap air mendingin dan berkumpul menjadi titik-titik air kecil, lalu membentuk awan.",
      ["Uap air jadi awan", "Contoh: embun di gelas dingin", "Awan makin tebal kalau uap banyak"]
    );
  }

  if(page==="proyek_presipitasi"){
    setGuide("Presipitasi = hujan turun ğŸŒ§ï¸");
    app.innerHTML = proyekDetail(
      "Presipitasi",
      imgPres(),
      "Presipitasi adalah proses turunnya air dari awan ke bumi, seperti hujan. Ini terjadi saat awan sudah sangat jenuh.",
      ["Awan gelap â†’ hujan", "Air turun ke tanah", "Air mengalir ke sungai/laut"]
    );
  }

  if(page==="proyek_banjir"){
    setGuide("Banjir = air meluap. Yuk jaga lingkungan! â™»ï¸");
    app.innerHTML = proyekDetail(
      "Banjir",
      IMG_BANJIR,
      "Banjir terjadi saat air berlebih tidak tertampung sehingga sungai/saluran meluap. Bisa karena hujan deras, saluran tersumbat, atau resapan berkurang.",
      ["Jaga saluran air bersih", "Jangan buang sampah sembarangan", "Buat resapan/biopori"]
    );
  }

  if(page==="siswa"){
    setGuide("Isi nama + kelas dulu ya. Nanti skor kuisnya muncul â­");
    const s = getSession() || {};
    app.innerHTML = `
      <div class="card">
        <div class="h2">ğŸ§’ Menu Siswa</div>
        <div class="mini">Isi data dulu ya supaya kuisnya rapi.</div>
        <div style="height:10px"></div>

        <label class="mini"><b>Nama</b></label>
        <input id="nm" placeholder="contoh: Aulia" value="${escapeHtml(s.name||"")}" style="width:100%;padding:12px;border-radius:16px;border:1px solid rgba(13,43,69,.12)">

        <div style="height:8px"></div>
        <label class="mini"><b>Kelas</b></label>
        <input id="kl" placeholder="contoh: 5A" value="${escapeHtml(s.kelas||"")}" style="width:100%;padding:12px;border-radius:16px;border:1px solid rgba(13,43,69,.12)">

        <button class="btn b-pink" id="btnStart" style="margin-top:12px">
          <span><i>ğŸ“</i> Mulai Kuis Bergambar</span><span>â¡</span>
        </button>

        <div class="mini" style="margin-top:10px">
          Kuis: 10 soal acak, pilihan ganda, dengan gambar.
        </div>
      </div>
    `;
    document.getElementById("btnStart").onclick = ()=>{
      const name = document.getElementById("nm").value.trim();
      const kelas = document.getElementById("kl").value.trim();
      if(!name || !kelas){ alert("Isi nama dan kelas dulu ya ğŸ™‚"); return; }
      saveSession({name, kelas, score:null});

      quizSet = pick10Random();
      quizIdx = 0;
      quizScore = 0;
      quizLocked = false;
      go("quiz");
    };
  }

  if(page==="quiz"){
    renderQuiz(app);
  }

  if(page==="hasil"){
    setGuide("Keren! Mau coba lagi? balik ke Home lalu masuk menu Siswa ğŸ˜„");
    const s=getSession()||{};
    const sc = s?.score ? `${s.score.score}/${s.score.total}` : "-";
    app.innerHTML = `
      <div class="card">
        <div class="h2">ğŸ‰ Hasil Kuis</div>
        <div class="mini"><b>${escapeHtml(s.name||"-")}</b> (Kelas ${escapeHtml(s.kelas||"-")})</div>
        <div style="height:10px"></div>

        <div class="card" style="box-shadow:none;border:1px dashed rgba(13,43,69,.18);background:rgba(255,255,255,.65)">
          <div style="font-size:44px;font-weight:1000">â­ ${sc} â­</div>
          <div class="mini">Hebat! Kamu bisa belajar lagi lewat Penjelasan Proyek juga ya.</div>
        </div>
      </div>
    `;
  }

  if(page==="guru"){
    setGuide("Menu Guru: monitoring sederhana. IP pengunjung dimatikan sesuai request Boss.");
    const s=getSession();
    const sc = s?.score ? `${s.score.score}/${s.score.total}` : "-";
    app.innerHTML = `
      <div class="card">
        <div class="h2">ğŸ‘©â€ğŸ« Menu Guru</div>
        <div class="mini">Monitoring sederhana.</div>

        <div style="height:10px"></div>
        <div class="grid">
          <div class="card" style="grid-column:span 6;background:linear-gradient(135deg,rgba(42,127,255,.10),rgba(83,213,255,.08))">
            <div style="font-weight:1000;font-size:16px">ğŸ‘¥ Online</div>
            <div style="font-size:32px;font-weight:1000;margin-top:6px">${onlineCount}</div>
            <div class="mini">Pengunjung aktif (â‰ˆ 15 detik terakhir)</div>
          </div>
          <div class="card" style="grid-column:span 6;background:linear-gradient(135deg,rgba(255,79,163,.10),rgba(255,158,208,.08))">
            <div style="font-weight:1000;font-size:16px">ğŸ“ Skor terakhir (browser ini)</div>
            <div style="font-size:32px;font-weight:1000;margin-top:6px">${sc}</div>
            <div class="mini">Sementara tersimpan lokal</div>
          </div>
        </div>
      </div>
    `;
  }

  if(page==="diorama"){
    setGuide("Diorama: tombol besar biar gampang dipencet. Perintah dikirim ke Firebase â†’ ESP32.");
    app.innerHTML = `
      <div class="card">
        <div class="h2">ğŸ¥ Diorama</div>
        <div class="mini">Klik tombol proses siklus air. Perintah dikirim ke Firebase, lalu ESP32 mengeksekusi.</div>
      </div>

      <div class="card">
        <div class="grid">
          <div class="card" style="grid-column:span 6;background:linear-gradient(135deg,rgba(42,127,255,.10),rgba(83,213,255,.08))">
            <div style="font-weight:1000">ğŸ“ Ultrasonic</div>
            <div id="uPct" style="font-size:34px;font-weight:1000;margin-top:6px">- %</div>
            <div class="mini">Tinggi air (persen)</div>
          </div>
          <div class="card" style="grid-column:span 6;background:linear-gradient(135deg,rgba(32,201,151,.10),rgba(135,245,208,.08))">
            <div style="font-weight:1000">ğŸ’¦ Flow</div>
            <div id="fLpm" style="font-size:34px;font-weight:1000;margin-top:6px">-</div>
            <div class="mini">L/menit</div>
          </div>

          <div class="card" style="grid-column:span 12;background:rgba(255,255,255,.70)">
            <div style="font-weight:1000;margin-bottom:8px">ğŸ”Œ Status Output</div>
            <div class="mini" id="outS">A:- B:- C:- D:- | LD:- P2:-</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="grid">
          <button class="btn b-blue" id="bA" style="grid-column:span 6"><span><i>ğŸ”´</i> Evaporasi (A)</span><span>Tap</span></button>
          <button class="btn b-purple" id="bB" style="grid-column:span 6"><span><i>ğŸ”µ</i> Kondensasi (B)</span><span>Tap</span></button>
          <button class="btn b-orange" id="bC" style="grid-column:span 6"><span><i>ğŸŸ¡</i> Presipitasi (C)</span><span>Tap</span></button>
          <button class="btn b-pink" id="bD" style="grid-column:span 6"><span><i>âšª</i> Banjir (D)</span><span>Tap</span></button>
          <button class="btn b-red" id="bOff" style="grid-column:span 6"><span><i>â›”</i> Matikan Semua</span><span>Tap</span></button>
          <button class="btn b-green" id="bMode" style="grid-column:span 6"><span><i>âš™ï¸</i> Ganti Mode</span><span>Tap</span></button>
        </div>
      </div>
    `;

    document.getElementById("bA").onclick=()=>sendCmd({k:"A"});
    document.getElementById("bB").onclick=()=>sendCmd({k:"B"});
    document.getElementById("bC").onclick=()=>sendCmd({k:"C"});
    document.getElementById("bD").onclick=()=>sendCmd({k:"D"});
    document.getElementById("bOff").onclick=()=>sendCmd({k:"ALLOFF"});
    document.getElementById("bMode").onclick=()=>{
      const next = (telem?.mode==="manual") ? "auto" : "manual";
      sendCmd({mode: next});
    };

    updateDioramaUI();
  }

  updateFooterNav();
}

/* ====== detail page template ====== */
function proyekDetail(title, imgSrc, desc, bullets){
  const items = bullets.map(x=>`<li style="margin:6px 0">${escapeHtml(x)}</li>`).join("");
  return `
    <div class="card">
      <div class="h2">ğŸ“š ${escapeHtml(title)}</div>
      <div class="qCard" style="margin-top:10px">
        <div class="qImg"><img alt="" src="${imgSrc}" style="width:100%;height:100%;object-fit:cover"></div>
        <div>
          <div class="mini" style="font-size:13px;line-height:1.55">${escapeHtml(desc)}</div>
          <div style="height:10px"></div>
          <div style="font-weight:1000">Yang penting diingat:</div>
          <ul style="margin:8px 0 0;color:var(--muted);font-size:13px;line-height:1.45">${items}</ul>
        </div>
      </div>
    </div>
  `;
}

/* ================== QUIZ RENDER ================== */
function renderQuiz(app){
  setGuide("Pilih jawaban ya! Kalau benar dapat bintang â­");
  const s=getSession()||{};
  if(!quizSet.length){
    quizSet = pick10Random();
    quizIdx=0; quizScore=0; quizLocked=false;
  }

  const q = quizSet[quizIdx];
  const pct = Math.round(((quizIdx)/quizSet.length)*100);

  app.innerHTML = `
    <div class="card">
      <div class="quizTop">
        <div style="display:flex;align-items:center;gap:10px">
          <img src="${IMG_TIRTA}" alt="Tirta" style="width:46px;height:46px;border-radius:16px;border:1px solid rgba(13,43,69,.12);object-fit:cover">
          <div>
            <div class="h2" style="margin:0">ğŸ“ Kuis Bergambar</div>
            <div class="mini"><b>${escapeHtml(s.name||"Siswa")}</b> (Kelas ${escapeHtml(s.kelas||"-")})</div>
          </div>
        </div>
        <div class="progress">
          <div>${quizIdx+1}/${quizSet.length}</div>
          <div class="bar"><div id="barFill"></div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="qCard">
        <div class="qImg">
          <img alt="Ilustrasi" src="${q.img}">
        </div>
        <div>
          <div style="font-weight:1000;font-size:16px;margin-bottom:10px">${escapeHtml(q.q)}</div>
          <div class="choices" id="choices"></div>
          <div class="mini" id="hint" style="margin-top:10px">Pilih jawaban yang paling benar ya ğŸ™‚</div>
        </div>
      </div>
    </div>
  `;

  document.getElementById("barFill").style.width = `${pct}%`;

  const choicesEl = document.getElementById("choices");
  choicesEl.innerHTML = "";
  q.o.forEach((opt, i)=>{
    const btn = document.createElement("button");
    btn.className = "choiceBtn";
    btn.innerHTML = `<div style="display:flex;justify-content:space-between;gap:10px">
        <div>${escapeHtml(opt)}</div>
        <small>${["A","B","C"][i] || ""}</small>
      </div>`;
    btn.onclick = ()=>{
      if(quizLocked) return;
      quizLocked = true;

      const correct = (i === q.a);
      if(correct){
        quizScore++;
        btn.classList.add("good");
        document.getElementById("hint").textContent = "âœ… Benar! Mantap!";
      } else {
        btn.classList.add("bad");
        document.getElementById("hint").textContent = "âŒ Hampir! Yuk lanjut soal berikutnya.";
        [...choicesEl.children].forEach((b, idx)=>{
          if(idx === q.a) b.classList.add("good");
        });
      }

      setTimeout(()=>{
        quizIdx++;
        quizLocked = false;
        if(quizIdx >= quizSet.length){
          const sess = getSession() || {};
          sess.score = { score: quizScore, total: quizSet.length };
          saveSession(sess);
          go("hasil");
          return;
        }
        render();
      }, 900);
    };
    choicesEl.appendChild(btn);
  });
}

/* ================== Diorama UI update ================== */
function updateDioramaUI(){
  const u=document.getElementById("uPct");
  if(!u) return;

  const percent = (telem?.ultra_percent ?? "-");
  const flow = (telem?.flow_lpm ?? "-");
  const A = !!telem?.outA, B = !!telem?.outB, C = !!telem?.outC, D = !!telem?.outD;
  const LD = !!telem?.lampuDesa, P2 = !!telem?.pompa2;

  document.getElementById("uPct").textContent = `${percent}%`;
  document.getElementById("fLpm").textContent = `${flow} L/menit`;
  document.getElementById("outS").textContent =
    `A:${A?"ON":"OFF"} B:${B?"ON":"OFF"} C:${C?"ON":"OFF"} D:${D?"ON":"OFF"} | LD:${LD?"ON":"OFF"} P2:${P2?"ON":"OFF"}`;
}

/* ================== Footer Nav behavior ================== */
function updateFooterNav(){
  const order = ["home","proyek","siswa","diorama","guru"];
  const idx = order.indexOf(page);

  document.getElementById("btnBack").disabled = (historyStack.length <= 1);
  document.getElementById("btnNext").disabled = (idx < 0 || idx >= order.length-1);

  document.getElementById("btnBack").style.opacity = (historyStack.length<=1) ? .55 : 1;
  document.getElementById("btnNext").style.opacity = (idx<0 || idx>=order.length-1) ? .55 : 1;
}

/* ================== utils ================== */
function escapeHtml(s){
  return (s||"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

/* ================== footer buttons ================== */
document.getElementById("btnHome").onclick = ()=>{
  page="home";
  historyStack=["home"];
  render();
};
document.getElementById("btnBack").onclick = ()=>back();
document.getElementById("btnNext").onclick = ()=>{
  const order = ["home","proyek","siswa","diorama","guru"];
  const idx = order.indexOf(page);
  if(idx >= 0 && idx < order.length-1) go(order[idx+1]);
};

/* ================== init ================== */
render();
</script>

</body>
</html>
