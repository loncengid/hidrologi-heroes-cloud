<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hidrologi Heroes â€“ Lacak si Tirta, Air Ajaib</title>

<style>
  :root{
    --bg1:#eaf3ff;
    --bg2:#fff1f7;
    --card:#ffffff;
    --ink:#0d2b45;
    --muted:#4b647a;
    --shadow:0 10px 22px rgba(0,0,0,.10);
    --r:20px;

    --blue1:#2a7fff; --blue2:#53d5ff;
    --pink1:#ff4fa3; --pink2:#ff9ed0;
    --green1:#20c997;--green2:#87f5d0;
    --orange1:#ff9800;--orange2:#ffd36a;
    --red1:#ff3d3d; --red2:#ff8f8f;
    --purple1:#7c4dff; --purple2:#caa8ff;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Arial;
    color:var(--ink);
    background:
      radial-gradient(900px 500px at 15% 0%, #cfe7ff 0%, transparent 60%),
      radial-gradient(900px 500px at 85% 0%, #ffd4e6 0%, transparent 60%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
    min-height:100vh;
    overflow-x:hidden;
  }

  header{
    position:sticky; top:0; z-index:10;
    background: linear-gradient(90deg, #4da3ff, #ff6fb1);
    color:#fff;
    padding:12px 14px;
    box-shadow:0 6px 14px rgba(0,0,0,.12);
  }

  .head{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    max-width:980px; margin:0 auto;
  }

  .brand{display:flex; align-items:center; gap:10px;}
  .logo{
    width:46px; height:46px; border-radius:16px;
    background: rgba(255,255,255,.20);
    display:grid; place-items:center;
    border:1px solid rgba(255,255,255,.35);
    overflow:hidden;
  }
  .logo img{width:100%; height:100%; object-fit:cover}
  .title h1{margin:0;font-size:18px;line-height:1.1}
  .title div{font-size:12px;opacity:.95}

  .badges{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
  .badge{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px;
    border-radius:999px;
    font-weight:900;
    font-size:13px;
    border:1px solid rgba(255,255,255,.40);
    background: rgba(255,255,255,.28);
    color:#08304f;
  }
  .badge small{font-weight:800; opacity:.9}

  main{
    max-width:980px;
    margin:0 auto;
    padding:16px;
    padding-bottom:118px;
  }

  .grid{
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap:12px;
  }

  .card{
    background:var(--card);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    padding:16px;
    border:1px solid rgba(13,43,69,.08);
  }

  .hero{
    grid-column: span 12;
    padding:16px;
    background:
      radial-gradient(700px 220px at 20% 0%, rgba(255,255,255,.55) 0%, transparent 70%),
      linear-gradient(135deg, rgba(255,255,255,.35), rgba(255,255,255,.12));
    border:1px solid rgba(255,255,255,.35);
  }

  .heroRow{
    display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
  }

  .mini{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.35}

  .ctaRow{
    display:grid;
    grid-template-columns: repeat(2, 1fr);
    gap:10px;
    margin-top:12px;
  }
  @media (max-width:700px){
    .ctaRow{grid-template-columns: 1fr;}
  }

  .btn{
    border:none;
    cursor:pointer;
    border-radius:18px;
    padding:14px 14px;
    font-size:16px;
    font-weight:1000;
    color:#fff;
    box-shadow:0 10px 18px rgba(0,0,0,.12);
    transition: transform .08s ease, filter .08s ease;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    user-select:none;
  }
  .btn:active{transform: scale(.98)}
  .btn span{display:inline-flex; align-items:center; gap:10px}
  .btn i{font-style:normal; font-size:18px}

  .b-blue{ background: linear-gradient(135deg, var(--blue1), var(--blue2)); }
  .b-pink{ background: linear-gradient(135deg, var(--pink1), var(--pink2)); }
  .b-green{background: linear-gradient(135deg, var(--green1), var(--green2)); }
  .b-orange{background: linear-gradient(135deg, var(--orange1), var(--orange2)); }
  .b-purple{background: linear-gradient(135deg, var(--purple1), var(--purple2)); }
  .b-red{background: linear-gradient(135deg, var(--red1), var(--red2)); }

  .pill{
    border:none;
    padding:10px 12px;
    border-radius:999px;
    font-weight:1000;
    cursor:pointer;
    background:#ffffff;
    border:1px solid rgba(13,43,69,.12);
    color:var(--ink);
    box-shadow:0 6px 12px rgba(0,0,0,.06);
  }
  .pill:active{transform:scale(.99)}
  .pill.primary{
    background: linear-gradient(135deg, var(--blue1), var(--blue2));
    color:#fff; border:none;
  }

  .h2{margin:0 0 8px;font-size:18px}

  .subgrid{
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap:12px;
  }

  .topic{
    grid-column: span 6;
    padding:14px;
    border-radius:18px;
    box-shadow:var(--shadow);
    border:1px solid rgba(13,43,69,.08);
    background:#fff;
    cursor:pointer;
    user-select:none;
  }
  @media (max-width:820px){
    .topic{grid-column:span 12;}
  }

  .topicHead{display:flex; gap:12px; align-items:center;}
  .pic{
    width:72px; height:72px; border-radius:18px;
    display:grid; place-items:center;
    border:1px solid rgba(13,43,69,.10);
    overflow:hidden;
    background:#fff;
  }
  .pic img{width:100%; height:100%; object-fit:cover}
  .topic h3{margin:0;font-size:16px}
  .topic p{margin:8px 0 0;color:var(--muted);line-height:1.45;font-size:13px}

  .qCard{
    display:grid;
    grid-template-columns: 160px 1fr;
    gap:12px;
    align-items:stretch;
  }
  @media (max-width:720px){
    .qCard{grid-template-columns: 1fr;}
  }
  .qImg{
    border-radius:18px;
    overflow:hidden;
    border:1px solid rgba(13,43,69,.10);
    background:#fff;
    box-shadow:0 10px 18px rgba(0,0,0,.10);
    min-height:130px;
  }
  .qImg img{width:100%; height:100%; object-fit:cover}

  .choices{display:grid;grid-template-columns:1fr;gap:10px;}
  .choiceBtn{
    width:100%;
    text-align:left;
    padding:12px 14px;
    border-radius:16px;
    border:1px solid rgba(13,43,69,.12);
    background:#fff;
    cursor:pointer;
    font-weight:1000;
    box-shadow:0 8px 14px rgba(0,0,0,.06);
    transition: transform .08s ease;
  }
  .choiceBtn:active{transform:scale(.99)}
  .choiceBtn small{font-weight:900; opacity:.85}
  .choiceBtn.good{border-color:rgba(32,201,151,.55); background:rgba(32,201,151,.10)}
  .choiceBtn.bad{border-color:rgba(255,61,61,.55); background:rgba(255,61,61,.08)}

  .quizTop{
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  }
  .progress{display:flex; align-items:center; gap:10px; font-weight:1000;}
  .bar{
    width:160px; height:10px; border-radius:999px; overflow:hidden;
    background: rgba(13,43,69,.10);
  }
  .bar > div{
    height:100%; width:0%;
    background: linear-gradient(90deg, var(--green1), var(--blue2));
  }

  .footer{
    position:fixed; left:0; right:0; bottom:0;
    background: rgba(255,255,255,.88);
    backdrop-filter: blur(10px);
    border-top:1px solid rgba(13,43,69,.08);
    padding:10px 12px;
    display:flex; gap:10px; justify-content:center;
    z-index:9;
  }

  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:94px; background:#111; color:#fff;
    padding:10px 14px; border-radius:999px;
    font-size:13px; opacity:0; pointer-events:none;
    transition:opacity .2s;
    z-index:40;
  }
  .toast.on{opacity:.92}

  .guide{
    position:fixed;
    right:14px;
    bottom:112px;
    display:flex;
    align-items:flex-end;
    gap:10px;
    z-index:20;
    user-select:none;
    touch-action:none;
  }
  .bubble{
    max-width:240px;
    background:rgba(255,255,255,.92);
    border:1px solid rgba(13,43,69,.10);
    border-radius:18px;
    padding:10px 12px;
    box-shadow:0 10px 18px rgba(0,0,0,.10);
    color:var(--ink);
    font-weight:1000;
    font-size:12px;
    line-height:1.25;
    pointer-events:auto;
    cursor:pointer;
  }
  .bubble small{display:block; margin-top:6px; font-weight:900; opacity:.8}
  .guide img{
    width:64px; height:64px; border-radius:22px;
    background:#fff;
    border:1px solid rgba(13,43,69,.12);
    box-shadow:0 10px 18px rgba(0,0,0,.12);
    object-fit:cover;
    pointer-events:auto;
    cursor:grab;
  }
  .guide.dragging img{cursor:grabbing}
  .hideBubble .bubble{display:none}

  .floatTools{
    position:fixed;
    left:14px;
    bottom:112px;
    z-index:20;
    display:flex;
    gap:8px;
  }
  .miniBtn{
    border:none;
    cursor:pointer;
    border-radius:999px;
    padding:10px 12px;
    font-weight:1000;
    background:rgba(255,255,255,.92);
    border:1px solid rgba(13,43,69,.12);
    box-shadow:0 10px 18px rgba(0,0,0,.10);
  }

  .fx-layer{
    position:fixed; inset:0;
    pointer-events:none;
    z-index:30;
  }
  .star-pop{
    position:absolute;
    font-size:26px;
    filter: drop-shadow(0 10px 10px rgba(0,0,0,.22));
    transform: translate(-50%, -50%) scale(.6);
    animation: starPop .72s ease-out forwards;
  }
  @keyframes starPop{
    0%{opacity:0; transform:translate(-50%,-50%) scale(.35) rotate(-18deg)}
    20%{opacity:1; transform:translate(-50%,-65%) scale(1.05) rotate(8deg)}
    70%{opacity:1; transform:translate(-50%,-120%) scale(1.1) rotate(-8deg)}
    100%{opacity:0; transform:translate(-50%,-160%) scale(.85) rotate(12deg)}
  }
  .spark{
    position:absolute;
    width:8px; height:8px;
    border-radius:999px;
    background: #ffd36a;
    transform: translate(-50%,-50%);
    animation: spark .62s ease-out forwards;
    opacity:.95;
  }
  @keyframes spark{
    0%{opacity:0; transform:translate(-50%,-50%) scale(.5)}
    20%{opacity:1}
    100%{opacity:0; transform:translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(.2)}
  }

  .pinWrap{
    display:grid;
    gap:10px;
    padding:14px;
    border-radius:18px;
    border:1px dashed rgba(13,43,69,.18);
    background:rgba(255,255,255,.70);
  }
  .pinRow{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
  }
  .pinRow input{
    flex:1;
    padding:12px 14px;
    border-radius:16px;
    border:1px solid rgba(13,43,69,.12);
    font-weight:1000;
    font-size:16px;
    letter-spacing:2px;
  }

  .banjirOverlay{
    position:fixed; inset:0;
    display:none;
    z-index:50;
    pointer-events:none;
    background:
      radial-gradient(800px 500px at 20% 10%, rgba(255,255,255,.18), transparent 60%),
      radial-gradient(800px 500px at 80% 10%, rgba(255,255,255,.14), transparent 60%),
      linear-gradient(180deg, rgba(255,0,0,.78), rgba(255,120,120,.62));
    animation: shake .35s infinite;
  }
  @keyframes shake{
    0%{transform:translate(0,0)}
    25%{transform:translate(1px,-1px)}
    50%{transform:translate(-1px,1px)}
    75%{transform:translate(1px,1px)}
    100%{transform:translate(0,0)}
  }
  .banjirText{
    position:absolute; left:50%; top:42%;
    transform:translate(-50%,-50%);
    font-size:54px;
    font-weight:1000;
    color:#fff;
    text-shadow:0 10px 24px rgba(0,0,0,.35);
    letter-spacing:2px;
    animation: blink 0.65s infinite;
  }
  @keyframes blink{50%{opacity:.25}}
  .banjirSub{
    position:absolute; left:50%; top:56%;
    transform:translate(-50%,-50%);
    font-size:16px;
    font-weight:1000;
    color:#fff;
    opacity:.95;
    text-shadow:0 10px 24px rgba(0,0,0,.25);
  }

  /* ====== (2) Active menu effect: blink / reverse ====== */
  .activeBlink{
    animation: activeBlink 0.85s infinite;
    outline: 2px solid rgba(13,43,69,.18);
  }
  @keyframes activeBlink{
    0%{ filter:none; transform: translateY(0); }
    40%{ filter: invert(1) hue-rotate(180deg) saturate(1.3); transform: translateY(-1px); }
    100%{ filter:none; transform: translateY(0); }
  }

  /* Diorama output state highlight */
  .liveOn{
    outline: 2px solid rgba(32,201,151,.55);
    box-shadow: 0 0 0 5px rgba(32,201,151,.15), 0 10px 18px rgba(0,0,0,.12);
  }
  .lockedBtn{
    opacity:.55;
    filter: grayscale(1);
    cursor:not-allowed !important;
  }

  /* Device offline hint */
  .offlineBadge{
    background: rgba(255,255,255,.28);
    border: 1px solid rgba(255,255,255,.40);
    color:#08304f;
  }
  .offlineBadge.offline{
    background: rgba(255,255,255,.18);
    border-color: rgba(255,255,255,.55);
    filter: invert(1) hue-rotate(160deg);
  }
</style>
</head>

<body>
<header>
  <div class="head">
    <div class="brand">
      <div class="logo"><img id="tirtaLogo" alt="Tirta"></div>
      <div class="title">
        <h1>Hidrologi Heroes</h1>
        <div>Lacak si Tirta, Air Ajaib</div>
      </div>
    </div>

    <div class="badges">
      <button class="badge" id="btnMusic" title="Play/Pause musik" style="cursor:pointer">
        ğŸµ <small id="musicLabel">Play</small>
      </button>

      <div class="badge offlineBadge" id="devBadge">ğŸ“¡ <small>Device:</small> <span id="hdrDev">-</span></div>
      <div class="badge">ğŸ‘¥ <small>Online:</small> <span id="hdrOnline">0</span></div>
      <div class="badge">ğŸ§  <small>Versi:</small> <span id="hdrVer">-</span></div>
    </div>
  </div>
</header>

<main id="app"></main>

<div class="footer">
  <button class="pill" id="btnBack">â¬… Back</button>
  <button class="pill primary" id="btnHome">ğŸ  Home</button>
  <button class="pill" id="btnNext">Next â¡</button>
</div>

<div id="toast" class="toast">OK</div>

<div class="floatTools">
  <button class="miniBtn" id="btnResetTirta" title="Kembalikan posisi Tirta">ğŸ’§ Reset Tirta</button>
</div>

<div class="guide" id="guide">
  <div class="bubble" id="guideText" title="Klik untuk sembunyikan/tampilkan chat">
    Hai! Aku Tirta ğŸ’§ Klik menu yang kamu mau ya!
    <small>(drag aku kalau nutup tombol)</small>
  </div>
  <img id="tirtaGuide" alt="Tirta Guide">
</div>

<div class="fx-layer" id="fx"></div>

<div class="banjirOverlay" id="banjirOverlay">
  <div class="banjirText">BANJIR...</div>
  <div class="banjirSub">âš ï¸ Air besar! Tetap aman ya!</div>
</div>

<audio id="bgm" preload="auto" loop></audio>
<audio id="banjirAudio" preload="auto" loop></audio>

<script>
/* ================== ASSET URLS (RAW GitHub) ================== */
const ASSETS_BASE = "https://raw.githubusercontent.com/loncengid/Hidrologi-Heroes-Assets/main/";
const IMG_TIRTA   = ASSETS_BASE + "karakter%20tirta.png";
const IMG_BANJIR  = ASSETS_BASE + "Scene%20Banjir.png";
const IMG_EVAP    = ASSETS_BASE + "Scene%20Evaporasi.png";
const IMG_KOND    = ASSETS_BASE + "Scene%20Kondensasi.png";
const IMG_PRES    = ASSETS_BASE + "Scene%20Presipitasi.png";
const IMG_PLTMH   = ASSETS_BASE + "Scene%20PLTMH.png";
const IMG_QR      = ASSETS_BASE + "qrcode%20yt%20channel%20aksa%20swastika.png";
const AUDIO_BGM   = ASSETS_BASE + "audio%20niseef.mp3";
const AUDIO_BANJIR = ASSETS_BASE + "suara%20banjir%20bandang.mp3";

/* ================== PIN ================== */
const DIORAMA_PIN = "654321";
const GURU_PIN    = "1234";
const STORAGE_DIORAMA_OK = "hh_diorama_ok";
const STORAGE_GURU_OK    = "hh_guru_ok";

/* set Tirta images + audio */
document.getElementById("tirtaLogo").src  = IMG_TIRTA;
document.getElementById("tirtaGuide").src = IMG_TIRTA;

const bgm = document.getElementById("bgm");
bgm.src = AUDIO_BGM;
bgm.volume = 0.35;

const banjirAudio = document.getElementById("banjirAudio");
banjirAudio.src = AUDIO_BANJIR;
banjirAudio.volume = 1.0;

/* Music toggle */
let musicOn = false;
async function toggleMusic(){
  try{
    if(!musicOn){
      await bgm.play();
      musicOn = true;
      document.getElementById("musicLabel").textContent = "Pause";
      toast("ğŸµ Musik ON");
    }else{
      bgm.pause();
      musicOn = false;
      document.getElementById("musicLabel").textContent = "Play";
      toast("ğŸ”‡ Musik OFF");
    }
  }catch(e){
    toast("âš ï¸ Browser blokir audio. Klik lagi ya.");
  }
}
document.getElementById("btnMusic").onclick = toggleMusic;

/* ================== SFX (WebAudio) ================== */
let audioCtx = null;
function getAudio(){
  if(!audioCtx){
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if(Ctx) audioCtx = new Ctx();
  }
  return audioCtx;
}
async function unlockAudio(){
  const ctx = getAudio();
  if(!ctx) return;
  if(ctx.state === "suspended") await ctx.resume();
}
window.addEventListener("pointerdown", unlockAudio, {once:true});

function beep({freq=600, dur=0.10, type="sine", gain=0.06}={}){
  const ctx = getAudio();
  if(!ctx) return;
  const t0 = ctx.currentTime;
  const osc = ctx.createOscillator();
  const g = ctx.createGain();

  osc.type = type;
  osc.frequency.setValueAtTime(freq, t0);

  g.gain.setValueAtTime(0.0001, t0);
  g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

  osc.connect(g);
  g.connect(ctx.destination);
  osc.start(t0);
  osc.stop(t0 + dur + 0.02);
}
function sfxCorrect(){
  beep({freq:880, dur:0.09, type:"triangle", gain:0.07});
  setTimeout(()=>beep({freq:1175, dur:0.11, type:"triangle", gain:0.07}), 90);
}
function sfxWrong(){
  beep({freq:220, dur:0.14, type:"sawtooth", gain:0.045});
}
function sfxPinOk(){
  beep({freq:784, dur:0.10, type:"triangle", gain:0.07});
  setTimeout(()=>beep({freq:988, dur:0.12, type:"triangle", gain:0.07}), 110);
  setTimeout(()=>beep({freq:1319, dur:0.14, type:"triangle", gain:0.07}), 240);
}
function sfxPinBad(){
  beep({freq:196, dur:0.12, type:"sawtooth", gain:0.05});
  setTimeout(()=>beep({freq:160, dur:0.16, type:"sawtooth", gain:0.05}), 120);
}

/* ================== STAR POP FX ================== */
const fx = document.getElementById("fx");
function rand(min,max){ return min + Math.random()*(max-min); }
function starPopAt(x,y){
  const s = document.createElement("div");
  s.className = "star-pop";
  s.textContent = "â­";
  s.style.left = x + "px";
  s.style.top  = y + "px";
  fx.appendChild(s);

  for(let i=0;i<7;i++){
    const p = document.createElement("div");
    p.className = "spark";
    p.style.left = x + "px";
    p.style.top  = y + "px";
    const dx = Math.round(rand(-60,60)) + "px";
    const dy = Math.round(rand(-75,35)) + "px";
    p.style.setProperty("--dx", dx);
    p.style.setProperty("--dy", dy);
    p.style.background = (i%3===0) ? "#53d5ff" : (i%3===1) ? "#ffd36a" : "#87f5d0";
    fx.appendChild(p);
    setTimeout(()=>p.remove(), 700);
  }
  setTimeout(()=>s.remove(), 750);
}
function starPopFromElement(el){
  const r = el.getBoundingClientRect();
  starPopAt(r.left + r.width*0.72, r.top + r.height*0.50);
}

/* ================== Tirta draggable + persist ================== */
const guide = document.getElementById("guide");
const bubble = document.getElementById("guideText");
const tirta = document.getElementById("tirtaGuide");
const STORAGE_POS = "hh_tirta_pos";
const STORAGE_BUB = "hh_tirta_bubble_hidden";

function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

function applySavedTirtaPos(){
  const raw = localStorage.getItem(STORAGE_POS);
  if(!raw) return;
  try{
    const p = JSON.parse(raw);
    if(typeof p?.x !== "number" || typeof p?.y !== "number") return;
    guide.style.left = p.x + "px";
    guide.style.top  = p.y + "px";
    guide.style.right = "auto";
    guide.style.bottom = "auto";
  }catch(e){}
}
function saveTirtaPos(x,y){
  localStorage.setItem(STORAGE_POS, JSON.stringify({x,y}));
}
function resetTirta(){
  localStorage.removeItem(STORAGE_POS);
  guide.style.left = "";
  guide.style.top  = "";
  guide.style.right = "14px";
  guide.style.bottom = "112px";
  guide.style.position = "fixed";
  toast("ğŸ’§ Tirta balik ke posisi awal");
}
document.getElementById("btnResetTirta").onclick = resetTirta;

function applyBubbleHidden(){
  const hidden = localStorage.getItem(STORAGE_BUB) === "1";
  guide.classList.toggle("hideBubble", hidden);
}
bubble.onclick = ()=>{
  const nowHidden = !guide.classList.contains("hideBubble");
  guide.classList.toggle("hideBubble", nowHidden);
  localStorage.setItem(STORAGE_BUB, nowHidden ? "1" : "0");
};

applySavedTirtaPos();
applyBubbleHidden();

let dragging = false;
let startX=0, startY=0, baseX=0, baseY=0;

function getGuideXY(){
  const r = guide.getBoundingClientRect();
  return {x: r.left, y: r.top, w:r.width, h:r.height};
}
function onDragStart(clientX, clientY){
  dragging = true;
  guide.classList.add("dragging");
  const g = getGuideXY();
  startX = clientX;
  startY = clientY;
  baseX = g.x;
  baseY = g.y;
}
function onDragMove(clientX, clientY){
  if(!dragging) return;
  const dx = clientX - startX;
  const dy = clientY - startY;

  const g = getGuideXY();
  const w = g.w, h = g.h;

  const maxX = window.innerWidth  - w - 6;
  const maxY = window.innerHeight - h - 96;

  let nx = clamp(baseX + dx, 6, maxX);
  let ny = clamp(baseY + dy, 6, maxY);

  guide.style.left = nx + "px";
  guide.style.top  = ny + "px";
  guide.style.right = "auto";
  guide.style.bottom = "auto";

  saveTirtaPos(nx, ny);
}
function snapToEdge(){
  if(!localStorage.getItem(STORAGE_POS)) return;
  const g = getGuideXY();
  const edge = (g.x + g.w/2 < window.innerWidth/2) ? 6 : (window.innerWidth - g.w - 6);
  guide.style.left = edge + "px";
  guide.style.right = "auto";
  saveTirtaPos(edge, g.y);
}
function onDragEnd(){
  if(!dragging) return;
  dragging = false;
  guide.classList.remove("dragging");
  snapToEdge();
}
tirta.addEventListener("pointerdown", (e)=>{
  e.preventDefault();
  tirta.setPointerCapture(e.pointerId);
  onDragStart(e.clientX, e.clientY);
});
tirta.addEventListener("pointermove", (e)=> onDragMove(e.clientX, e.clientY));
tirta.addEventListener("pointerup", ()=> onDragEnd());
tirta.addEventListener("pointercancel", ()=> onDragEnd());

window.addEventListener("resize", ()=>{
  const raw = localStorage.getItem(STORAGE_POS);
  if(!raw) return;
  try{
    const p = JSON.parse(raw);
    const g = getGuideXY();
    const maxX = window.innerWidth  - g.w - 6;
    const maxY = window.innerHeight - g.h - 96;
    const nx = clamp(p.x, 6, maxX);
    const ny = clamp(p.y, 6, maxY);
    guide.style.left = nx + "px";
    guide.style.top  = ny + "px";
    saveTirtaPos(nx, ny);
  }catch(e){}
});

/* ================== KONFIG RTDB (REST) ================== */
const DB_BASE  = "https://hidrologi-heroes-default-rtdb.asia-southeast1.firebasedatabase.app";
const DEVICE_ID = "niseef_v12_01";
const PATH_CMD   = `/devices/${DEVICE_ID}/cmd`;
const PATH_TELEM = `/devices/${DEVICE_ID}/telemetry`;
const PATH_PRES  = `/devices/${DEVICE_ID}/presence/lastActiveMs`;

/* =============== HELPERS REST =============== */
async function rtdbGet(path){
  const res = await fetch(`${DB_BASE}${path}.json`, { cache:"no-store" });
  return await res.json();
}
async function rtdbPut(path, obj){
  await fetch(`${DB_BASE}${path}.json`, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(obj)
  });
}
async function rtdbPatch(path, obj){
  await fetch(`${DB_BASE}${path}.json`, {
    method:"PATCH",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(obj)
  });
}

/* ================== TOAST ================== */
let toastT=null;
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("on");
  clearTimeout(toastT);
  toastT=setTimeout(()=>t.classList.remove("on"),1000);
}

/* ================== ONLINE COUNTER (NO IP) ================== */
const cid = "c_" + Math.random().toString(36).slice(2);
let onlineCount = 0;

async function heartbeatOnline(){
  try{ await rtdbPatch(`/online/${cid}`, { ts: Date.now() }); }catch(e){}
}
heartbeatOnline();
setInterval(heartbeatOnline, 5000);

async function pollOnline(){
  try{
    const o = await rtdbGet("/online");
    const now = Date.now();
    let n=0;
    if(o){
      for(const k in o){
        if(now - (o[k]?.ts||0) < 15000) n++;
      }
    }
    onlineCount = n;
    document.getElementById("hdrOnline").textContent = onlineCount;
  }catch(e){}
}
pollOnline();
setInterval(pollOnline, 3000);

/* ================== PRESENCE KE DEVICE ================== */
async function heartbeatPresence(){
  try{ await rtdbPut(PATH_PRES, Date.now()); }catch(e){}
}
heartbeatPresence();
setInterval(heartbeatPresence, 5000);

/* ================== DEVICE STATE ================== */
let telem = null;
let seq = 0;
let lastTelemAt = 0;

// Timer untuk LD: aktif hanya jika A aktif >=2 detik
let aOnSinceMs = 0;

/* (2) anti spam tap */
let lastCmdSentAt = 0;
const CMD_COOLDOWN_MS = 320;

async function sendCmd(patch){
  const now = Date.now();
  if(now - lastCmdSentAt < CMD_COOLDOWN_MS){
    return;
  }
  lastCmdSentAt = now;

  seq++;
  try{
    await rtdbPatch(PATH_CMD, { seq, ts: Date.now(), ...patch });
    toast("âœ… Terkirim");
  }catch(e){
    toast("âš ï¸ Gagal kirim");
  }
}

async function pollTelem(){
  try{
    const t = await rtdbGet(PATH_TELEM);
    telem = t;
    lastTelemAt = Date.now();

    document.getElementById("hdrVer").textContent = telem?.version || "-";

    // device badge offline/online
    const devBadge = document.getElementById("devBadge");
    const devText = document.getElementById("hdrDev");
    const isOffline = (Date.now() - lastTelemAt) > 3500;
    devBadge.classList.toggle("offline", isOffline);
    devText.textContent = isOffline ? "OFFLINE" : "ONLINE";

    // Flow dipaksa 0 kalau A OFF (tampilan)
    if(telem && !telem.outA){
      telem.flow_lpm = 0;
    }

    // aturan LD internal
    const now = Date.now();
    if(telem?.outA){
      if(!aOnSinceMs) aOnSinceMs = now;
      const a2s = (now - aOnSinceMs) >= 2000;
      telem.lampuDesa = !!a2s;
    }else{
      aOnSinceMs = 0;
      telem.lampuDesa = false;
    }

    handleBanjirAlarm();

    if(page==="diorama") updateDioramaUI();
  }catch(e){}
}
pollTelem();
setInterval(pollTelem, 1000);

/* Device offline poll (kalau fetch gagal) */
setInterval(()=>{
  const devBadge = document.getElementById("devBadge");
  const devText = document.getElementById("hdrDev");
  const off = (Date.now() - lastTelemAt) > 3500;
  devBadge.classList.toggle("offline", off);
  devText.textContent = off ? "OFFLINE" : "ONLINE";
}, 700);

/* ================== BANJIR ALARM ================== */
let banjirOn = false;
let banjirVibeTimer = null;

function vibrateBanjir(){
  if(!navigator.vibrate) return;
  navigator.vibrate([400,200,400,200,800]);
}
async function startBanjirAlarm(){
  const overlay = document.getElementById("banjirOverlay");
  overlay.style.display = "block";
  banjirOn = true;
  try{ await banjirAudio.play(); }catch(e){}
  vibrateBanjir();
  clearInterval(banjirVibeTimer);
  banjirVibeTimer = setInterval(vibrateBanjir, 2200);
}
function stopBanjirAlarm(){
  const overlay = document.getElementById("banjirOverlay");
  overlay.style.display = "none";
  banjirOn = false;
  banjirAudio.pause();
  try{ banjirAudio.currentTime = 0; }catch(e){}
  clearInterval(banjirVibeTimer);
  banjirVibeTimer = null;
}
function handleBanjirAlarm(){
  const pct = Number(telem?.ultra_percent ?? -1);
  if(telem?.pompa2){
    if(!banjirOn) startBanjirAlarm();
    return;
  }
  if(banjirOn && pct >= 0 && pct <= 30){
    stopBanjirAlarm();
  }
  if(banjirOn && !telem?.pompa2 && (pct < 0 || pct <= 30)){
    stopBanjirAlarm();
  }
}
window.addEventListener("pointerdown", async ()=>{
  try{
    if(banjirOn && banjirAudio.paused) await banjirAudio.play();
  }catch(e){}
}, {passive:true});

/* ================== NAV STATE ================== */
let page = "home";
let historyStack = ["home"];

// agar "paksa OFF" saat masuk diorama cuma sekali per masuk
let dioramaEntryLockSent = false;

// track clicked menu to animate blink
let lastMenuKey = "";

function setGuide(text){
  const gt = document.getElementById("guideText");
  gt.childNodes[0].textContent = text + " ";
}

function markActive(key){
  lastMenuKey = key || "";
}

function go(p){
  if(page !== p){
    historyStack.push(p);
    page = p;
    render();
  }
}
function back(){
  if(historyStack.length > 1){
    historyStack.pop();
    page = historyStack[historyStack.length-1];
    render();
  } else {
    page="home"; render();
  }
}

/* ================== SESSION SISWA ================== */
function getSession(){ return JSON.parse(localStorage.getItem("hh_student") || "null"); }
function saveSession(s){ localStorage.setItem("hh_student", JSON.stringify(s)); }

/* ================== AUTH (session-only) ================== */
function dioramaAllowed(){ return sessionStorage.getItem(STORAGE_DIORAMA_OK) === "1"; }
function setDioramaAllowed(ok){ sessionStorage.setItem(STORAGE_DIORAMA_OK, ok ? "1" : "0"); }

function guruAllowed(){ return sessionStorage.getItem(STORAGE_GURU_OK) === "1"; }
function setGuruAllowed(ok){ sessionStorage.setItem(STORAGE_GURU_OK, ok ? "1" : "0"); }

/* ================== BANK SOAL ================== */
const QUESTION_BANK = [
  { img: IMG_EVAP,  q:"Apa yang disebut evaporasi?", o:["Air berubah jadi es","Air menguap karena panas","Awan turun jadi hujan"], a:1 },
  { img: IMG_KOND,  q:"Kondensasi itu terjadi saat...", o:["Uap air jadi awan","Hujan jadi sungai","Air jadi batu"], a:0 },
  { img: IMG_PRES,  q:"Presipitasi adalah...", o:["Air menguap","Awan terbentuk","Hujan turun ke bumi"], a:2 },
  { img: IMG_BANJIR, q:"Banjir biasanya terjadi karena...", o:["Air berlebih dan meluap","Air menguap habis","Awan hilang"], a:0 },
  { img: IMG_EVAP,  q:"Sumber energi yang memicu evaporasi adalah...", o:["Matahari","Bulan","Bintang jatuh"], a:0 },
  { img: IMG_KOND,  q:"Awan terbentuk dari...", o:["Tanah kering","Uap air yang berkumpul","Batu kecil"], a:1 },
  { img: IMG_PRES,  q:"Setelah hujan turun, air biasanya...", o:["Naik ke langit lagi langsung","Mengalir ke sungai/laut","Berubah jadi api"], a:1 },
  { img: IMG_BANJIR, q:"Cara mengurangi risiko banjir adalah...", o:["Buang sampah ke sungai","Menjaga saluran air bersih","Menutup semua pohon"], a:1 },
  { img: IMG_PLTMH, q:"PLTMH itu singkatan dari...", o:["Pembangkit Listrik Tenaga Mikrohidro","Pabrik Lampu Tengah Malam","Perahu Listrik Tenaga Matahari"], a:0 },
  { img: IMG_PLTMH, q:"PLTMH memanfaatkan energi dari...", o:["Angin","Arus air","Pasir"], a:1 },
  { img: IMG_EVAP,  q:"Contoh evaporasi di rumah adalah...", o:["Air jemuran kering","Es membeku","Kipas angin berputar"], a:0 },
  { img: IMG_KOND,  q:"Contoh kondensasi yang mudah dilihat adalah...", o:["Embun di gelas dingin","Air mendidih","Batu panas"], a:0 },
];

let quizSet = [];
let quizIdx = 0;
let quizScore = 0;
let quizLocked = false;

function pick10Random(){
  const arr = QUESTION_BANK.slice();
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr.slice(0, 10);
}

/* ================== HELPERS: active blink on click ================== */
function blinkElement(el){
  if(!el) return;
  el.classList.remove("activeBlink");
  void el.offsetWidth; // reflow
  el.classList.add("activeBlink");
  setTimeout(()=>el.classList.remove("activeBlink"), 1700);
}

/* ================== PAGES RENDER ================== */
function render(){
  const app = document.getElementById("app");
  app.innerHTML = "";

  if(page==="home"){
    setGuide("Hai! Aku Tirta ğŸ’§ Klik menu yang kamu mau ya! (Kalau nutup tombol, drag aku ğŸ˜„)");
    dioramaEntryLockSent = false;
    app.innerHTML = `
      <div class="grid">
        <div class="card hero">
          <div class="heroRow">
            <div>
              <div class="h2">Halo! Aku Tirta ğŸ’§</div>
              <div class="mini">Yuk belajar siklus air + banjir + PLTMH dengan cara yang seru!</div>
            </div>
            <div class="badges">
              <div class="badge">ğŸ‘¥ <small>Online:</small> <span>${onlineCount}</span></div>
              <div class="badge">ğŸ§  <small>Versi:</small> <span>${telem?.version || "-"}</span></div>
            </div>
          </div>

          <div class="ctaRow">
            <button class="btn b-blue" id="mProyek"><span><i>ğŸ“š</i> Penjelasan Proyek</span><span>â¡</span></button>
            <button class="btn b-pink" id="mSiswa"><span><i>ğŸ§’</i> Siswa</span><span>â¡</span></button>
            <button class="btn b-green" id="mGuru"><span><i>ğŸ‘©â€ğŸ«</i> Guru</span><span>â¡</span></button>
            <button class="btn b-orange" id="mDiorama"><span><i>ğŸ¥</i> Diorama</span><span>â¡</span></button>
          </div>

          <div style="height:12px"></div>

          <button class="btn b-purple" id="mKisah">
            <span><i>ğŸ“º</i> Kisah Perjalanan si Tirta, Air Ajaib</span><span>â¡</span>
          </button>

          <div class="mini">Tip: Menu bertingkat. Pakai tombol Back / Home / Next di bawah.</div>
        </div>
      </div>
    `;
    document.getElementById("mProyek").onclick = (e)=>{ markActive("mProyek"); blinkElement(e.currentTarget); go("proyek"); };
    document.getElementById("mSiswa").onclick  = (e)=>{ markActive("mSiswa");  blinkElement(e.currentTarget); go("siswa"); };
    document.getElementById("mGuru").onclick   = (e)=>{ markActive("mGuru");   blinkElement(e.currentTarget); go("guru"); };
    document.getElementById("mDiorama").onclick= (e)=>{ markActive("mDiorama");blinkElement(e.currentTarget); go("diorama"); };
    document.getElementById("mKisah").onclick  = (e)=>{ markActive("mKisah");  blinkElement(e.currentTarget); go("kisah"); };
  }

  if(page==="kisah"){
    setGuide("Scan QR ini ya! Nanti kamu bisa lihat kisah Tirta ğŸ™‚");
    dioramaEntryLockSent = false;
    app.innerHTML = `
      <div class="card">
        <div class="h2">ğŸ“º Kisah Perjalanan si Tirta, Air Ajaib</div>
        <div class="mini">Scan QR di bawah untuk menuju channel (YouTube).</div>
      </div>

      <div class="card">
        <div class="qCard">
          <div class="qImg"><img alt="QR" src="${IMG_QR}"></div>
          <div>
            <div style="font-weight:1000">Arahkan kamera HP ke QR ğŸ‘‰</div>
            <div class="mini">Kalau QR belum kebaca, coba zoom sedikit atau naikkan brightness layar.</div>
          </div>
        </div>
      </div>
    `;
  }

  if(page==="proyek"){
    setGuide("Pilih salah satu ya: Evaporasi, Kondensasi, Presipitasi, atau Banjir ğŸ™‚");
    dioramaEntryLockSent = false;
    app.innerHTML = `
      <div class="card">
        <div class="h2">ğŸ“š Penjelasan Proyek</div>
        <div class="mini">Pilih sub menu di bawah ya.</div>
      </div>

      <div class="subgrid">
        <div class="topic" id="pEv">
          <div class="topicHead">
            <div class="pic"><img alt="Evaporasi" src="${IMG_EVAP}"></div>
            <div><h3>Evaporasi</h3><div class="mini">Air menguap karena panas</div></div>
          </div>
        </div>

        <div class="topic" id="pKo">
          <div class="topicHead">
            <div class="pic"><img alt="Kondensasi" src="${IMG_KOND}"></div>
            <div><h3>Kondensasi</h3><div class="mini">Uap air jadi awan</div></div>
          </div>
        </div>

        <div class="topic" id="pPr">
          <div class="topicHead">
            <div class="pic"><img alt="Presipitasi" src="${IMG_PRES}"></div>
            <div><h3>Presipitasi</h3><div class="mini">Awan jenuh â†’ hujan turun</div></div>
          </div>
        </div>

        <div class="topic" id="pBa">
          <div class="topicHead">
            <div class="pic"><img alt="Banjir" src="${IMG_BANJIR}"></div>
            <div><h3>Banjir</h3><div class="mini">Air berlebih â†’ meluap</div></div>
          </div>
        </div>
      </div>
    `;

    document.getElementById("pEv").onclick = (e)=>{ blinkElement(e.currentTarget); go("proyek_evaporasi"); };
    document.getElementById("pKo").onclick = (e)=>{ blinkElement(e.currentTarget); go("proyek_kondensasi"); };
    document.getElementById("pPr").onclick = (e)=>{ blinkElement(e.currentTarget); go("proyek_presipitasi"); };
    document.getElementById("pBa").onclick = (e)=>{ blinkElement(e.currentTarget); go("proyek_banjir"); };
  }

  if(page==="proyek_evaporasi"){
    dioramaEntryLockSent = false;
    setGuide("Evaporasi = air naik jadi uap ğŸ’¨");
    app.innerHTML = proyekDetail(
      "Evaporasi",
      IMG_EVAP,
      "Evaporasi adalah proses saat air berubah menjadi uap karena panas matahari. Uap air naik ke atas dan memulai siklus air.",
      ["Air di laut/danau menguap", "Jemuran jadi kering", "Uap air naik ke langit"]
    );
  }
  if(page==="proyek_kondensasi"){
    dioramaEntryLockSent = false;
    setGuide("Kondensasi = uap jadi awan â˜ï¸");
    app.innerHTML = proyekDetail(
      "Kondensasi",
      IMG_KOND,
      "Kondensasi adalah proses saat uap air mendingin dan berkumpul menjadi titik-titik air kecil, lalu membentuk awan.",
      ["Uap air jadi awan", "Contoh: embun di gelas dingin", "Awan makin tebal kalau uap banyak"]
    );
  }
  if(page==="proyek_presipitasi"){
    dioramaEntryLockSent = false;
    setGuide("Presipitasi = hujan turun ğŸŒ§ï¸");
    app.innerHTML = proyekDetail(
      "Presipitasi",
      IMG_PRES,
      "Presipitasi adalah proses turunnya air dari awan ke bumi, seperti hujan. Ini terjadi saat awan sudah sangat jenuh.",
      ["Awan gelap â†’ hujan", "Air turun ke tanah", "Air mengalir ke sungai/laut"]
    );
  }
  if(page==="proyek_banjir"){
    dioramaEntryLockSent = false;
    setGuide("Banjir = air meluap. Yuk jaga lingkungan! â™»ï¸");
    app.innerHTML = proyekDetail(
      "Banjir",
      IMG_BANJIR,
      "Banjir terjadi saat air berlebih tidak tertampung sehingga sungai/saluran meluap. Bisa karena hujan deras, saluran tersumbat, atau resapan berkurang.",
      ["Jaga saluran air bersih", "Jangan buang sampah sembarangan", "Buat resapan/biopori"]
    );
  }

  if(page==="siswa"){
    dioramaEntryLockSent = false;
    setGuide("Isi nama + kelas dulu ya. Nanti skor kuisnya muncul â­");
    const s = getSession() || {};
    app.innerHTML = `
      <div class="card">
        <div class="h2">ğŸ§’ Menu Siswa</div>
        <div class="mini">Isi data dulu ya supaya kuisnya rapi.</div>
        <div style="height:10px"></div>

        <label class="mini"><b>Nama</b></label>
        <input id="nm" placeholder="contoh: Aulia" value="${escapeHtml(s.name||"")}"
          style="width:100%;padding:12px;border-radius:16px;border:1px solid rgba(13,43,69,.12)">

        <div style="height:8px"></div>
        <label class="mini"><b>Kelas</b></label>
        <input id="kl" placeholder="contoh: 5A" value="${escapeHtml(s.kelas||"")}"
          style="width:100%;padding:12px;border-radius:16px;border:1px solid rgba(13,43,69,.12)">

        <button class="btn b-pink" id="btnStart" style="margin-top:12px">
          <span><i>ğŸ“</i> Mulai Kuis Bergambar</span><span>â¡</span>
        </button>

        <div class="mini" style="margin-top:10px">
          Kuis: 10 soal acak, pilihan ganda, dengan gambar.
        </div>
      </div>
    `;
    document.getElementById("btnStart").onclick = async (e)=>{
      blinkElement(e.currentTarget);
      await unlockAudio();
      const name = document.getElementById("nm").value.trim();
      const kelas = document.getElementById("kl").value.trim();
      if(!name || !kelas){ alert("Isi nama dan kelas dulu ya ğŸ™‚"); return; }
      saveSession({name, kelas, score:null});

      quizSet = pick10Random();
      quizIdx = 0;
      quizScore = 0;
      quizLocked = false;
      go("quiz");
    };
  }

  if(page==="quiz"){
    dioramaEntryLockSent = false;
    renderQuiz(app);
  }

  if(page==="hasil"){
    dioramaEntryLockSent = false;
    setGuide("Keren! Mau coba lagi? balik ke Home lalu masuk menu Siswa ğŸ˜„");
    const s=getSession()||{};
    const sc = s?.score ? `${s.score.score}/${s.score.total}` : "-";
    app.innerHTML = `
      <div class="card">
        <div class="h2">ğŸ‰ Hasil Kuis</div>
        <div class="mini"><b>${escapeHtml(s.name||"-")}</b> (Kelas ${escapeHtml(s.kelas||"-")})</div>
        <div style="height:10px"></div>

        <div class="card" style="box-shadow:none;border:1px dashed rgba(13,43,69,.18);background:rgba(255,255,255,.65)">
          <div style="font-size:44px;font-weight:1000">â­ ${sc} â­</div>
          <div class="mini">Hebat! Kamu bisa belajar lagi lewat Penjelasan Proyek juga ya.</div>
        </div>
      </div>
    `;
  }

  /* ===================== GURU ===================== */
  if(page==="guru"){
    dioramaEntryLockSent = false;
    const ok = guruAllowed();

    if(!ok){
      setGuide("Menu Guru terkunci ğŸ”’ Masukkan PIN Guru dulu ya ğŸ™‚");
      app.innerHTML = `
        <div class="card">
          <div class="h2">ğŸ‘©â€ğŸ« Menu Guru (Terkunci)</div>
          <div class="mini">Untuk keamanan, menu guru dibuka dengan PIN.</div>
        </div>

        <div class="card">
          <div class="pinWrap">
            <div style="font-weight:1000">ğŸ”’ Masukkan PIN Guru</div>

            <div class="pinRow">
              <input id="pinGuru" type="password" inputmode="numeric" placeholder="â€¢â€¢â€¢â€¢" maxlength="4">
              <button class="btn b-green" id="btnGuruPin" style="flex:0 0 auto;min-width:160px">
                <span><i>âœ…</i> Masuk</span><span>â¡</span>
              </button>
            </div>

            <div class="mini" id="guruMsg" style="font-weight:1000"></div>
          </div>
        </div>
      `;

      const pinEl = document.getElementById("pinGuru");
      const msgEl = document.getElementById("guruMsg");
      const btnEl = document.getElementById("btnGuruPin");

      const tryPin = async ()=>{
        await unlockAudio();
        const entered = (pinEl.value||"").trim();
        if(entered === GURU_PIN){
          setGuruAllowed(true);
          msgEl.style.color = "#0c7a5c";
          msgEl.textContent = "Selamat datang, Guru Hidrologi Heroes";
          sfxPinOk();
          toast("ğŸ‘©â€ğŸ« Guru OK!");
          setTimeout(()=>render(), 250);
        }else{
          msgEl.style.color = "#b02020";
          msgEl.textContent = "Anda memasukkan PIN yang salah";
          sfxPinBad();
          toast("âŒ PIN salah");
          pinEl.value = "";
          pinEl.focus();
        }
      };

      btnEl.onclick = (e)=>{ blinkElement(e.currentTarget); tryPin(); };
      pinEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter") tryPin(); });
      return updateFooterNav();
    }

    setGuide("Selamat datang, Guru Hidrologi Heroes ğŸ‘©â€ğŸ«");
    const s=getSession();
    const sc = s?.score ? `${s.score.score}/${s.score.total}` : "-";
    app.innerHTML = `
      <div class="card">
        <div class="h2">ğŸ‘©â€ğŸ« Menu Guru</div>
        <div style="height:10px"></div>
        <button class="pill" id="btnLockGuru" title="Kunci lagi Menu Guru">ğŸ”’ Kunci Lagi</button>

        <div style="height:12px"></div>

        <div class="grid">
          <div class="card" style="grid-column:span 6;background:linear-gradient(135deg,rgba(42,127,255,.10),rgba(83,213,255,.08))">
            <div style="font-weight:1000;font-size:16px">ğŸ‘¥ Online</div>
            <div style="font-size:32px;font-weight:1000;margin-top:6px">${onlineCount}</div>
            <div class="mini">Pengunjung aktif (â‰ˆ 15 detik terakhir)</div>
          </div>

          <div class="card" style="grid-column:span 6;background:linear-gradient(135deg,rgba(255,79,163,.10),rgba(255,158,208,.08))">
            <div style="font-weight:1000;font-size:16px">ğŸ“ Skor terakhir (browser ini)</div>
            <div style="font-size:32px;font-weight:1000;margin-top:6px">${sc}</div>
            <div class="mini">Tersimpan lokal</div>
          </div>

          <div class="card" style="grid-column:span 12;background:linear-gradient(135deg,rgba(32,201,151,.10),rgba(135,245,208,.08))">
            <div style="font-weight:1000;font-size:16px">ğŸ“¡ Telemetri Device</div>
            <div class="mini">Ultrasonic: <b>${escapeHtml(String(telem?.ultra_percent ?? "-"))}%</b> |
              Flow: <b>${escapeHtml(String((telem?.outA ? telem?.flow_lpm : 0) ?? 0))} L/menit</b></div>
            <div class="mini">A:${telem?.outA?"ON":"OFF"} B:${telem?.outB?"ON":"OFF"} C:${telem?.outC?"ON":"OFF"} D:${telem?.outD?"ON":"OFF"} | P2:${telem?.pompa2?"ON":"OFF"}</div>
          </div>
        </div>
      </div>
    `;

    document.getElementById("btnLockGuru").onclick = (e)=>{
      blinkElement(e.currentTarget);
      setGuruAllowed(false);
      toast("ğŸ”’ Menu Guru dikunci");
      render();
    };
  }

  /* ===================== DIORAMA ===================== */
  if(page==="diorama"){
    const ok = dioramaAllowed();

    if(!ok){
      setGuide("Menu Diorama terkunci ğŸ”’ Masukkan PIN dulu ya ğŸ™‚");
      app.innerHTML = `
        <div class="card">
          <div class="h2">ğŸ¥ Diorama (Terkunci)</div>
          <div class="mini">Kontrol diorama hanya bisa dibuka dengan PIN.</div>
        </div>

        <div class="card">
          <div class="pinWrap">
            <div style="font-weight:1000">ğŸ”’ Masukkan PIN Diorama</div>

            <div class="pinRow">
              <input id="pinInput" type="password" inputmode="numeric" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="6">
              <button class="btn b-orange" id="btnPin" style="flex:0 0 auto;min-width:160px">
                <span><i>âœ…</i> Buka</span><span>â¡</span>
              </button>
            </div>

            <div class="mini" id="pinMsg" style="font-weight:1000"></div>
          </div>
        </div>
      `;

      const pinEl = document.getElementById("pinInput");
      const msgEl = document.getElementById("pinMsg");
      const btnEl = document.getElementById("btnPin");

      const tryPin = async ()=>{
        await unlockAudio();
        const entered = (pinEl.value||"").trim();
        if(entered === DIORAMA_PIN){
          setDioramaAllowed(true);
          msgEl.style.color = "#0c7a5c";
          msgEl.textContent = "Selamat berpetualang di dunia Hidrologi Heroes";
          sfxPinOk();
          toast("ğŸ”“ Diorama terbuka!");
          setTimeout(()=>render(), 250);
        }else{
          msgEl.style.color = "#b02020";
          msgEl.textContent = "Anda memasukkan PIN yang salah";
          sfxPinBad();
          toast("âŒ PIN salah");
          pinEl.value = "";
          pinEl.focus();
        }
      };

      btnEl.onclick = (e)=>{ blinkElement(e.currentTarget); tryPin(); };
      pinEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter") tryPin(); });
      return updateFooterNav();
    }

    setGuide("Klik tombol diorama ya!");
    const p2On = !!telem?.pompa2;

    app.innerHTML = `
      <div class="card">
        <div class="h2">ğŸ¥ Diorama</div>

        <div class="mini" style="margin-top:8px;font-weight:1000;color:#0c7a5c">
          âœ… Selamat berpetualang di dunia Hidrologi Heroes
        </div>
        <div class="mini" style="margin-top:6px;font-weight:1000;color:${p2On ? "#b02020" : "#4b647a"}">
          ${p2On ? "âš ï¸ P2 ON â†’ Tombol C & D dikunci otomatis demi keamanan." : "Tip: tekan A dulu untuk mulai aliran (flow)."}
        </div>

        <div style="height:10px"></div>
        <button class="pill" id="btnLock" title="Kunci lagi Diorama">ğŸ”’ Kunci Lagi</button>
      </div>

      <div class="card">
        <div class="grid">
          <div class="card" style="grid-column:span 6;background:linear-gradient(135deg,rgba(42,127,255,.10),rgba(83,213,255,.08))">
            <div style="font-weight:1000">ğŸ“ Ultrasonic</div>
            <div id="uPct" style="font-size:34px;font-weight:1000;margin-top:6px">- %</div>
            <div class="mini">Tinggi air (persen)</div>
          </div>
          <div class="card" style="grid-column:span 6;background:linear-gradient(135deg,rgba(32,201,151,.10),rgba(135,245,208,.08))">
            <div style="font-weight:1000">ğŸ’¦ Flow</div>
            <div id="fLpm" style="font-size:34px;font-weight:1000;margin-top:6px">-</div>
            <div class="mini">L/menit (maks tampilan 6)</div>
          </div>

          <div class="card" style="grid-column:span 12;background:rgba(255,255,255,.70)">
            <div style="font-weight:1000;margin-bottom:8px">ğŸ”Œ Status Output (Aâ€“D) + P2</div>
            <div class="mini" id="outS">A:- B:- C:- D:- | P2:-</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="grid">
          <button class="btn b-blue" id="bA" style="grid-column:span 6"><span><i>ğŸ”´</i> Evaporasi (A)</span><span>Tap</span></button>
          <button class="btn b-purple" id="bB" style="grid-column:span 6"><span><i>ğŸ”µ</i> Kondensasi (B)</span><span>Tap</span></button>

          <button class="btn b-orange" id="bC" style="grid-column:span 6">
            <span><i>ğŸŸ¡</i> ${p2On ? "Presipitasi (C) â€” TERKUNCI (P2 ON)" : "Presipitasi (C)"}</span>
            <span>${p2On ? "Lock" : "Tap"}</span>
          </button>

          <button class="btn b-pink" id="bD" style="grid-column:span 6">
            <span><i>âšª</i> ${p2On ? "Pompa Banjir (D) â€” TERKUNCI (P2 ON)" : "Pompa Banjir (D)"}</span>
            <span>${p2On ? "Lock" : "Tap"}</span>
          </button>

          <button class="btn b-red" id="bOff" style="grid-column:span 12"><span><i>â›”</i> Matikan Semua</span><span>Tap</span></button>
        </div>
      </div>
    `;

    document.getElementById("btnLock").onclick = (e)=>{
      blinkElement(e.currentTarget);
      setDioramaAllowed(false);
      toast("ğŸ”’ Diorama dikunci");
      render();
    };

    // masuk Diorama -> paksa semua OFF sekali + message
    if(!dioramaEntryLockSent){
      dioramaEntryLockSent = true;
      toast("ğŸ›ï¸ Diorama siap dikendalikan");
      sendCmd({k:"ALLOFF"});
    }

    const btnA = document.getElementById("bA");
    const btnB = document.getElementById("bB");
    const btnC = document.getElementById("bC");
    const btnD = document.getElementById("bD");
    const btnOff = document.getElementById("bOff");

    // Lock UI C/D jika P2 ON
    if(p2On){
      btnC.classList.add("lockedBtn");
      btnD.classList.add("lockedBtn");
      btnC.disabled = true;
      btnD.disabled = true;
      btnC.title = "Terkunci karena P2 ON";
      btnD.title = "Terkunci karena P2 ON";
    }

    btnA.onclick=async (e)=>{ blinkElement(e.currentTarget); await unlockAudio(); sendCmd({k:"A"}); };
    btnB.onclick=async (e)=>{ blinkElement(e.currentTarget); await unlockAudio(); sendCmd({k:"B"}); };
    btnC.onclick=async (e)=>{ blinkElement(e.currentTarget); await unlockAudio(); if(!p2On) sendCmd({k:"C"}); };
    btnD.onclick=async (e)=>{ blinkElement(e.currentTarget); await unlockAudio(); if(!p2On) sendCmd({k:"D"}); };
    btnOff.onclick=async (e)=>{ blinkElement(e.currentTarget); await unlockAudio(); sendCmd({k:"ALLOFF"}); };

    updateDioramaUI();
  }

  updateFooterNav();
}

function proyekDetail(title, imgSrc, desc, bullets){
  const items = bullets.map(x=>`<li style="margin:6px 0">${escapeHtml(x)}</li>`).join("");
  return `
    <div class="card">
      <div class="h2">ğŸ“š ${escapeHtml(title)}</div>
      <div class="qCard" style="margin-top:10px">
        <div class="qImg"><img alt="" src="${imgSrc}" style="width:100%;height:100%;object-fit:cover"></div>
        <div>
          <div class="mini" style="font-size:13px;line-height:1.55">${escapeHtml(desc)}</div>
          <div style="height:10px"></div>
          <div style="font-weight:1000">Yang penting diingat:</div>
          <ul style="margin:8px 0 0;color:var(--muted);font-size:13px;line-height:1.45">${items}</ul>
        </div>
      </div>
    </div>
  `;
}

/* ================== QUIZ RENDER ================== */
function renderQuiz(app){
  setGuide("Pilih jawaban ya! Kalau benar dapat bintang â­");
  const s=getSession()||{};
  if(!quizSet.length){
    quizSet = pick10Random();
    quizIdx=0; quizScore=0; quizLocked=false;
  }

  const q = quizSet[quizIdx];
  const pct = Math.round(((quizIdx)/quizSet.length)*100);

  app.innerHTML = `
    <div class="card">
      <div class="quizTop">
        <div style="display:flex;align-items:center;gap:10px">
          <img src="${IMG_TIRTA}" alt="Tirta" style="width:46px;height:46px;border-radius:16px;border:1px solid rgba(13,43,69,.12);object-fit:cover">
          <div>
            <div class="h2" style="margin:0">ğŸ“ Kuis Bergambar</div>
            <div class="mini"><b>${escapeHtml(s.name||"Siswa")}</b> (Kelas ${escapeHtml(s.kelas||"-")})</div>
          </div>
        </div>
        <div class="progress">
          <div>${quizIdx+1}/${quizSet.length}</div>
          <div class="bar"><div id="barFill"></div></div>
        </div>
      </div>
      <div class="mini" style="margin-top:8px;font-weight:1000">Skor: â­ <span id="scNow">${quizScore}</span></div>
    </div>

    <div class="card">
      <div class="qCard">
        <div class="qImg">
          <img alt="Ilustrasi" src="${q.img}">
        </div>
        <div>
          <div style="font-weight:1000;font-size:16px;margin-bottom:10px">${escapeHtml(q.q)}</div>
          <div class="choices" id="choices"></div>
          <div class="mini" id="hint" style="margin-top:10px">Pilih jawaban yang paling benar ya ğŸ™‚</div>
        </div>
      </div>
    </div>
  `;

  document.getElementById("barFill").style.width = `${pct}%`;

  const choicesEl = document.getElementById("choices");
  choicesEl.innerHTML = "";
  q.o.forEach((opt, i)=>{
    const btn = document.createElement("button");
    btn.className = "choiceBtn";
    btn.innerHTML = `<div style="display:flex;justify-content:space-between;gap:10px">
        <div>${escapeHtml(opt)}</div>
        <small>${["A","B","C"][i] || ""}</small>
      </div>`;
    btn.onclick = async ()=>{
      if(quizLocked) return;
      quizLocked = true;
      await unlockAudio();

      const correct = (i === q.a);
      if(correct){
        quizScore++;
        document.getElementById("scNow").textContent = quizScore;
        btn.classList.add("good");
        document.getElementById("hint").textContent = "âœ… Benar! Mantap!";
        sfxCorrect();
        starPopFromElement(btn);
      } else {
        btn.classList.add("bad");
        document.getElementById("hint").textContent = "âŒ Hampir! Yuk lanjut soal berikutnya.";
        sfxWrong();
        [...choicesEl.children].forEach((b, idx)=>{
          if(idx === q.a) b.classList.add("good");
        });
      }

      setTimeout(()=>{
        quizIdx++;
        quizLocked = false;
        if(quizIdx >= quizSet.length){
          const sess = getSession() || {};
          sess.score = { score: quizScore, total: quizSet.length };
          saveSession(sess);
          go("hasil");
          return;
        }
        render();
      }, 900);
    };
    choicesEl.appendChild(btn);
  });
}

/* ================== Diorama UI update ================== */
function updateDioramaUI(){
  const u=document.getElementById("uPct");
  if(!u) return;

  const percent = (telem?.ultra_percent ?? "-");

  // (3) clamp flow display max 6 L/menit di menu diorama
  let flowVal = (telem?.outA ? (Number(telem?.flow_lpm ?? 0)) : 0);
  if(!Number.isFinite(flowVal)) flowVal = 0;
  const flowClamped = Math.min(6, Math.max(0, flowVal));

  const A = !!telem?.outA, B = !!telem?.outB, C = !!telem?.outC, D = !!telem?.outD;
  const P2 = !!telem?.pompa2;

  document.getElementById("uPct").textContent = `${percent}%`;
  document.getElementById("fLpm").textContent = `${flowClamped.toFixed(1)} L/menit`;
  document.getElementById("outS").textContent =
    `A:${A?"ON":"OFF"} B:${B?"ON":"OFF"} C:${C?"ON":"OFF"} D:${D?"ON":"OFF"} | P2:${P2?"ON":"OFF"}`;

  // highlight tombol on/off
  const bA = document.getElementById("bA");
  const bB = document.getElementById("bB");
  const bC = document.getElementById("bC");
  const bD = document.getElementById("bD");
  if(bA) bA.classList.toggle("liveOn", A);
  if(bB) bB.classList.toggle("liveOn", B);
  if(bC) bC.classList.toggle("liveOn", C);
  if(bD) bD.classList.toggle("liveOn", D);

  // kalau P2 ON, pastikan C/D kelihatan terkunci (kalau render belum sempat)
  if(P2){
    if(bC){ bC.classList.add("lockedBtn"); bC.disabled = true; }
    if(bD){ bD.classList.add("lockedBtn"); bD.disabled = true; }
  }
}

/* ================== Footer Nav behavior ================== */
function updateFooterNav(){
  const order = ["home","proyek","siswa","diorama","guru","kisah"];
  const idx = order.indexOf(page);

  document.getElementById("btnBack").disabled = (historyStack.length <= 1);
  document.getElementById("btnNext").disabled = (idx < 0 || idx >= order.length-1);

  document.getElementById("btnBack").style.opacity = (historyStack.length<=1) ? .55 : 1;
  document.getElementById("btnNext").style.opacity = (idx<0 || idx>=order.length-1) ? .55 : 1;

  // (2) footer: blink tombol Home kalau sedang di home (indikator aktif)
  const homeBtn = document.getElementById("btnHome");
  if(homeBtn){
    homeBtn.classList.toggle("activeBlink", page==="home");
  }
}

/* ================== utils ================== */
function escapeHtml(s){
  return (s||"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

/* ================== footer buttons ================== */
document.getElementById("btnHome").onclick = (e)=>{
  blinkElement(e.currentTarget);
  page="home";
  historyStack=["home"];
  render();
};
document.getElementById("btnBack").onclick = (e)=>{ blinkElement(e.currentTarget); back(); };
document.getElementById("btnNext").onclick = (e)=>{
  blinkElement(e.currentTarget);
  const order = ["home","proyek","siswa","diorama","guru","kisah"];
  const idx = order.indexOf(page);
  if(idx >= 0 && idx < order.length-1) go(order[idx+1]);
};

/* ================== init ================== */
render();
</script>

</body>
</html>
