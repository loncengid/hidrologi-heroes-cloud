<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hidrologi Heroes ‚Äì Lacak si Tirta, Air Ajaib</title>

<style>
  :root{
    --bg1:#eaf3ff; --bg2:#fff1f7; --card:#ffffff;
    --ink:#0d2b45; --muted:#4b647a;
    --shadow:0 10px 22px rgba(0,0,0,.10);
    --r:20px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Arial;
    color:var(--ink);
    background:
      radial-gradient(900px 500px at 15% 0%, #cfe7ff 0%, transparent 60%),
      radial-gradient(900px 500px at 85% 0%, #ffd4e6 0%, transparent 60%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
    min-height:100vh;
  }
  header{
    position:sticky; top:0; z-index:10;
    background: linear-gradient(90deg, #4da3ff, #ff6fb1);
    color:#fff;
    padding:12px 14px;
    box-shadow:0 6px 14px rgba(0,0,0,.12);
  }
  .head{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    max-width:980px; margin:0 auto;
  }
  .brand{display:flex; align-items:center; gap:10px;}
  .logo{
    width:46px; height:46px; border-radius:16px;
    background: rgba(255,255,255,.20);
    display:grid; place-items:center;
    border:1px solid rgba(255,255,255,.35);
    overflow:hidden;
  }
  .logo img{width:100%; height:100%; object-fit:cover}
  .title h1{margin:0;font-size:18px;line-height:1.1}
  .title div{font-size:12px;opacity:.95}
  .badges{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
  .badge{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:999px;
    font-weight:800; font-size:13px;
    border:1px solid rgba(255,255,255,.40);
    background: rgba(255,255,255,.28);
    color:#08304f;
  }
  .badge small{font-weight:700; opacity:.9}

  main{
    max-width:980px; margin:0 auto;
    padding:16px; padding-bottom:110px;
  }
  .grid{display:grid; grid-template-columns: repeat(12, 1fr); gap:12px;}
  .card{
    background:var(--card);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    padding:16px;
    border:1px solid rgba(13,43,69,.08);
  }
  .hero{
    grid-column: span 12;
    padding:16px;
    background:
      radial-gradient(700px 220px at 20% 0%, rgba(255,255,255,.55) 0%, transparent 70%),
      linear-gradient(135deg, rgba(255,255,255,.35), rgba(255,255,255,.12));
    border:1px solid rgba(255,255,255,.35);
  }
  .heroRow{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; flex-wrap:wrap;
  }
  .mini{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.35}

  .ctaRow{
    display:grid;
    grid-template-columns: repeat(2, 1fr);
    gap:10px; margin-top:12px;
  }
  @media (max-width:700px){ .ctaRow{grid-template-columns: 1fr;} }

  .btn{
    border:none; cursor:pointer;
    border-radius:18px;
    padding:14px 14px;
    font-size:16px; font-weight:900;
    color:#fff;
    box-shadow:0 10px 18px rgba(0,0,0,.12);
    transition: transform .08s ease, filter .08s ease;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    user-select:none;
  }
  .btn:active{transform: scale(.98)}
  .btn span{display:inline-flex; align-items:center; gap:10px}
  .btn i{font-style:normal; font-size:18px}

  .b-blue{ background: linear-gradient(135deg, #2a7fff, #53d5ff); }
  .b-pink{ background: linear-gradient(135deg, #ff4fa3, #ff9ed0); }
  .b-green{background: linear-gradient(135deg, #20c997, #87f5d0); }
  .b-orange{background: linear-gradient(135deg, #ff9800, #ffd36a); }
  .b-purple{background: linear-gradient(135deg, #7c4dff, #caa8ff); }
  .b-red{background: linear-gradient(135deg, #ff3d3d, #ff8f8f); }

  .pill{
    border:none;
    padding:10px 12px;
    border-radius:999px;
    font-weight:900;
    cursor:pointer;
    background:#ffffff;
    border:1px solid rgba(13,43,69,.12);
    color:var(--ink);
    box-shadow:0 6px 12px rgba(0,0,0,.06);
  }
  .pill:active{transform:scale(.99)}
  .pill.primary{
    background: linear-gradient(135deg, #2a7fff, #53d5ff);
    color:#fff; border:none;
  }

  .h2{margin:0 0 8px;font-size:18px}

  .footer{
    position:fixed; left:0; right:0; bottom:0;
    background: rgba(255,255,255,.88);
    backdrop-filter: blur(10px);
    border-top:1px solid rgba(13,43,69,.08);
    padding:10px 12px;
    display:flex; gap:10px; justify-content:center;
    z-index:9;
  }

  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:94px; background:#111; color:#fff;
    padding:10px 14px; border-radius:999px;
    font-size:13px; opacity:0; pointer-events:none;
    transition:opacity .2s;
    z-index:10;
  }
  .toast.on{opacity:.9}

  .guide{
    position:fixed;
    right:14px;
    bottom:112px;
    display:flex;
    align-items:flex-end;
    gap:10px;
    z-index:20;
    user-select:none;
    touch-action:none;
  }
  .bubble{
    max-width:240px;
    background:rgba(255,255,255,.92);
    border:1px solid rgba(13,43,69,.10);
    border-radius:18px;
    padding:10px 12px;
    box-shadow:0 10px 18px rgba(0,0,0,.10);
    color:var(--ink);
    font-weight:900;
    font-size:12px;
    line-height:1.25;
    pointer-events:auto;
    cursor:pointer;
  }
  .bubble small{display:block; margin-top:6px; font-weight:800; opacity:.8}
  .guide img{
    width:64px; height:64px; border-radius:22px;
    background:#fff;
    border:1px solid rgba(13,43,69,.12);
    box-shadow:0 10px 18px rgba(0,0,0,.12);
    object-fit:cover;
    pointer-events:auto;
    cursor:grab;
  }
  .guide.dragging img{cursor:grabbing}
  .hideBubble .bubble{display:none}

  .floatTools{
    position:fixed; left:14px; bottom:112px;
    z-index:20; display:flex; gap:8px;
  }
  .miniBtn{
    border:none; cursor:pointer;
    border-radius:999px;
    padding:10px 12px;
    font-weight:1000;
    background:rgba(255,255,255,.92);
    border:1px solid rgba(13,43,69,.12);
    box-shadow:0 10px 18px rgba(0,0,0,.10);
  }

  .pinWrap{
    display:grid; gap:10px;
    padding:14px;
    border-radius:18px;
    border:1px dashed rgba(13,43,69,.18);
    background:rgba(255,255,255,.70);
  }
  .pinRow{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
  }
  .pinRow input{
    flex:1;
    padding:12px 14px;
    border-radius:16px;
    border:1px solid rgba(13,43,69,.12);
    font-weight:1000;
    font-size:16px;
    letter-spacing:2px;
    -webkit-text-security: disc; /* Safari */
  }
</style>
</head>

<body>
<header>
  <div class="head">
    <div class="brand">
      <div class="logo"><img id="tirtaLogo" alt="Tirta"></div>
      <div class="title">
        <h1>Hidrologi Heroes</h1>
        <div>Lacak si Tirta, Air Ajaib</div>
      </div>
    </div>

    <div class="badges">
      <button class="badge" id="btnMusic" title="Play/Pause musik" style="cursor:pointer">
        üéµ <small id="musicLabel">Play</small>
      </button>
      <div class="badge">üë• <small>Online:</small> <span id="hdrOnline">0</span></div>
      <div class="badge">üß† <small>Versi:</small> <span id="hdrVer">-</span></div>
    </div>
  </div>
</header>

<main id="app"></main>

<div class="footer">
  <button class="pill" id="btnBack">‚¨Ö Back</button>
  <button class="pill primary" id="btnHome">üè† Home</button>
  <button class="pill" id="btnNext">Next ‚û°</button>
</div>

<div id="toast" class="toast">OK</div>

<div class="floatTools">
  <button class="miniBtn" id="btnResetTirta" title="Kembalikan posisi Tirta">üíß Reset Tirta</button>
</div>

<div class="guide" id="guide">
  <div class="bubble" id="guideText" title="Klik untuk sembunyikan/tampilkan chat">
    Hai! Aku Tirta üíß Klik menu yang kamu mau ya!
    <small>(drag aku kalau nutup tombol)</small>
  </div>
  <img id="tirtaGuide" alt="Tirta Guide">
</div>

<audio id="bgm" preload="auto" loop></audio>

<script>
/* ================== ASSET URLS (RAW GitHub) ================== */
const ASSETS_BASE = "https://raw.githubusercontent.com/loncengid/Hidrologi-Heroes-Assets/main/";
const IMG_TIRTA   = ASSETS_BASE + "karakter%20tirta.png";
const AUDIO_BGM   = ASSETS_BASE + "audio%20niseef.mp3";

/* ================== PIN ================== */
const DIORAMA_PIN = "654321";
const STORAGE_DIORAMA_OK = "hh_diorama_ok";

/* ================== SET ASSETS ================== */
document.getElementById("tirtaLogo").src  = IMG_TIRTA;
document.getElementById("tirtaGuide").src = IMG_TIRTA;

const bgm = document.getElementById("bgm");
bgm.src = AUDIO_BGM;
bgm.volume = 0.35;

let musicOn = false;
async function toggleMusic(){
  try{
    if(!musicOn){
      await bgm.play();
      musicOn = true;
      document.getElementById("musicLabel").textContent = "Pause";
      toast("üéµ Musik ON");
    }else{
      bgm.pause();
      musicOn = false;
      document.getElementById("musicLabel").textContent = "Play";
      toast("üîá Musik OFF");
    }
  }catch(e){
    toast("‚ö†Ô∏è Browser blokir audio. Klik lagi ya.");
  }
}
document.getElementById("btnMusic").onclick = toggleMusic;

/* ================== TOAST ================== */
let toastT=null;
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("on");
  clearTimeout(toastT);
  toastT=setTimeout(()=>t.classList.remove("on"),900);
}

/* ================== Tirta draggable + persist ================== */
const guide = document.getElementById("guide");
const bubble = document.getElementById("guideText");
const tirta = document.getElementById("tirtaGuide");
const STORAGE_POS = "hh_tirta_pos";
const STORAGE_BUB = "hh_tirta_bubble_hidden";

function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

function applySavedTirtaPos(){
  const raw = localStorage.getItem(STORAGE_POS);
  if(!raw) return;
  try{
    const p = JSON.parse(raw);
    if(typeof p?.x !== "number" || typeof p?.y !== "number") return;
    guide.style.left = p.x + "px";
    guide.style.top  = p.y + "px";
    guide.style.right = "auto";
    guide.style.bottom = "auto";
  }catch(e){}
}
function saveTirtaPos(x,y){
  localStorage.setItem(STORAGE_POS, JSON.stringify({x,y}));
}
function resetTirta(){
  localStorage.removeItem(STORAGE_POS);
  guide.style.left = "";
  guide.style.top  = "";
  guide.style.right = "14px";
  guide.style.bottom = "112px";
  guide.style.position = "fixed";
  toast("üíß Tirta balik ke posisi awal");
}
document.getElementById("btnResetTirta").onclick = resetTirta;

function applyBubbleHidden(){
  const hidden = localStorage.getItem(STORAGE_BUB) === "1";
  guide.classList.toggle("hideBubble", hidden);
}
bubble.onclick = ()=>{
  const nowHidden = !guide.classList.contains("hideBubble");
  guide.classList.toggle("hideBubble", nowHidden);
  localStorage.setItem(STORAGE_BUB, nowHidden ? "1" : "0");
};

applySavedTirtaPos();
applyBubbleHidden();

let dragging = false;
let startX=0, startY=0, baseX=0, baseY=0;

function getGuideXY(){
  const r = guide.getBoundingClientRect();
  return {x: r.left, y: r.top, w:r.width, h:r.height};
}

function onDragStart(clientX, clientY){
  dragging = true;
  guide.classList.add("dragging");
  const g = getGuideXY();
  startX = clientX;
  startY = clientY;
  baseX = g.x;
  baseY = g.y;
}

function onDragMove(clientX, clientY){
  if(!dragging) return;
  const dx = clientX - startX;
  const dy = clientY - startY;

  const g = getGuideXY();
  const w = g.w, h = g.h;

  const maxX = window.innerWidth  - w - 6;
  const maxY = window.innerHeight - h - 96;

  let nx = clamp(baseX + dx, 6, maxX);
  let ny = clamp(baseY + dy, 6, maxY);

  guide.style.left = nx + "px";
  guide.style.top  = ny + "px";
  guide.style.right = "auto";
  guide.style.bottom = "auto";

  saveTirtaPos(nx, ny);
}

function snapToEdge(){
  if(!localStorage.getItem(STORAGE_POS)) return;
  const g = getGuideXY();
  const edge = (g.x + g.w/2 < window.innerWidth/2) ? 6 : (window.innerWidth - g.w - 6);
  guide.style.left = edge + "px";
  guide.style.right = "auto";
  saveTirtaPos(edge, g.y);
}

function onDragEnd(){
  if(!dragging) return;
  dragging = false;
  guide.classList.remove("dragging");
  snapToEdge();
}

tirta.addEventListener("pointerdown", (e)=>{
  e.preventDefault();
  tirta.setPointerCapture(e.pointerId);
  onDragStart(e.clientX, e.clientY);
});
tirta.addEventListener("pointermove", (e)=> onDragMove(e.clientX, e.clientY));
tirta.addEventListener("pointerup", ()=> onDragEnd());
tirta.addEventListener("pointercancel", ()=> onDragEnd());

window.addEventListener("resize", ()=>{
  const raw = localStorage.getItem(STORAGE_POS);
  if(!raw) return;
  try{
    const p = JSON.parse(raw);
    const g = getGuideXY();
    const maxX = window.innerWidth  - g.w - 6;
    const maxY = window.innerHeight - g.h - 96;
    const nx = clamp(p.x, 6, maxX);
    const ny = clamp(p.y, 6, maxY);
    guide.style.left = nx + "px";
    guide.style.top  = ny + "px";
    saveTirtaPos(nx, ny);
  }catch(e){}
});

/* ================== KONFIG RTDB (REST) ================== */
const DB_BASE   = "https://hidrologi-heroes-default-rtdb.asia-southeast1.firebasedatabase.app";
const DEVICE_ID = "niseef_v12_01";
const PATH_CMD   = `/devices/${DEVICE_ID}/cmd`;
const PATH_TELEM = `/devices/${DEVICE_ID}/telemetry`;
const PATH_PRES  = `/devices/${DEVICE_ID}/presence/lastActiveMs`;

/* =============== HELPERS REST =============== */
async function rtdbGet(path){
  const res = await fetch(`${DB_BASE}${path}.json`, { cache:"no-store" });
  return await res.json();
}
async function rtdbPut(path, obj){
  await fetch(`${DB_BASE}${path}.json`, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(obj)
  });
}
async function rtdbPatch(path, obj){
  await fetch(`${DB_BASE}${path}.json`, {
    method:"PATCH",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(obj)
  });
}

/* ================== ONLINE COUNTER ================== */
const cid = "c_" + Math.random().toString(36).slice(2);
let onlineCount = 0;

async function heartbeatOnline(){
  try{ await rtdbPatch(`/online/${cid}`, { ts: Date.now() }); }catch(e){}
}
heartbeatOnline();
setInterval(heartbeatOnline, 5000);

async function pollOnline(){
  try{
    const o = await rtdbGet("/online");
    const now = Date.now();
    let n=0;
    if(o){
      for(const k in o){
        if(now - (o[k]?.ts||0) < 15000) n++;
      }
    }
    onlineCount = n;
    document.getElementById("hdrOnline").textContent = onlineCount;
  }catch(e){}
}
pollOnline();
setInterval(pollOnline, 3000);

/* ================== PRESENCE KE DEVICE ================== */
async function heartbeatPresence(){
  try{ await rtdbPut(PATH_PRES, Date.now()); }catch(e){}
}
heartbeatPresence();
setInterval(heartbeatPresence, 5000);

/* ================== DEVICE STATE ================== */
let telem = null;
let seq = 0;

async function sendCmd(patch){
  seq++;
  try{
    await rtdbPatch(PATH_CMD, { seq, ts: Date.now(), ...patch });
    toast("‚úÖ Terkirim ke perangkat");
  }catch(e){
    toast("‚ö†Ô∏è Gagal kirim");
  }
}

async function pollTelem(){
  try{
    telem = await rtdbGet(PATH_TELEM);
    document.getElementById("hdrVer").textContent = telem?.version || "-";
    if(page==="diorama") updateDioramaUI();
  }catch(e){}
}
pollTelem();
setInterval(pollTelem, 1000);

/* ================== NAV STATE ================== */
let page = "home";
let historyStack = ["home"];

function setGuide(text){
  document.getElementById("guideText").childNodes[0].textContent = text + " ";
}
function go(p){
  if(page !== p){
    historyStack.push(p);
    page = p;
    render();
  }
}
function back(){
  if(historyStack.length > 1){
    historyStack.pop();
    page = historyStack[historyStack.length-1];
    render();
  } else {
    page="home"; render();
  }
}

/* ================== AUTH (session-only) ================== */
function dioramaAllowed(){ return sessionStorage.getItem(STORAGE_DIORAMA_OK) === "1"; }
function setDioramaAllowed(ok){ sessionStorage.setItem(STORAGE_DIORAMA_OK, ok ? "1" : "0"); }

/* ================== PAGES RENDER ================== */
function render(){
  const app = document.getElementById("app");
  app.innerHTML = "";

  if(page==="home"){
    setGuide("Hai! Aku Tirta üíß Klik menu Diorama untuk kontrol A‚ÄìD ya üòÑ");
    app.innerHTML = `
      <div class="grid">
        <div class="card hero">
          <div class="heroRow">
            <div>
              <div class="h2">Halo! Aku Tirta üíß</div>
              <div class="mini">Diorama: A‚ÄìD bisa manual. LD & P2 jalan otomatis (disembunyikan).</div>
            </div>
            <div class="badges">
              <div class="badge">üë• <small>Online:</small> <span>${onlineCount}</span></div>
              <div class="badge">üì° <small>Device:</small> <span>${telem?.version || "-"}</span></div>
            </div>
          </div>

          <div class="ctaRow">
            <button class="btn b-orange" id="mDiorama"><span><i>üé•</i> Diorama</span><span>‚û°</span></button>
          </div>

          <div class="mini">Tip: Menu bertingkat. Pakai tombol Back / Home / Next di bawah.</div>
        </div>
      </div>
    `;
    document.getElementById("mDiorama").onclick=()=>go("diorama");
  }

  if(page==="diorama"){
    const ok = dioramaAllowed();

    if(!ok){
      setGuide("Menu Diorama terkunci üîí Masukkan PIN dulu ya üôÇ");
      app.innerHTML = `
        <div class="card">
          <div class="h2">üé• Diorama (Terkunci)</div>
          <div class="mini">Kontrol diorama dibuka pakai PIN.</div>
        </div>

        <div class="card">
          <div class="pinWrap">
            <div style="font-weight:1000">üîí Masukkan PIN Diorama</div>
            <div class="mini">Hanya orang yang punya PIN yang bisa menyalakan A‚ÄìD.</div>

            <div class="pinRow">
              <input id="pinInput" type="password" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6">
              <button class="btn b-orange" id="btnPin" style="flex:0 0 auto;min-width:160px">
                <span><i>‚úÖ</i> Buka</span><span>‚û°</span>
              </button>
            </div>

            <div class="mini" id="pinMsg" style="font-weight:1000"></div>
          </div>
        </div>
      `;

      const pinEl = document.getElementById("pinInput");
      const msgEl = document.getElementById("pinMsg");
      const btnEl = document.getElementById("btnPin");

      const tryPin = ()=>{
        const entered = (pinEl.value||"").trim();
        if(entered === DIORAMA_PIN){
          setDioramaAllowed(true);
          msgEl.style.color = "#0c7a5c";
          msgEl.textContent = "Selamat berpetualang di dunia Hidrologi Heroes";
          toast("üîì Diorama terbuka!");
          setTimeout(()=>render(), 250);
        }else{
          msgEl.style.color = "#b02020";
          msgEl.textContent = "Anda memasukkan PIN yang salah";
          toast("‚ùå PIN salah");
          pinEl.value = "";
          pinEl.focus();
        }
      };

      btnEl.onclick = tryPin;
      pinEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter") tryPin(); });

      return updateFooterNav();
    }

    setGuide("Klik tombol A‚ÄìD ya! Pompa Banjir untuk paksa pompa ON üö∞");
    app.innerHTML = `
      <div class="card">
        <div class="h2">üé• Diorama (Unlocked)</div>
        <div class="mini">A‚ÄìD manual. LD & P2 otomatis (tombolnya disembunyikan).</div>
        <div style="height:10px"></div>
        <button class="pill" id="btnLock" title="Kunci lagi Diorama">üîí Kunci Lagi</button>
      </div>

      <div class="card">
        <div class="grid">
          <div class="card" style="grid-column:span 6;background:linear-gradient(135deg,rgba(42,127,255,.10),rgba(83,213,255,.08))">
            <div style="font-weight:1000">üìè Ultrasonic</div>
            <div id="uPct" style="font-size:34px;font-weight:1000;margin-top:6px">- %</div>
            <div class="mini">Tinggi air (persen)</div>
          </div>

          <div class="card" style="grid-column:span 6;background:linear-gradient(135deg,rgba(32,201,151,.10),rgba(135,245,208,.08))">
            <div style="font-weight:1000">üí¶ Flow</div>
            <div id="fLpm" style="font-size:34px;font-weight:1000;margin-top:6px">-</div>
            <div class="mini">L/menit</div>
          </div>

          <div class="card" style="grid-column:span 12;background:rgba(255,255,255,.70)">
            <div style="font-weight:1000;margin-bottom:8px">üîå Status Output</div>
            <div class="mini" id="outS">A:- B:- C:- D:- | LD:- P2:-</div>
            <div class="mini" id="pOv" style="margin-top:6px;font-weight:1000">Pompa Banjir: -</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="grid">
          <button class="btn b-blue"   id="bA"   style="grid-column:span 6"><span><i>üî¥</i> Evaporasi (A)</span><span>Tap</span></button>
          <button class="btn b-purple" id="bB"   style="grid-column:span 6"><span><i>üîµ</i> Kondensasi (B)</span><span>Tap</span></button>
          <button class="btn b-orange" id="bC"   style="grid-column:span 6"><span><i>üü°</i> Presipitasi (C)</span><span>Tap</span></button>
          <button class="btn b-pink"   id="bD"   style="grid-column:span 6"><span><i>‚ö™</i> Banjir (D)</span><span>Tap</span></button>

          <button class="btn b-green"  id="bOn"  style="grid-column:span 6"><span><i>‚úÖ</i> Hidupkan Semua</span><span>Tap</span></button>
          <button class="btn b-red"    id="bOff" style="grid-column:span 6"><span><i>‚õî</i> Matikan Semua</span><span>Tap</span></button>

          <button class="btn b-red"    id="bPump" style="grid-column:span 12"><span><i>üö∞</i> Pompa Banjir</span><span>Toggle</span></button>
        </div>

        <div class="mini" style="margin-top:10px">
          Pompa Banjir = paksa P2 ON (override). Klik lagi untuk balik otomatis.
        </div>
      </div>
    `;

    document.getElementById("btnLock").onclick = ()=>{
      setDioramaAllowed(false);
      toast("üîí Diorama dikunci");
      render();
    };

    // Commands sesuai ESP32 v12.6
    document.getElementById("bA").onclick   = ()=>sendCmd({k:"A"});
    document.getElementById("bB").onclick   = ()=>sendCmd({k:"B"});
    document.getElementById("bC").onclick   = ()=>sendCmd({k:"C"});
    document.getElementById("bD").onclick   = ()=>sendCmd({k:"D"});
    document.getElementById("bOn").onclick  = ()=>sendCmd({k:"ALLON"});
    document.getElementById("bOff").onclick = ()=>sendCmd({k:"ALLOFF"});
    document.getElementById("bPump").onclick= ()=>sendCmd({k:"PUMP"});

    updateDioramaUI();
  }

  updateFooterNav();
}

/* ================== Diorama UI update ================== */
function updateDioramaUI(){
  const u=document.getElementById("uPct");
  if(!u) return;

  const percent = (telem?.ultra_percent ?? "-");
  const flow = (telem?.flow_lpm ?? "-");

  const A = !!telem?.outA, B = !!telem?.outB, C = !!telem?.outC, D = !!telem?.outD;
  const LD = !!telem?.lampuDesa, P2 = !!telem?.pompa2;
  const OV = !!telem?.pumpOverride;

  document.getElementById("uPct").textContent = `${percent}%`;
  document.getElementById("fLpm").textContent = `${flow} L/menit`;
  document.getElementById("outS").textContent =
    `A:${A?"ON":"OFF"} B:${B?"ON":"OFF"} C:${C?"ON":"OFF"} D:${D?"ON":"OFF"} | LD:${LD?"ON":"OFF"} P2:${P2?"ON":"OFF"}`;

  const pOv = document.getElementById("pOv");
  if(pOv) pOv.textContent = `Pompa Banjir: ${OV ? "ON (Override)" : "OFF (Auto)"}`;

  const pumpBtn = document.getElementById("bPump");
  if(pumpBtn){
    pumpBtn.style.opacity = OV ? "1" : "0.92";
  }
}

/* ================== Footer Nav behavior ================== */
function updateFooterNav(){
  const order = ["home","diorama"];
  const idx = order.indexOf(page);

  document.getElementById("btnBack").disabled = (historyStack.length <= 1);
  document.getElementById("btnNext").disabled = (idx < 0 || idx >= order.length-1);

  document.getElementById("btnBack").style.opacity = (historyStack.length<=1) ? .55 : 1;
  document.getElementById("btnNext").style.opacity = (idx<0 || idx>=order.length-1) ? .55 : 1;
}

/* ================== footer buttons ================== */
document.getElementById("btnHome").onclick = ()=>{
  page="home";
  historyStack=["home"];
  render();
};
document.getElementById("btnBack").onclick = ()=>back();
document.getElementById("btnNext").onclick = ()=>{
  const order = ["home","diorama"];
  const idx = order.indexOf(page);
  if(idx >= 0 && idx < order.length-1) go(order[idx+1]);
};

/* ================== init ================== */
render();
</script>

</body>
</html>
