<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hirdologi Heroes : Lacak si Tirta, Air Ajaib</title>
  <style>
    :root{--bg:#0b1220;--card:#111b33;--line:#22345f;--btn:#16244a;--btnOn:#2c5cff;--txt:#e8eefc;}
    body{font-family:system-ui,Segoe UI,Arial;margin:16px;background:var(--bg);color:var(--txt)}
    h1{font-size:18px;margin:0 0 12px 0}
    .nav{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .tab{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0e1833;color:var(--txt);font-weight:800}
    .tab.active{background:var(--btnOn);border-color:var(--btnOn)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{flex:1;min-width:140px;padding:12px;border-radius:12px;border:1px solid #2c4278;background:var(--btn);color:var(--txt);font-weight:800}
    .btn.on{background:var(--btnOn);border-color:var(--btnOn)}
    .small{opacity:.9;font-size:13px}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2c4278;background:#0e1833;color:var(--txt);box-sizing:border-box}
    textarea{min-height:82px}
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .kv>div{background:#0e1833;border:1px solid var(--line);border-radius:10px;padding:10px}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .badge{display:inline-block;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#0e1833;font-size:12px}
    .hide{display:none}
  </style>
</head>
<body>
<h1>Hirdologi Heroes : Lacak si Tirta, Air Ajaib</h1>

<div class="nav">
  <button class="tab active" id="t-proyek">Penjelasan Proyek</button>
  <button class="tab" id="t-siswa">Siswa</button>
  <button class="tab" id="t-guru">Guru</button>
  <button class="tab" id="t-diorama">Diorama</button>
</div>

<div class="card" id="p-proyek">
  <div class="badge">Materi</div>
  <h2 style="margin:8px 0;font-size:16px">Penjelasan Proyek</h2>
  <div class="small">
    <b>Evaporasi</b> = penguapan air karena panas matahari.<br><br>
    <b>Kondensasi</b> = pengembunan uap air menjadi awan.<br><br>
    <b>Presipitasi</b> = turunnya air dari awan (hujan).<br><br>
    <b>Aliran Air</b> = air hujan mengalir melalui sungai hingga ke laut.<br><br>
    <b>Banjir</b> = air berlebih dan tidak tertampung/terkelola.<br><br>
    <b>PLTMH (Mikrohidro)</b> = aliran air menghasilkan listrik.
  </div>
</div>

<div class="card hide" id="p-siswa">
  <div class="badge">Siswa</div>
  <h2 style="margin:8px 0;font-size:16px">Data Siswa</h2>
  <div class="row">
    <div style="flex:1;min-width:220px">
      <div class="small">Nama</div>
      <input id="s-nama" placeholder="contoh: Aulia"/>
    </div>
    <div style="flex:1;min-width:120px">
      <div class="small">Kelas</div>
      <input id="s-kelas" placeholder="contoh: 5A"/>
    </div>
  </div>
  <div style="height:10px"></div>
  <button class="btn" id="btn-mulai">Mulai Kuis</button>
  <div class="hr"></div>
  <div class="badge">Kuis</div>
  <div id="quiz-area" class="small">Klik ‚ÄúMulai Kuis‚Äù.</div>
</div>

<div class="card hide" id="p-guru">
  <div class="badge">Guru</div>
  <h2 style="margin:8px 0;font-size:16px">Panel Guru</h2>

  <div id="guru-login">
    <div class="small">Masukkan PIN</div>
    <div class="row">
      <div style="flex:1"><input id="g-pin" placeholder="PIN" /></div>
      <div style="width:140px"><button class="btn" id="btn-guru">Masuk</button></div>
    </div>
    <div class="small" id="g-status" style="margin-top:8px"></div>
  </div>

  <div id="guru-panel" class="hide">
    <div class="row">
      <button class="btn" id="btn-score">Lihat Score</button>
      <button class="btn" id="btn-edit">Edit Soal</button>
      <button class="btn" id="btn-add">Tambahkan Soal</button>
    </div>

    <div class="hr"></div>
    <div class="badge">Score (session)</div>
    <div id="score-area" class="small">Belum dimuat.</div>

    <div class="hr"></div>
    <div class="badge">Soal</div>
    <div id="teacher-quiz-area" class="small">Belum dimuat.</div>

    <div class="hr"></div>
    <div class="badge">Tambah Soal</div>
    <div class="small">
      <div class="small">Pertanyaan</div>
      <textarea id="add-q" placeholder="contoh: Apa yang disebut evaporasi?"></textarea>
      <div style="height:8px"></div>
      <div class="small">Jawaban (kata kunci)</div>
      <input id="add-a" placeholder="contoh: penguapan"/>
      <div style="height:8px"></div>
      <button class="btn" id="btn-save-q">Simpan Soal</button>
      <div class="small" id="add-status" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<div class="card hide" id="p-diorama">
  <div class="badge">NISEEF v12 ONLINE</div>
  <h2 style="margin:8px 0;font-size:16px">Diorama</h2>

  <div class="row">
    <button id="A" class="btn">Evaporasi (A)</button>
    <button id="B" class="btn">Kondensasi (B)</button>
    <button id="C" class="btn">Presipitasi (C)</button>
    <button id="D" class="btn">Banjir (D)</button>
  </div>

  <div style="height:10px"></div>
  <div class="row">
    <button id="LD" class="btn">Lampu Desa</button>
    <button id="P2" class="btn">Pompa2</button>
    <button id="OFF" class="btn">ALL OFF</button>
  </div>

  <div style="height:10px"></div>
  <div class="small">Mode Sistem</div>
  <select id="mode">
    <option value="demo">demo</option>
    <option value="edukasi">edukasi</option>
    <option value="otomatis" selected>otomatis</option>
    <option value="maintenance">maintenance</option>
  </select>

  <div style="height:10px"></div>
  <div class="small">State (khusus demo/edukasi)</div>
  <select id="state">
    <option value="idle">idle</option>
    <option value="evaporasi">evaporasi</option>
    <option value="kondensasi">kondensasi</option>
    <option value="presipitasi">presipitasi</option>
    <option value="aliran">aliran</option>
    <option value="banjir">banjir</option>
  </select>

  <div class="hr"></div>
  <div class="kv" id="kv"></div>
  <div class="small" id="net">connecting...</div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getDatabase, ref, onValue, get, set, update } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

  // ===== Config Boss (FIX) =====
  const firebaseConfig = {
    apiKey: "AIzaSyCbKNlViQO-BRj818y-sNd7LjvMkf6Q0Wg",
    authDomain: "hidrologi-heroes.firebaseapp.com",
    databaseURL: "https://hidrologi-heroes-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "hidrologi-heroes",
    storageBucket: "hidrologi-heroes.firebasestorage.app",
    messagingSenderId: "349578733020",
    appId: "1:349578733020:web:df27bed634e6bdefd5db19",
    measurementId: "G-HMVQ476SYS"
  };

  // ===== Settings =====
  const DEVICE_ID = "niseef_v12_01";
  const TEACHER_PIN = "1234"; // demo-only (client-side)
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const PATH_TELEM = `devices/${DEVICE_ID}/telemetry`;
  const PATH_CMD   = `devices/${DEVICE_ID}/cmd`;
  const PATH_Q     = `quiz/questions`;
  const PATH_LAST  = `quiz/lastScore`;

  const $ = (id)=>document.getElementById(id);
  const escapeHtml = (s)=> (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

  // ===== Tabs =====
  function showTab(active){
    ["proyek","siswa","guru","diorama"].forEach(k=>{
      $("t-"+k).classList.toggle("active", k===active);
      $("p-"+k).classList.toggle("hide", k!==active);
    });
  }
  $("t-proyek").onclick = ()=>showTab("proyek");
  $("t-siswa").onclick  = ()=>showTab("siswa");
  $("t-guru").onclick   = ()=>showTab("guru");
  $("t-diorama").onclick= ()=>showTab("diorama");

  // ===== Diorama telemetry =====
  function setBtn(id,on){ const b=$(id); if(!b) return; b.classList.toggle("on", !!on); }

  onValue(ref(db, PATH_TELEM), (snap)=>{
    const t = snap.val();
    if(!t){ $("net").innerText="telemetry belum ada"; return; }
    $("net").innerText="online ‚úÖ";

    setBtn("A", t.outA); setBtn("B", t.outB); setBtn("C", t.outC); setBtn("D", t.outD);
    setBtn("LD", t.lampuDesa); setBtn("P2", t.pompa2);

    if(t.mode) $("mode").value = t.mode;
    if(t.state) $("state").value = t.state;

    $("kv").innerHTML = `
      <div><b>Flow avg</b><br>${(+t.flowAvg||0).toFixed(2)} L/min</div>
      <div><b>Flow inst</b><br>${(+t.flowInst||0).toFixed(2)} L/min</div>
      <div><b>Level</b><br>${(+t.level||0).toFixed(1)} %</div>
      <div><b>Ultrasonic</b><br>${(+t.ultraCm||0).toFixed(1)} cm</div>
      <div><b>Mode</b><br>${escapeHtml(t.mode||"")}</div>
      <div><b>State</b><br>${escapeHtml(t.state||"")}</div>
      <div><b>Safe</b><br>${t.safeMode ? "ON" : "OFF"} ${t.fault? " | "+escapeHtml(t.fault):""}</div>
      <div><b>Version</b><br>${escapeHtml(t.version||"")}</div>
    `;
  });

  // Command sender (seq++)
  let seq = 0;
  async function sendCmd(patch){
    seq++;
    await update(ref(db, PATH_CMD), { ...patch, seq });
  }

  $("A").onclick = ()=>sendCmd({k:"A"});
  $("B").onclick = ()=>sendCmd({k:"B"});
  $("C").onclick = ()=>sendCmd({k:"C"});
  $("D").onclick = ()=>sendCmd({k:"D"});
  $("LD").onclick= ()=>sendCmd({k:"LD"});
  $("P2").onclick= ()=>sendCmd({k:"P2"});
  $("OFF").onclick=()=>sendCmd({k:"ALLOFF"});

  $("mode").onchange = (e)=>sendCmd({mode:e.target.value});
  $("state").onchange= (e)=>sendCmd({state:e.target.value});

  // ===== Quiz (UI scoring) =====
  async function loadQuestions(){
    const snap = await get(ref(db, PATH_Q));
    const items = snap.val();
    if(!items) return [];
    if(Array.isArray(items)) return items.filter(Boolean);
    return Object.values(items).filter(Boolean);
  }

  function norm(s){
    return (s||"").toString().toLowerCase().trim().replace(/\s+/g," ");
  }

  $("btn-mulai").onclick = async ()=>{
    const nama = ($("s-nama").value||"").trim();
    const kelas= ($("s-kelas").value||"").trim();
    if(!nama || !kelas){
      $("quiz-area").innerHTML = "Isi <b>Nama</b> dan <b>Kelas</b> dulu ya üôÇ";
      return;
    }
    const qs = await loadQuestions();
    if(!qs.length){
      $("quiz-area").innerHTML = "Soal masih kosong (guru belum input).";
      return;
    }
    let html = `<div class="small">Nama: <b>${escapeHtml(nama)}</b> | Kelas: <b>${escapeHtml(kelas)}</b></div><div style="height:8px"></div>`;
    qs.forEach((it,idx)=>{
      html += `<div style="margin-bottom:10px"><b>${idx+1}. ${escapeHtml(it.q||"")}</b><br>
               <input id="ans-${idx}" placeholder="jawaban..."/></div>`;
    });
    html += `<button class="btn" id="btn-submit">Kirim Jawaban</button>
             <div class="small" id="quiz-status" style="margin-top:8px"></div>`;
    $("quiz-area").innerHTML = html;

    $("btn-submit").onclick = async ()=>{
      const answers = qs.map((_,i)=> (document.getElementById(`ans-${i}`).value||""));
      let score = 0;
      qs.forEach((it,i)=>{
        const key = norm(it.a||"");
        const user= norm(answers[i]);
        if(key && user.includes(key)) score++;
      });
      const total = qs.length;

      await set(ref(db, PATH_LAST), {
        name:nama, kelas:kelas, score, total,
        ts: Date.now()
      });

      $("quiz-status").innerText = `Score kamu: ${score}/${total}`;
    };
  };

  // ===== Guru =====
  let guruOk = false;

  $("btn-guru").onclick = ()=>{
    const pin = ($("g-pin").value||"").trim();
    if(pin !== TEACHER_PIN){
      $("g-status").innerText = "PIN salah.";
      return;
    }
    guruOk = true;
    $("g-status").innerText = "OK. Panel Guru aktif.";
    $("guru-login").classList.add("hide");
    $("guru-panel").classList.remove("hide");
  };

  $("btn-score").onclick = async ()=>{
    const snap = await get(ref(db, PATH_LAST));
    const j = snap.val();
    if(!j){ $("score-area").innerHTML = "Belum ada siswa submit kuis."; return; }
    $("score-area").innerHTML =
      `Score terakhir:<br>
       Nama: <b>${escapeHtml(j.name||"")}</b><br>
       Kelas: <b>${escapeHtml(j.kelas||"")}</b><br>
       Score: <b>${j.score||0}/${j.total||0}</b>`;
  };

  async function renderTeacherQuestions(){
    const qs = await loadQuestions();
    if(!qs.length){ $("teacher-quiz-area").innerHTML = "Soal kosong."; return; }

    let html = "";
    qs.forEach((it,idx)=>{
      html += `<div style="margin-bottom:12px;border:1px solid #22345f;border-radius:12px;padding:10px;background:#0e1833">
        <div class="small"><b>#${idx+1}</b></div>
        <div class="small">Pertanyaan</div>
        <textarea id="q-${idx}">${escapeHtml(it.q||"")}</textarea>
        <div style="height:6px"></div>
        <div class="small">Jawaban (kata kunci)</div>
        <input id="a-${idx}" value="${escapeHtml(it.a||"")}"/>
        <div style="height:8px"></div>
        <button class="btn" id="save-${idx}">Simpan Perubahan</button>
      </div>`;
    });
    $("teacher-quiz-area").innerHTML = html;

    qs.forEach((_,idx)=>{
      document.getElementById(`save-${idx}`).onclick = async ()=>{
        const q = (document.getElementById(`q-${idx}`).value||"").trim();
        const a = (document.getElementById(`a-${idx}`).value||"").trim();
        const snap = await get(ref(db, PATH_Q));
        let raw = snap.val();

        let arr = [];
        if(Array.isArray(raw)) arr = raw.filter(Boolean);
        else if(raw) arr = Object.values(raw).filter(Boolean);

        arr[idx] = { q, a };
        await set(ref(db, PATH_Q), arr);
        $("teacher-quiz-area").insertAdjacentHTML("afterbegin", `<div class="small">‚úÖ Soal #${idx+1} tersimpan.</div><div style="height:8px"></div>`);
      };
    });
  }

  $("btn-edit").onclick = async ()=>{
    if(!guruOk) return;
    await renderTeacherQuestions();
  };

  $("btn-add").onclick = ()=> $("add-q").focus();

  $("btn-save-q").onclick = async ()=>{
    if(!guruOk) return;
    const q = ($("add-q").value||"").trim();
    const a = ($("add-a").value||"").trim();
    if(!q || !a){ $("add-status").innerText="Pertanyaan & jawaban wajib diisi."; return; }

    const qs = await loadQuestions();
    qs.push({q,a});
    await set(ref(db, PATH_Q), qs);

    $("add-q").value=""; $("add-a").value="";
    $("add-status").innerText="Soal ditambahkan ‚úÖ";
    await renderTeacherQuestions();
  };

  // Init seed data (first run)
  (async ()=>{
    const s = await get(ref(db, PATH_CMD));
    if(!s.exists()){
      await set(ref(db, PATH_CMD), { seq:0, mode:"otomatis", state:"idle", k:"" });
    }
    const q = await get(ref(db, PATH_Q));
    if(!q.exists()){
      await set(ref(db, PATH_Q), [
        { q:"Apa yang disebut evaporasi?", a:"penguapan" },
        { q:"Apa yang disebut kondensasi?", a:"pengembunan" },
        { q:"Apa yang disebut presipitasi?", a:"hujan" },
        { q:"Apa manfaat PLTMH/mikrohidro?", a:"listrik" }
      ]);
    }
  })();
</script>
</body>
</html>
