<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Hidrologi Heroes Dashboard - NISEEF v8</title>

  <style>
    :root{
      --bgcard: rgba(0,0,0,.75);
      --hi:#00d4ff;
      --txt:#fff;
      --mut: rgba(255,255,255,.85);
      --bd: rgba(255,255,255,.25);
      --panel: rgba(0,0,0,.55);
      --ok:#2ecc71; --bad:#ff4757; --warn:#ffa502;
    }
    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin:0; color:var(--txt);
      background:url('https://raw.githubusercontent.com/loncengid/Hidrologi-Heroes-Assets/main/background%20plmth.png') no-repeat center center fixed;
      background-size:cover;
    }
    .container{ min-height:100vh; padding:18px; display:flex; flex-direction:column; align-items:center; gap:14px; }
    .card{
      width:min(620px, 96vw);
      background:var(--bgcard);
      backdrop-filter: blur(15px);
      border-radius:22px;
      border:2px solid var(--hi);
      padding:16px;
      box-shadow: 0 10px 40px rgba(0,0,0,.6);
      display:none;
    }
    .card.active{ display:block; animation: up .25s ease-out; }
    @keyframes up{ from{ opacity:0; transform: translateY(10px);} to{ opacity:1; transform:none;} }

    h1,h2,h3{ margin:0 0 10px 0; font-weight:1000; text-transform:uppercase; text-shadow:3px 3px 6px rgba(0,0,0,.8); }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .sub{ font-size:12px; color:var(--mut); font-weight:800; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      background: rgba(0,0,0,.45);
      border:1px solid var(--bd);
      font-weight:1000; font-size:12px;
      white-space:nowrap;
    }
    .dot{ width:10px; height:10px; border-radius:50%; background:var(--warn); box-shadow:0 0 0 3px rgba(255,255,255,.08); }
    .dot.ok{ background:var(--ok); }
    .dot.bad{ background:var(--bad); }

    .status{
      background: var(--panel);
      border:1px solid var(--bd);
      border-radius:16px;
      padding:12px;
      margin: 10px 0 14px 0;
      font-weight:900;
      line-height:1.6;
    }
    .row{ display:flex; justify-content:space-between; gap:12px; }
    .k{ color:var(--mut); font-weight:900; }
    .v{ text-align:right; font-weight:1000; }

    .btn{
      width:100%;
      padding:16px;
      margin:8px 0;
      border:none;
      border-radius:16px;
      font-size:16px;
      font-weight:1000;
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:.8px;
      transition: transform .06s ease, opacity .2s ease, filter .2s ease;
    }
    .btn:active{ transform: scale(.99); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; filter: grayscale(.35); }

    .btn.active{
      outline:3px solid rgba(255,255,255,.9);
      box-shadow:0 0 0 4px rgba(0, 212, 255, .25);
      position:relative;
    }
    .btn.active::after{
      content:"AKTIF";
      position:absolute;
      top:10px; right:12px;
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.35);
    }

    .nav{ display:flex; gap:10px; margin-top:12px; }
    .nav button{
      flex:1;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--bd);
      background: rgba(0,0,0,.55);
      color: var(--txt);
      font-weight:1000;
      cursor:pointer;
    }
    .nav .home{ background:#ff1744; border:none; }
    .nav button[disabled]{ opacity:.55; cursor:not-allowed; }

    .panel{
      background: rgba(0,0,0,.35);
      border:1px solid var(--bd);
      border-radius:16px;
      padding:12px;
      margin-top:12px;
    }
    .mini{ font-size:12px; color:var(--mut); font-weight:800; margin-top:8px; line-height:1.4; }

    .grid2{ display:grid; grid-template-columns: 1fr; gap: 10px; }
    @media(min-width: 560px){ .grid2{ grid-template-columns: 1fr 1fr; } }

    .filters{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .chip{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--bd);
      background: rgba(0,0,0,.55);
      color: var(--txt);
      font-weight: 1000;
      cursor:pointer;
      user-select:none;
      font-size: 13px;
    }
    .chip.active{
      outline: 3px solid rgba(255,255,255,.9);
      box-shadow: 0 0 0 4px rgba(0, 212, 255, .22);
    }

    .toast{
      position:fixed; left:50%; bottom:18px; transform: translateX(-50%);
      background: rgba(0,0,0,.78);
      border:1px solid rgba(255,255,255,.25);
      padding:10px 14px; border-radius:14px;
      font-weight:1000; font-size:13px;
      box-shadow:0 12px 30px rgba(0,0,0,.45);
      opacity:0; pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      max-width:min(560px, 90vw);
      text-align:center;
      z-index:9999;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px); }

    code{ color: #c7f6ff; }
  </style>
</head>

<body>
  <div class="container">

    <!-- HOME -->
    <div class="card active" id="page-home">
      <div class="topbar">
        <div>
          <h1 style="font-size:22px;">Hidrologi Heroes</h1>
          <div class="sub">NISEEF v8 â€¢ Toggle + Viewers + Auto-Off 10m + Log Analitik</div>
        </div>
        <div class="pill" title="Koneksi RTDB">
          <span class="dot" id="connDot"></span>
          <span id="connText">CONNECTING</span>
        </div>
      </div>

      <div class="status">
        <div class="row"><div class="k">Pengunjung Online</div><div class="v" id="ui-viewers">-</div></div>
        <div class="row"><div class="k">Mode</div><div class="v" id="ui-mode-home">-</div></div>
      </div>

      <button class="btn" style="background:linear-gradient(45deg,#007bff,#00c6ff); color:#fff;"
              id="go-diorama">MASUK KONTROL DIORAMA</button>

      <div class="mini">
        Data realtime: <code>/sensor</code>, <code>/debit</code> â€¢ Log analitik: <code>/log/ts/{epochSec}</code>
      </div>

      <div class="nav">
        <button disabled>BACK</button>
        <button class="home" disabled>HOME</button>
        <button id="next-home">NEXT</button>
      </div>
    </div>

    <!-- DIORAMA -->
    <div class="card" id="page-diorama">
      <div class="topbar">
        <div>
          <h2 style="font-size:18px; margin-bottom:4px;">Kontrol Diorama</h2>
          <div class="sub">Tombol toggle (klik sama lagi = OFF)</div>
        </div>
        <div class="pill" title="Viewer realtime">
          ðŸ‘¥ <span id="ui-viewers-2">-</span>
        </div>
      </div>

      <div class="status">
        <div class="row"><div class="k">Mode</div><div class="v" id="ui-mode">-</div></div>
        <div class="row"><div class="k">Jarak (cm)</div><div class="v" id="ui-jarak">-</div></div>
        <div class="row"><div class="k">Level (%)</div><div class="v" id="ui-persen">-</div></div>
        <hr style="opacity:.2">
        <div class="row"><div class="k">Debit (L/min)</div><div class="v" id="ui-flow">-</div></div>
        <div class="row"><div class="k">Total (Liter)</div><div class="v" id="ui-total">-</div></div>
      </div>

      <button class="btn" style="background:#f44336" id="btn-evap">EVAPORASI</button>
      <button class="btn" style="background:#ff9800" id="btn-kond">KONDENSASI</button>
      <button class="btn" style="background:#4caf50" id="btn-pres">PRESIPITASI</button>
      <button class="btn" style="background:#ffffff; color:#001f3f" id="btn-infi">INFILTRASI</button>
      <button class="btn" style="background:#2196f3" id="btn-banj">BANJIR</button>
      <button class="btn" style="background:#333" id="btn-off">MATIKAN SEMUA</button>

      <div class="nav">
        <button id="back-diorama">BACK</button>
        <button class="home" id="home-diorama">HOME</button>
        <button id="next-diorama">NEXT</button>
      </div>
    </div>

    <!-- MONITOR REALTIME -->
    <div class="card" id="page-monitor">
      <div class="topbar">
        <div>
          <h2 style="font-size:18px; margin-bottom:4px;">Monitor Realtime</h2>
          <div class="sub">Grafik debit realtime (30 titik terakhir)</div>
        </div>
        <div class="pill">ðŸ‘¥ <span id="ui-viewers-3">-</span></div>
      </div>

      <div class="panel">
        <canvas id="flowChart" height="190"></canvas>
        <div class="mini">Sumber: <code>/debit/flow_lpm</code></div>
      </div>

      <div class="nav">
        <button id="back-monitor">BACK</button>
        <button class="home" id="home-monitor">HOME</button>
        <button id="next-monitor">NEXT</button>
      </div>
    </div>

    <!-- ANALITIK (HISTORI) -->
    <div class="card" id="page-analytics">
      <div class="topbar">
        <div>
          <h2 style="font-size:18px; margin-bottom:4px;">Analitik Histori</h2>
          <div class="sub">Ambil data dari <code>/log/ts</code> + filter waktu</div>
        </div>
        <div class="pill">ðŸ‘¥ <span id="ui-viewers-4">-</span></div>
      </div>

      <div class="status">
        <div class="row"><div class="k">Range</div><div class="v" id="ui-range">10 menit</div></div>
        <div class="row"><div class="k">Titik Data</div><div class="v" id="ui-points">-</div></div>
        <div class="row"><div class="k">Terakhir</div><div class="v" id="ui-last">-</div></div>
      </div>

      <div class="filters">
        <div class="chip" id="chip-1m">1 menit</div>
        <div class="chip active" id="chip-10m">10 menit</div>
        <div class="chip" id="chip-1h">1 jam</div>
        <div class="chip" id="chip-refresh">Refresh</div>
        <div class="chip" id="chip-export">Export CSV</div>
      </div>

      <div class="grid2">
        <div class="panel">
          <canvas id="histFlowChart" height="190"></canvas>
          <div class="mini">Histori Debit (L/min)</div>
        </div>
        <div class="panel">
          <canvas id="histLevelChart" height="190"></canvas>
          <div class="mini">Histori Level (%)</div>
        </div>
      </div>

      <div class="nav">
        <button id="back-analytics">BACK</button>
        <button class="home" id="home-analytics">HOME</button>
        <button disabled>NEXT</button>
      </div>
    </div>

  </div>

  <div class="toast" id="toast">-</div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import {
      getDatabase, ref, set, onValue, get,
      query, orderByKey, startAt, endAt,
      onDisconnect
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

    // ===== Firebase config (punya Boss) =====
    const firebaseConfig = {
      apiKey: "AIzaSyCbKNlViQO-BRj818y-sNd7LjvMkf6Q0Wg",
      authDomain: "hidrologi-heroes.firebaseapp.com",
      databaseURL: "https://hidrologi-heroes-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "hidrologi-heroes",
      storageBucket: "hidrologi-heroes.firebasestorage.app",
      messagingSenderId: "349578733020",
      appId: "1:349578733020:web:df27bed634e6bdefd5db19",
      measurementId: "G-HMVQ476SYS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ===== Toast =====
    const toastEl = document.getElementById("toast");
    let toastTimer = null;
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toastEl.classList.remove("show"), 1400);
    }

    // ===== Pages + Navigation =====
    const pages = ["page-home","page-diorama","page-monitor","page-analytics"];
    let currentIndex = 0;

    function showPageByIndex(idx){
      currentIndex = Math.max(0, Math.min(pages.length-1, idx));
      pages.forEach(id => document.getElementById(id).classList.remove("active"));
      document.getElementById(pages[currentIndex]).classList.add("active");
      window.scrollTo(0,0);
      bumpActive();
      if (pages[currentIndex] === "page-analytics") loadAnalytics(); // auto load
    }
    function back(){ showPageByIndex(currentIndex - 1); }
    function next(){ showPageByIndex(currentIndex + 1); }
    function home(){ showPageByIndex(0); }

    document.getElementById("go-diorama").onclick = () => showPageByIndex(1);
    document.getElementById("next-home").onclick = () => next();

    document.getElementById("back-diorama").onclick = () => back();
    document.getElementById("home-diorama").onclick = () => home();
    document.getElementById("next-diorama").onclick = () => next();

    document.getElementById("back-monitor").onclick = () => back();
    document.getElementById("home-monitor").onclick = () => home();
    document.getElementById("next-monitor").onclick = () => next();

    document.getElementById("back-analytics").onclick = () => back();
    document.getElementById("home-analytics").onclick = () => home();

    // ===== Connection indicator =====
    const connDot = document.getElementById("connDot");
    const connText = document.getElementById("connText");
    let isConnected = false;

    function setConn(state){
      connDot.classList.remove("ok","bad");
      if(state === "ok"){ connDot.classList.add("ok"); connText.textContent = "ONLINE"; }
      else if(state === "bad"){ connDot.classList.add("bad"); connText.textContent = "OFFLINE"; }
      else { connText.textContent = "CONNECTING"; }
    }
    setConn("warn");

    // ===== Presence / Viewers realtime =====
    const sessionId = (crypto?.randomUUID?.() ?? ("sess_" + Math.random().toString(16).slice(2)));
    const sessionRef = ref(db, `presence/sessions/${sessionId}`);

    function bumpActive(){
      // DETIK (anti overflow) - dipakai ESP32 auto-off 10 menit
      const sec = Math.floor(Date.now() / 1000);
      set(ref(db, "presence/lastActiveSec"), sec);
      set(sessionRef, { ts: sec });
    }

    // heartbeat tiap 20 detik
    setInterval(() => bumpActive(), 20000);

    // hitung viewers
    onValue(ref(db, "presence/sessions"), snap => {
      const obj = snap.val() || {};
      const count = Object.keys(obj).length;
      ["ui-viewers","ui-viewers-2","ui-viewers-3","ui-viewers-4"].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.innerText = count;
      });
    });

    // ===== tombol disable saat offline =====
    const modeButtons = ["btn-evap","btn-kond","btn-pres","btn-infi","btn-banj","btn-off"]
      .map(id => document.getElementById(id));
    function setButtonsEnabled(en){ modeButtons.forEach(b => b.disabled = !en); }

    // ===== Connected state dari RTDB =====
    onValue(ref(db, ".info/connected"), async (snap) => {
      isConnected = !!snap.val();
      if(isConnected){
        setConn("ok");
        setButtonsEnabled(true);

        // register presence + auto-remove saat disconnect
        try{
          await set(sessionRef, { ts: Math.floor(Date.now()/1000) });
          onDisconnect(sessionRef).remove();
          bumpActive();
        }catch(e){
          console.error(e);
          toast("Presence gagal (cek rules)");
        }
      }else{
        setConn("bad");
        setButtonsEnabled(false);
      }
    });

    // ===== Mode toggle logic =====
    const btnMap = {
      evaporasi: document.getElementById("btn-evap"),
      kondensasi: document.getElementById("btn-kond"),
      presipitasi: document.getElementById("btn-pres"),
      infiltrasi: document.getElementById("btn-infi"),
      banjir: document.getElementById("btn-banj"),
      off: document.getElementById("btn-off"),
    };
    function setActiveMode(mode){
      Object.values(btnMap).forEach(b => b.classList.remove("active"));
      if(btnMap[mode]) btnMap[mode].classList.add("active");
    }

    async function toggleMode(target){
      if(!isConnected){ toast("Offline: tidak bisa kirim"); return; }
      bumpActive();

      try{
        const snap = await get(ref(db, "diorama/status"));
        const current = snap.val() ?? "off";
        const nextMode = (current === target) ? "off" : target;
        await set(ref(db, "diorama/status"), nextMode);
        toast(`Mode: ${String(nextMode).toUpperCase()}`);
      }catch(e){
        console.error(e);
        toast("Gagal kirim (cek rules)");
      }
    }

    document.getElementById("btn-evap").onclick = () => toggleMode("evaporasi");
    document.getElementById("btn-kond").onclick = () => toggleMode("kondensasi");
    document.getElementById("btn-pres").onclick = () => toggleMode("presipitasi");
    document.getElementById("btn-infi").onclick = () => toggleMode("infiltrasi");
    document.getElementById("btn-banj").onclick = () => toggleMode("banjir");
    document.getElementById("btn-off").onclick  = () => toggleMode("off");

    // ===== Realtime read (UI) =====
    onValue(ref(db, "diorama/status"), snap => {
      const mode = snap.val() ?? "-";
      document.getElementById("ui-mode").innerText = mode;
      document.getElementById("ui-mode-home").innerText = mode;
      if(mode !== "-") setActiveMode(mode);
    });

    onValue(ref(db, "sensor/jarak"), snap => {
      const v = snap.val();
      document.getElementById("ui-jarak").innerText = (v == null) ? "-" : Number(v).toFixed(1);
    });

    onValue(ref(db, "sensor/persen"), snap => {
      const v = snap.val();
      document.getElementById("ui-persen").innerText = (v == null) ? "-" : Math.round(Number(v));
    });

    onValue(ref(db, "debit/flow_lpm"), snap => {
      const v = snap.val();
      const flow = (v == null) ? null : Number(v);
      document.getElementById("ui-flow").innerText = (flow == null) ? "-" : flow.toFixed(3);
      if(flow != null) pushRealtimeFlow(flow);
    });

    onValue(ref(db, "debit/total_liter"), snap => {
      const v = snap.val();
      document.getElementById("ui-total").innerText = (v == null) ? "-" : Number(v).toFixed(3);
    });

    // ===== Realtime Chart (30 points) =====
    const rtLabels = [];
    const rtData = [];
    const rtCtx = document.getElementById("flowChart").getContext("2d");
    const rtChart = new Chart(rtCtx, {
      type: "line",
      data: { labels: rtLabels, datasets: [{ label: "Debit (L/min)", data: rtData, tension: 0.25 }] },
      options: { responsive:true, animation:false, scales:{ y:{ beginAtZero:true } } }
    });

    function pushRealtimeFlow(flow){
      const label = new Date().toLocaleTimeString("id-ID",{hour12:false});
      rtLabels.push(label);
      rtData.push(flow);
      if(rtLabels.length > 30){ rtLabels.shift(); rtData.shift(); }
      rtChart.update();
    }

    // ===== ANALYTICS (History from /log/ts) =====
    let rangeSec = 10 * 60; // default 10 menit
    let lastAnalyticsRows = []; // keep for export

    const uiRange = document.getElementById("ui-range");
    const uiPoints = document.getElementById("ui-points");
    const uiLast = document.getElementById("ui-last");

    function setChipActive(which){
      ["chip-1m","chip-10m","chip-1h"].forEach(id => document.getElementById(id).classList.remove("active"));
      document.getElementById(which).classList.add("active");
    }

    document.getElementById("chip-1m").onclick = () => { rangeSec = 60; uiRange.innerText="1 menit"; setChipActive("chip-1m"); loadAnalytics(true); };
    document.getElementById("chip-10m").onclick = () => { rangeSec = 600; uiRange.innerText="10 menit"; setChipActive("chip-10m"); loadAnalytics(true); };
    document.getElementById("chip-1h").onclick = () => { rangeSec = 3600; uiRange.innerText="1 jam"; setChipActive("chip-1h"); loadAnalytics(true); };
    document.getElementById("chip-refresh").onclick = () => loadAnalytics(true);
    document.getElementById("chip-export").onclick = () => exportCSV();

    // charts for history
    const histFlowLabels = [];
    const histFlowData = [];
    const histLevelLabels = [];
    const histLevelData = [];

    const hfCtx = document.getElementById("histFlowChart").getContext("2d");
    const hlCtx = document.getElementById("histLevelChart").getContext("2d");

    const histFlowChart = new Chart(hfCtx, {
      type: "line",
      data: { labels: histFlowLabels, datasets: [{ label: "Flow (L/min)", data: histFlowData, tension: 0.25 }] },
      options: { responsive:true, animation:false, scales:{ y:{ beginAtZero:true } } }
    });

    const histLevelChart = new Chart(hlCtx, {
      type: "line",
      data: { labels: histLevelLabels, datasets: [{ label: "Level (%)", data: histLevelData, tension: 0.25 }] },
      options: { responsive:true, animation:false, scales:{ y:{ beginAtZero:true, max: 100 } } }
    });

    function clearArr(a){ a.splice(0, a.length); }

    function epochToLabel(sec){
      // label jam:menit:detik
      const d = new Date(sec * 1000);
      return d.toLocaleTimeString("id-ID",{hour12:false});
    }

    async function loadAnalytics(showToast=false){
      if(!isConnected){
        uiPoints.innerText = "-";
        uiLast.innerText = "-";
        if(showToast) toast("Offline: tidak bisa ambil histori");
        return;
      }

      bumpActive();

      const nowSec = Math.floor(Date.now()/1000);
      const startSec = nowSec - rangeSec;

      // query /log/ts keys are epochSec (string)
      const q = query(
        ref(db, "log/ts"),
        orderByKey(),
        startAt(String(startSec)),
        endAt(String(nowSec))
      );

      try{
        const snap = await get(q);
        const obj = snap.val() || {};

        // convert to sorted rows
        const keys = Object.keys(obj).sort((a,b)=>Number(a)-Number(b));
        const rows = keys.map(k => {
          const v = obj[k] || {};
          return {
            ts: Number(k),
            flow: Number(v.flow ?? 0),
            total: Number(v.total ?? 0),
            pct: Number(v.pct ?? 0),
            cm: Number(v.cm ?? 0)
          };
        });

        lastAnalyticsRows = rows;

        // update UI
        uiPoints.innerText = rows.length;
        if(rows.length){
          uiLast.innerText = epochToLabel(rows[rows.length-1].ts);
        }else{
          uiLast.innerText = "-";
        }

        // fill charts
        clearArr(histFlowLabels); clearArr(histFlowData);
        clearArr(histLevelLabels); clearArr(histLevelData);

        rows.forEach(r=>{
          const lab = epochToLabel(r.ts);
          histFlowLabels.push(lab);
          histFlowData.push(r.flow);

          histLevelLabels.push(lab);
          histLevelData.push(r.pct);
        });

        histFlowChart.update();
        histLevelChart.update();

        if(showToast) toast("Histori ter-update");
      }catch(e){
        console.error(e);
        if(showToast) toast("Gagal ambil histori (cek rules)");
      }
    }

    function exportCSV(){
      if(!lastAnalyticsRows.length){
        toast("Data histori kosong");
        return;
      }
      // build CSV
      const header = ["ts_epoch","time","flow_lpm","total_liter","level_pct","jarak_cm"];
      const lines = [header.join(",")];

      lastAnalyticsRows.forEach(r=>{
        const timeStr = new Date(r.ts*1000).toISOString();
        lines.push([r.ts, timeStr, r.flow, r.total, r.pct, r.cm].join(","));
      });

      const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `niseef_log_${rangeSec}s.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("CSV diunduh");
    }

    // ===== Initial bump =====
    bumpActive();
  </script>
</body>
</html>
